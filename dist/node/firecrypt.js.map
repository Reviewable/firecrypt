{"version":3,"file":"firecrypt.js","sources":["src/utils.js","src/FireCryptOnDisconnect.js","src/FireCryptReference.js","src/FireCryptSnapshot.js","src/FireCryptQuery.js","src/firecrypt.js"],"sourcesContent":["let _spec;\nlet _encryptionCache;\nlet _decryptionCache;\n\nexport function setSpec(spec) {\n  _spec = cleanSpecification(spec);\n};\n\nexport function setEncryptionCache(cache) {\n  _encryptionCache = cache;\n};\n\nexport function setDecryptionCache(cache) {\n  _decryptionCache = cache;\n};\n\nexport function cleanSpecification(def, path) {\n  var keys = Object.keys(def);\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    if (key === '.encrypt') {\n      var encryptKeys = Object.keys(def[key]);\n      for (var j = 0; j < encryptKeys.length; j++) {\n        var encryptKey = encryptKeys[j];\n        if (encryptKey !== 'key' && encryptKey !== 'value' && encryptKey !== 'few') {\n          throw new Error('Illegal .encrypt subkey: ' + encryptKeys[j]);\n        }\n      }\n    } else {\n      if (/[\\x00-\\x1f\\x7f\\x91\\x92\\.#\\[\\]/]/.test(key) || /[$]/.test(key.slice(1))) {\n        throw new Error('Illegal character in specification key: ' + key);\n      }\n      cleanSpecification(def[key], (path || '') + '/' + key);\n    }\n    switch (key.charAt(0)) {\n      case '$':\n        if (key === '$') break;\n        if (def.$) throw new Error('Multiple wildcard keys in specification at ' + path);\n        def.$ = def[key];\n        delete def[key];\n        break;\n      case '.':\n        if (key !== '.encrypt') throw new Error('Unknown directive at ' + path + ': ' + key);\n        break;\n    }\n  }\n  return def;\n};\n\nexport function throwNotSetUpError() {\n  var e = new Error('Encryption not set up');\n  e.firecrypt = 'NO_KEY';\n  throw e;\n};\n\nexport function computeCacheItemSize(value, key) {\n  return key.length + (typeof value === 'string' ? value.length : 4);\n};\n\nexport function encryptPath(path, def) {\n  def = def || _spec.rules;\n  path = path.slice();\n  for (var i = 0; i < path.length; i++) {\n    def = def[path[i]] || def.$;\n    if (!def) break;\n    if (def['.encrypt'] && def['.encrypt'].key) {\n      path[i] = encrypt(path[i], 'string', def['.encrypt'].key);\n    }\n  }\n  return path;\n};\n\nexport function encryptRef(ref, path) {\n  var encryptedPath = encryptPath(path || refToPath(ref));\n  return encryptedPath.length ? ref.root.child(encryptedPath.join('/')) : ref.root;\n};\n\nexport function decryptRef(ref) {\n  var path = refToPath(ref, true);\n  var changed = false;\n  for (var i = 0; i < path.length; i++) {\n    var decryptedPathSegment = decrypt(path[i]);\n    if (decryptedPathSegment !== path[i]) {\n      path[i] = decryptedPathSegment;\n      changed = true;\n    }\n  }\n  return changed ? ref.root.child(path.join('/')) : ref;\n};\n\nexport function specForPath(path, def) {\n  def = def || _spec.rules;\n  for (var i = 0; def && i < path.length; i++) {\n    def = def[path[i]] || def.$;\n  }\n  return def;\n};\n\nexport function transformValue(path, value, transform) {\n  return transformTree(value, specForPath(path), transform);\n};\n\nexport function transformTree(value, def, transform) {\n  if (!def) return value;\n  var type = getType(value);\n  var i;\n  if (/^(string|number|boolean)$/.test(type)) {\n    if (def['.encrypt'] && def['.encrypt'].value) {\n      value = transform(value, type, def['.encrypt'].value);\n    }\n  } else if (type === 'object' && value !== null) {\n    var transformedValue = {};\n    for (var key in value) {\n      if (!value.hasOwnProperty(key)) continue;\n      var subValue = value[key], subDef;\n      if (key.indexOf('/') >= 0) {  // for deep update keys\n        var keyParts = key.split('/');\n        subDef = def;\n        for (i = 0; i < keyParts.length; i++) {\n          if (transform === decrypt) {\n            keyParts[i] = decrypt(keyParts[i]);\n            subDef = subDef && (subDef[keyParts[i]] || subDef.$);\n          } else {\n            subDef = subDef && (subDef[keyParts[i]] || subDef.$);\n            if (subDef && subDef['.encrypt'] && subDef['.encrypt'].key) {\n              keyParts[i] = transform(keyParts[i], 'string', subDef['.encrypt'].key);\n            }\n          }\n        }\n        key = keyParts.join('/');\n      } else {\n        if (transform === decrypt) {\n          key = decrypt(key);\n          subDef = def[key] || def.$;\n        } else {\n          subDef = def[key] || def.$;\n          if (subDef && subDef['.encrypt'] && subDef['.encrypt'].key) {\n            key = transform(key, 'string', subDef['.encrypt'].key);\n          }\n        }\n      }\n      transformedValue[key] = transformTree(subValue, subDef, transform);\n    }\n    value = transformedValue;\n  } else if (type === 'array') {\n    if (!def.$) return value;\n    for (i = 0; i < value.length; i++) value[i] = transformTree(value[i], def.$, transform);\n  }\n  return value;\n};\n\nexport function refToPath(ref, encrypted) {\n  var root = ref.root;\n  if (ref === root) return [];\n  var pathStr = decodeURIComponent(ref.toString().slice(root.toString().length));\n  if (!encrypted && pathStr && pathStr.charAt(0) !== '.' &&\n      /[\\x00-\\x1f\\x7f\\x91\\x92\\.#$\\[\\]]/.test(pathStr)) {\n    throw new Error('Path contains invalid characters: ' + pathStr);\n  }\n  return pathStr.split('/');\n};\n\nexport function encrypt(value, type, pattern) {\n  var cacheKey;\n  if (_encryptionCache) {\n    cacheKey = type.charAt(0) + pattern + '\\x91' + value;\n    if (_encryptionCache.has(cacheKey)) return _encryptionCache.get(cacheKey);\n  }\n  var result;\n  if (pattern === '#') {\n    result = encryptValue(value, type);\n  } else {\n    if (type !== 'string') {\n      throw new Error('Can\\'t encrypt a ' + type + ' using pattern [' + pattern + ']');\n    }\n    var match = value.match(compilePattern(pattern));\n    if (!match) {\n      throw new Error(\n        'Can\\'t encrypt as value doesn\\'t match pattern [' + pattern + ']: ' + value);\n    }\n    var i = 0;\n    result = pattern.replace(/[#\\.]/g, function(placeholder) {\n      var part = match[++i];\n      if (placeholder === '#') part = encryptValue(part, 'string');\n      return part;\n    });\n  }\n  if (_encryptionCache) _encryptionCache.set(cacheKey, result);\n  return result;\n};\n\nexport function encryptValue(value, type) {\n  if (!/^(string|number|boolean)$/.test(type)) throw new Error('Can\\'t encrypt a ' + type);\n  switch (type) {\n    case 'number': value = '' + value; break;\n    case 'boolean': value = value ? 't' : 'f'; break;\n  }\n  return '\\x91' + type.charAt(0).toUpperCase() + encryptString(value) + '\\x92';\n};\n\nexport function decrypt(value) {\n  if (_decryptionCache && _decryptionCache.has(value)) return _decryptionCache.get(value);\n  if (!/\\x91/.test(value)) return value;\n  var result;\n  var match = value.match(/^\\x91(.)([^\\x92]*)\\x92$/);\n  if (match) {\n    var decryptedString = decryptString(match[2]);\n    switch (match[1]) {\n      case 'S':\n        result = decryptedString;\n        break;\n      case 'N':\n        result = Number(decryptedString);\n        // Check for NaN, since it's the only value where x !== x.\n        if (result !== result) throw new Error('Invalid encrypted number: ' + decryptedString);\n        break;\n      case 'B':\n        if (decryptedString === 't') result = true;\n        else if (decryptedString === 'f') result = false;\n        else throw new Error('Invalid encrypted boolean: ' + decryptedString);\n        break;\n      default:\n        throw new Error('Invalid encrypted value type code: ' + match[1]);\n    }\n  } else {\n    result = value.replace(/\\x91(.)([^\\x92]*)\\x92/g, function(match, typeCode, encryptedString) {\n      if (typeCode !== 'S') throw new Error('Invalid multi-segment encrypted value: ' + typeCode);\n      return decryptString(encryptedString);\n    });\n  }\n  if (_decryptionCache) _decryptionCache.set(value, result);\n  return result;\n};\n\nexport function getType(value) {\n  if (Array.isArray(value)) return 'array';\n  var type = typeof value;\n  if (type === 'object') {\n    if (value instanceof String) type = 'string';\n    else if (value instanceof Number) type = 'number';\n    else if (value instanceof Boolean) type = 'boolean';\n  }\n  return type;\n};\n\nvar patternRegexes = {};\nexport function compilePattern(pattern) {\n  var regex = patternRegexes[pattern];\n  if (!regex) {\n    regex = patternRegexes[pattern] = new RegExp('^' + pattern\n      .replace(/\\./g, '#')\n      .replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, '\\\\$&')  // escape regex chars\n      .replace(/#/g, '(.*?)') + '$');\n  }\n  return regex;\n};\n","import * as utils from './utils';\n\nexport default class FireCryptOnDisconnect {\n  constructor(path, originalOnDisconnect) {\n    this._path = path;\n    this._originalOnDisconnect = originalOnDisconnect;\n\n    this._interceptOnDisconnectWrite('set', 0);\n    this._interceptOnDisconnectWrite('update', 0);\n    this._interceptOnDisconnectWrite('remove');\n    this._interceptOnDisconnectWrite('setWithPriority', 0);\n    this._interceptOnDisconnectWrite('cancel');\n  }\n\n  _interceptOnDisconnectWrite(methodName, argIndex) {\n    this[methodName] = function() {\n      const args = Array.prototype.slice.call(arguments);\n      if (argIndex >= 0 && argIndex < args.length) {\n        args[argIndex] = utils.transformValue(this._path, args[argIndex], utils.encrypt);\n      }\n\n      return this._originalOnDisconnect[methodName].apply(this._originalOnDisconnect, args);\n    };\n  }\n}\n","import * as utils from './utils';\nimport FireCryptQuery from './FireCryptQuery';\nimport FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptOnDisconnect from './FireCryptOnDisconnect';\n\nexport default class FireCryptReference {\n  constructor(ref) {\n    this._ref = ref;\n\n    this.get = ref.get;\n    this.remove = ref.remove;\n\n    this._interceptPush();\n    this._interceptTransaction();\n    this._interceptOnDisconnect();\n\n    [\n      'on', 'off', 'once', 'orderByChild', 'orderByKey', 'orderByValue', 'startAt', 'endAt',\n      'equalTo', 'limitToFirst', 'limitToLast'\n    ].forEach((methodName) => {this._interceptQuery(methodName);});\n\n    this.set = this._interceptWrite(ref, 'set', 0);\n    this.update = this._interceptWrite(ref, 'update', 0);\n    this.setPriority = this._interceptWrite(ref, 'setPriority');\n    this.setWithPriority = this._interceptWrite(ref, 'setWithPriority', 0);\n\n    if (ref.childrenKeys) {\n      this.childrenKeys = this._interceptChildrenKeys(ref);\n    }\n  }\n\n  /**\n   * Returns a placeholder value for auto-populating the current timestamp (time since the Unix\n   * epoch, in milliseconds) as determined by the Firebase servers.\n   * @return {Object} A timestamp placeholder value.\n   */\n  static get SERVER_TIMESTAMP() {\n    return {\n      '.sv': 'timestamp'\n    };\n  }\n\n  /**\n   * Returns the last part of this reference's path. The key of a root reference is `null`.\n   * @return {string|null} The last part this reference's path.\n   */\n  get key() {\n    console.log('GETTING KEY:', this._ref.key);\n    return this._ref.key;\n  }\n\n  /**\n   * Returns just the path component of the reference's URL.\n   * @return {string} The path component of the Firebase URL wrapped by this reference.\n   */\n  get path() {\n    return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length - 1);\n  }\n\n  /**\n   * Returns a FireCryptReference at the same location as this query or reference.\n   * @return {FireCryptReference|null} A FireCryptReference at the same location as this query or\n   *     reference.\n   */\n  get ref() {\n    if (this._ref.isEqual(this._ref.ref)) {\n      return this;\n    } else {\n      return new FireCryptReference(this._ref.ref);\n    }\n  }\n\n  /**\n   * Returns a FireCryptReference reference to the root of the database.\n   * @return {FireCryptReference} The root reference of the database.\n   */\n  get root() {\n    if (this._ref.isEqual(this._ref.root)) {\n      return this;\n    } else {\n      return new FireCryptReference(this._ref.root);\n    }\n  }\n\n  /**\n   * Returns a FireCryptReference to the parent location of this reference. The parent of a root\n   * reference is `null`.\n   * @return {FireCryptReference|null} The parent location of this reference.\n   */\n  get parent() {\n    if (this._ref.parent === null) {\n      return null;\n    } else {\n      return new FireCryptReference(this._ref.parent);\n    }\n  }\n\n  /**\n   * Creates a new FireCryptReference object on a child of this one.\n   * @param  {string} path The path to the desired child, relative to this reference.\n   * @return {FireCryptReference} The child reference.\n   */\n  child(path) {\n    return new FireCryptReference(this._ref.child(path));\n  }\n\n  /**\n   * Returns a JSON-serializable representation of this object.\n   * @return {Object} A JSON-serializable representation of this object.\n   */\n  toJSON() {\n    return this._ref.toJSON();\n  }\n\n  /**\n   * Returns whether or not this FireCryptReference is equivalent to the provided FireCryptReference.\n   * @return {FireCryptReference} Another FireCryptReference instance against which to compare.\n   */\n  isEqual(otherRef) {\n    return this._ref.isEqual(otherRef._ref);\n  }\n\n  /**\n   * Stringifies the wrapped reference.\n   * @return {string} The Firebase URL wrapped by this FireCryptReference object.\n   */\n  toString() {\n    return decodeURIComponent(this._ref.toString());\n  }\n\n  _interceptPush() {\n    this.push = () => {\n      // push() delegates to set(), which will take care of encrypting the ref and the argument.\n      const pushedRef = this._ref.push.apply(this._ref, arguments);\n      const decryptedRef = utils.decryptRef(pushedRef);\n      decryptedRef.then = pushedRef.then;\n      decryptedRef.catch = pushedRef.catch;\n      if (pushedRef.finally) decryptedRef.finally = pushedRef.finally;\n      // TODO: do I need to pass to constructor here?\n      // return new FireCryptReference(decryptedRef);\n      return decryptedRef;\n    };\n  }\n  \n  _interceptWrite(methodName, argIndex) {\n    this[methodName] = () => {\n      const encryptedRef = utils.encryptRef(this._ref);\n  \n      const args = Array.prototype.slice.call(arguments);\n      if (argIndex >= 0 && argIndex < args.length) {\n        args[argIndex] = utils.transformValue(utils.refToPath(path), args[argIndex], encrypt);\n      }\n  \n      return this._ref[methodName].apply(encryptedRef, args);\n    };\n  }\n  \n  _interceptChildrenKeys() {\n    this.childrenKeys = () => {\n      const encryptedRef = utils.encryptRef(this._ref);\n      return this._ref.childrenKeys.apply(encryptedRef, arguments).then((keys) => {\n        if (!keys.some((key) => /\\x91/.test(key))) {\n          return keys;\n        }\n        return keys.map(utils.decrypt);\n      });\n    };\n  }\n\n  _interceptOnDisconnect() {\n    this.onDisconnect = () => {\n      const encryptedRef = utils.encryptRef(this._ref);\n      return new FireCryptOnDisconnect(encryptedRef, this._ref.onDisconnect.call(encryptedRef));\n    };\n  }\n  \n  _interceptQuery(methodName) {\n    this[methodName] = () => {\n      const encryptedRef = utils.encryptRef(this._ref);\n      var query = new FireCryptQuery(encryptedRef, {}, this._ref);\n      return query[methodName].apply(query, arguments);\n    }\n  }\n\n  _interceptTransaction() {\n    this.transaction = () => {\n      var encryptedRef = utils.encryptRef(this._ref);\n      var args = Array.prototype.slice.call(arguments);\n      var originalCompute = args[0];\n      args[0] = originalCompute && function(value) {\n        value = utils.transformValue(path, value, utils.decrypt);\n        value = originalCompute(value);\n        value = utils.transformValue(path, value, utils.encrypt);\n        return value;\n      };\n      if (args.length > 1) {\n        var originalOnComplete = args[1];\n        args[1] = originalOnComplete && function(error, committed, snapshot) {\n          return originalOnComplete(error, committed, snapshot && new FireCryptSnapshot(snapshot));\n        };\n      }\n      return this._ref.transaction.apply(encryptedRef, args).then(function(result) {\n        result.snapshot = result.snapshot && new FireCryptSnapshot(result.snapshot);\n        return result;\n      });\n    };\n  }\n}\n","import * as utils from './utils';\nimport FireCryptReference from './FireCryptReference';\n\nexport default class FireCryptSnapshot {\n  constructor(snap) {\n    this._ref = utils.decryptRef(snap.ref);\n    this._path = utils.refToPath(this._ref);\n    this._snap = snap;\n\n    this._delegateSnapshot('exists');\n    this._delegateSnapshot('toJSON');\n    this._delegateSnapshot('hasChildren');\n    this._delegateSnapshot('numChildren');\n    this._delegateSnapshot('getPriority');\n  }\n\n  _delegateSnapshot(methodName) {\n    this[methodName] = function() {\n      return this._snap[methodName].apply(this._snap, arguments);\n    };\n  }\n\n  get key() {\n    console.log('getting snapshot key');\n    return this._ref.key;\n  }\n\n  get ref() {\n    return new FireCryptReference(this._ref.ref);\n  }\n\n  val() {\n    return utils.transformValue(this._path, this._snap.val(), utils.decrypt);\n  }\n\n  child(childPath) {\n    return new FireCryptSnapshot(this._snap.child(childPath));\n  }\n\n  forEach(action) {\n    return this._snap.forEach(function(childSnap) {\n      return action(new FireCryptSnapshot(childSnap));\n    });\n  }\n\n  hasChild(childPath) {\n    childPath = utils.encryptPath(childPath.split('/'), utils.specForPath(this._path)).join('/');\n    return this._snap.hasChild(childPath);\n  }\n\n  exportVal() {\n    return utils.transformValue(this._path, this._snap.exportVal(), utils.decrypt);\n  }\n}\n","import * as utils from './utils';\nimport FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptReference from './FireCryptReference';\n\nexport default class FireCryptQuery {\n  constructor(query, order, originalRef) {\n    this._query = query;\n    this._order = order || {};\n    this._originalRef = originalRef || query;\n  }\n\n  get ref() {\n    // TODO: do I need to pass this to FireCryptReference constructor? If so, why am I getting that error?\n    // return new FireCryptReference(utils.decryptRef(this._query.ref));\n    return utils.decryptRef(this._query.ref);\n  }\n  \n  on(eventType, callback, cancelCallback, context) {\n    wrapQueryCallback(callback);\n    return this._originalRef.on.call(\n      this._query, eventType, callback.firecryptCallback, cancelCallback, context);\n  }\n\n  off(eventType, callback, context) {\n    if (callback && callback.firecryptCallback) callback = callback.firecryptCallback;\n    return this._originalRef.off.call(this._query, eventType, callback, context);\n  }\n\n  once(eventType, successCallback, failureCallback, context) {\n    wrapQueryCallback(successCallback);\n    return this._originalRef.once.call(\n      this._query, eventType, successCallback && successCallback.firecryptCallback, failureCallback,\n      context\n    ).then((snap) => {\n      return new FireCryptSnapshot(snap);\n    });\n  }\n  \n  orderByChild(key) {\n    return this._orderBy('orderByChild', 'child', key);\n  }\n\n  orderByKey() {\n    return this._orderBy('orderByKey', 'key');\n  }\n\n  orderByValue() {\n    return this._orderBy('orderByValue', 'value');\n  }\n\n  orderByPriority() {\n    return this._orderBy('orderByPriority', 'priority');\n  }\n\n  startAt(value, key) {\n    this._checkCanSort(key !== undefined);\n    return this._delegate('startAt', arguments);\n  }\n\n  endAt(value, key) {\n    this._checkCanSort(key !== undefined);\n    return this._delegate('endAt', arguments);\n  }\n\n  equalTo(value, key) {\n    if (this._order[this._order.by + 'Encrypted']) {\n      value = utils.encrypt(value, getType(value), this._order[this._order.by + 'Encrypted']);\n    }\n    if (key !== undefined && this._order.keyEncrypted) {\n      key = utils.encrypt(key, 'string', this._order.keyEncrypted);\n    }\n    return new FireCryptQuery(this._originalRef.equalTo.call(this._query, value, key), this._order);\n  }\n\n  limitToFirst() {\n    return this._delegate('limitToFirst', arguments);\n  }\n\n  limitToLast() {\n    return this._delegate('limitToLast', arguments);\n  }\n\n  limit() {\n    return this._delegate('limit', arguments);\n  }\n\n  _delegate(methodName, args) {\n    return new FireCryptQuery(this._originalRef[methodName].apply(this._query, args), this._order);\n  }\n\n  _checkCanSort(hasExtraKey) {\n    if (this._order.by === 'key' ?\n        this._order.keyEncrypted :\n        this._order.valueEncrypted || hasExtraKey && this._order.keyEncrypted) {\n      throw new Error('Encrypted items cannot be ordered');\n    }\n  }\n\n  _orderBy(methodName, by, childKey) {\n    var def = utils.specForPath(utils.refToPath(this.ref));\n    var order = {by: by}\n\n    var encryptedChildKey;\n    if (def) {\n      var childPath = childKey && childKey.split('/');\n      for (var subKey in def) {\n        if (!def.hasOwnProperty(subKey)) continue;\n        var subDef = def[subKey];\n        if (subDef['.encrypt']) {\n          if (subDef['.encrypt'].key) order.keyEncrypted = subDef['.encrypt'].key;\n          if (subDef['.encrypt'].value) order.valueEncrypted = subDef['.encrypt'].value;\n        }\n        if (childKey) {\n          var childDef = utils.specForPath(childPath, subDef);\n          if (childDef && childDef['.encrypt'] && childDef['.encrypt'].value) {\n            order.childEncrypted = childDef['.encrypt'].value;\n          }\n          var encryptedChildKeyCandidate = utils.encryptPath(childPath, subDef).join('/');\n          if (encryptedChildKey && encryptedChildKeyCandidate !== encryptedChildKey) {\n            throw new Error(\n              'Incompatible encryption specifications for orderByChild(\"' + childKey + '\")');\n          }\n          encryptedChildKey = encryptedChildKeyCandidate;\n        }\n      }\n    }\n    if (childKey) {\n      return new FireCryptQuery(\n        this._originalRef[methodName].call(this._query, encryptedChildKey || childKey), order);\n    } else {\n      return new FireCryptQuery(this._originalRef[methodName].call(this._query), order);\n    }\n  }\n}\n\nfunction wrapQueryCallback(callback) {\n  if (!callback || callback.firecryptCallback) return;\n  var wrappedCallback = function(snap, previousChildKey) {\n    return callback.call(this, new FireCryptSnapshot(snap), previousChildKey);\n  };\n  wrappedCallback.firecryptCallback = wrappedCallback;\n  callback.firecryptCallback = wrappedCallback;\n}\n","if (typeof require !== 'undefined') {\n  if (typeof Firebase === 'undefined') global.Firebase = require('firebase');\n  if (typeof LRUCache === 'undefined') global.LRUCache = require('lru-cache');\n  if (typeof CryptoJS === 'undefined') global.CryptoJS = require('crypto-js/core');\n  require('crypto-js/enc-base64');\n  require('cryptojs-extension/build_node/siv');\n  try {\n    require('firebase-childrenkeys');\n  } catch (e) {\n    // ignore, not installed\n  }\n}\n\nCryptoJS.enc.Base64UrlSafe = {\n  stringify: CryptoJS.enc.Base64.stringify,\n  parse: CryptoJS.enc.Base64.parse,\n  _map: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_'\n};\n\nimport * as utils from './utils';\nimport FireCryptQuery from './FireCryptQuery';\nimport FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptReference from './FireCryptReference';\nimport FireCryptOnDisconnect from './FireCryptOnDisconnect';\n\nlet encryptString;\nlet decryptString;\n\nexport default class FireCrypt {\n  constructor(db, options = {}, specification = {}) {\n    const dbIsNonNullObject = (typeof db === 'object' && db !== null);\n    if (!dbIsNonNullObject || typeof db.app !== 'object' || typeof db.ref !== 'function') {\n      throw new Error(\n        `Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got \"${db}\".`\n      );\n    } else if (typeof options !== 'object' || options === null) {\n      throw new Error(\n        `Expected second argument passed to FireCrypt constructor to be an object, but got \"${options}\".`\n      );\n    } else if (typeof specification !== 'object' || specification === null) {\n      throw new Error(\n        `Expected third argument passed to FireCrypt constructor to be an object, but got \"${specification}\".`\n      );\n    }\n\n    this._db = db;\n\n    options.cacheSize = options.cacheSize || 5 * 1000 * 1000;\n    options.encryptionCacheSize = options.encryptionCacheSize || options.cacheSize;\n    options.decryptionCacheSize = options.decryptionCacheSize || options.cacheSize;\n    encryptString = decryptString = utils.throwNotSetUpError;\n    \n    if (typeof LRUCache === 'function') {\n      utils.setEncryptionCache(new LRUCache({\n        max: options.encryptionCacheSize, length: utils.computeCacheItemSize\n      }));\n      utils.setDecryptionCache(new LRUCache({\n        max: options.decryptionCacheSize, length: utils.computeCacheItemSize\n      }));\n    }\n\n    switch (options.algorithm) {\n      case 'aes-siv':\n        if (!options.key) throw new Error('You must specify a key to use AES encryption.');\n        // TODO: update things that use this\n        this.encryptionKeyCheckValue = setupAesSiv(options.key, options.keyCheckValue);\n        break;\n      case 'passthrough':\n        encryptString = decryptString = (str) => str;\n        break;\n      case 'none':\n        break;\n      default:\n        throw new Error('Unknown encryption algorithm \"' + options.algorithm + '\".');\n    }\n\n    utils.setSpec(specification);\n\n    return this;\n  }\n\n  get app() {\n    return this._db.app;\n  }\n\n  goOnline() {\n    return this._db.goOnline();\n  }\n\n  goOffline() {\n    return this._db.goOffline();\n  }\n\n  ref(pathOrRef) {\n    // TODO: validate pathOrRef\n\n    return new FireCryptReference(this._db.ref(pathOrRef));\n  }\n}\n\nfunction setupAesSiv(key, checkValue) {\n  var siv = CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(key));\n  encryptString = function(str) {\n    return CryptoJS.enc.Base64UrlSafe.stringify(siv.encrypt(str));\n  };\n  decryptString = function(str) {\n    var result = siv.decrypt(CryptoJS.enc.Base64UrlSafe.parse(str));\n    if (result === false) {\n      var e = new Error('Wrong decryption key');\n      e.firecrypt = 'WRONG_KEY';\n      throw e;\n    }\n    return CryptoJS.enc.Utf8.stringify(result);\n  };\n  if (checkValue) decryptString(checkValue);\n  return encryptString(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)));\n}\n"],"names":["_spec","_encryptionCache","_decryptionCache","setSpec","spec","cleanSpecification","setEncryptionCache","cache","setDecryptionCache","def","path","keys","Object","i","length","key","encryptKeys","j","encryptKey","Error","test","slice","charAt","$","throwNotSetUpError","e","firecrypt","computeCacheItemSize","value","encryptPath","rules","encrypt","encryptRef","ref","encryptedPath","refToPath","root","child","join","decryptRef","changed","decryptedPathSegment","decrypt","specForPath","transformValue","transform","transformTree","type","getType","transformedValue","hasOwnProperty","subValue","subDef","indexOf","keyParts","split","encrypted","pathStr","decodeURIComponent","toString","pattern","cacheKey","has","get","result","encryptValue","match","compilePattern","replace","placeholder","part","set","toUpperCase","encryptString","decryptedString","decryptString","Number","typeCode","encryptedString","Array","isArray","String","Boolean","patternRegexes","regex","RegExp","FireCryptOnDisconnect","originalOnDisconnect","_path","_originalOnDisconnect","_interceptOnDisconnectWrite","methodName","argIndex","args","prototype","call","arguments","utils","apply","FireCryptReference","_ref","remove","_interceptPush","_interceptTransaction","_interceptOnDisconnect","forEach","_interceptQuery","_interceptWrite","update","setPriority","setWithPriority","childrenKeys","_interceptChildrenKeys","SERVER_TIMESTAMP","log","isEqual","parent","toJSON","otherRef","push","pushedRef","decryptedRef","then","catch","finally","encryptedRef","some","map","onDisconnect","query","FireCryptQuery","transaction","originalCompute","originalOnComplete","error","committed","snapshot","FireCryptSnapshot","snap","_snap","_delegateSnapshot","val","childPath","action","childSnap","hasChild","exportVal","order","originalRef","_query","_order","_originalRef","eventType","callback","cancelCallback","context","on","firecryptCallback","off","successCallback","failureCallback","once","_orderBy","_checkCanSort","undefined","_delegate","by","keyEncrypted","equalTo","hasExtraKey","valueEncrypted","childKey","encryptedChildKey","subKey","childDef","childEncrypted","encryptedChildKeyCandidate","wrapQueryCallback","wrappedCallback","previousChildKey","require","Firebase","global","LRUCache","CryptoJS","enc","Base64UrlSafe","Base64","stringify","parse","FireCrypt","db","options","specification","dbIsNonNullObject","app","_db","cacheSize","encryptionCacheSize","decryptionCacheSize","algorithm","encryptionKeyCheckValue","setupAesSiv","keyCheckValue","str","goOnline","goOffline","pathOrRef","checkValue","siv","SIV","create","Utf8","lib","WordArray","random"],"mappings":"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"}