var FireCrypt=function(){"use strict";class t{constructor(t,r){this._spec=this._cleanSpecification(r),this._encryptString=this._throwNotSetUpError,this._decryptString=this._throwNotSetUpError,this._patternRegexes={},"function"==typeof LRUCache&&(this._encryptionCache=new LRUCache({max:t.encryptionCacheSize,length:this._computeCacheItemSize}),this._decryptionCache=new LRUCache({max:t.decryptionCacheSize,length:this._computeCacheItemSize}))}_cleanSpecification(t,r){for(var e=Object.keys(t),n=0;n<e.length;n++){var i=e[n];if(".encrypt"===i)for(var o=Object.keys(t[i]),s=0;s<o.length;s++){var c=o[s];if("key"!==c&&"value"!==c&&"few"!==c)throw new Error("Illegal .encrypt subkey: "+o[s])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(i)||/[$]/.test(i.slice(1)))throw new Error("Illegal character in specification key: "+i);this._cleanSpecification(t[i],(r||"")+"/"+i)}switch(i.charAt(0)){case"$":if("$"===i)break;if(t.$)throw new Error("Multiple wildcard keys in specification at "+r);t.$=t[i],delete t[i];break;case".":if(".encrypt"!==i)throw new Error("Unknown directive at "+r+": "+i)}}return t}_throwNotSetUpError(){var t=new Error("Encryption not set up");throw t.firecrypt="NO_KEY",t}_computeCacheItemSize(t,r){return r.length+("string"==typeof t?t.length:4)}setStringEncryptionFunctions(t,r){this._encryptString=t,this._decryptString=r}encryptPath(t,r){r=r||this._spec.rules,t=t.slice();for(var e=0;e<t.length&&(r=r[t[e]]||r.$);e++)r[".encrypt"]&&r[".encrypt"].key&&(t[e]=this.encrypt(t[e],"string",r[".encrypt"].key));return t}encryptRef(t,r){var e=this.encryptPath(r||this.refToPath(t));return e.length?t.root.child(e.join("/")):t.root}decryptRef(t){for(var r=this.refToPath(t,!0),e=!1,n=0;n<r.length;n++){var i=this.decrypt(r[n]);i!==r[n]&&(r[n]=i,e=!0)}return e?t.root.child(r.join("/")):t}specForPath(t,r){r=r||this._spec.rules;for(var e=0;r&&e<t.length;e++)r=r[t[e]]||r.$;return r}transformValue(t,r,e){return this.transformTree(r,this.specForPath(t),e)}transformTree(t,r,e){if(!r)return t;var n,i=this.getType(t);if(/^(string|number|boolean)$/.test(i))r[".encrypt"]&&r[".encrypt"].value&&(t=e(t,i,r[".encrypt"].value));else if("object"===i&&null!==t){var o={};for(var s in t)if(t.hasOwnProperty(s)){var c,a=t[s];if(s.indexOf("/")>=0){var h=s.split("/");for(c=r,n=0;n<h.length;n++)e===decrypt?(h[n]=this.decrypt(h[n]),c=c&&(c[h[n]]||c.$)):(c=c&&(c[h[n]]||c.$))&&c[".encrypt"]&&c[".encrypt"].key&&(h[n]=e(h[n],"string",c[".encrypt"].key));s=h.join("/")}else e===this.decrypt?c=r[s=this.decrypt(s)]||r.$:(c=r[s]||r.$)&&c[".encrypt"]&&c[".encrypt"].key&&(s=e(s,"string",c[".encrypt"].key));o[s]=this.transformTree(a,c,e)}t=o}else if("array"===i){if(!r.$)return t;for(n=0;n<t.length;n++)t[n]=this.transformTree(t[n],r.$,e)}return t}refToPath(t,r){var e=t.root;if(t===e)return[];var n=decodeURIComponent(t.toString().slice(e.toString().length));if(!r&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}encrypt(t,r,e){var n,i;if(this._encryptionCache&&(n=r.charAt(0)+e+""+t,this._encryptionCache.has(n)))return this._encryptionCache.get(n);if("#"===e)i=this.encryptValue(t,r);else{if("string"!==r)throw new Error("Can't encrypt a "+r+" using pattern ["+e+"]");var o=t.match(this.compilePattern(e));if(!o)throw new Error("Can't encrypt as value doesn't match pattern ["+e+"]: "+t);var s=0;i=e.replace(/[#\.]/g,function(t){var r=o[++s];return"#"===t&&(r=this.encryptValue(r,"string")),r})}return this._encryptionCache&&this._encryptionCache.set(n,i),i}encryptValue(t,r){if(!/^(string|number|boolean)$/.test(r))throw new Error("Can't encrypt a "+r);switch(r){case"number":t=""+t;break;case"boolean":t=t?"t":"f"}return""+r.charAt(0).toUpperCase()+this._encryptString(t)+""}decrypt(t){if(this._decryptionCache&&this._decryptionCache.has(t))return this._decryptionCache.get(t);if(!/\x91/.test(t))return t;var r,e=t.match(/^\x91(.)([^\x92]*)\x92$/);if(e){var n=this._decryptString(e[2]);switch(e[1]){case"S":r=n;break;case"N":if((r=Number(n))!=r)throw new Error("Invalid encrypted number: "+n);break;case"B":if("t"===n)r=!0;else{if("f"!==n)throw new Error("Invalid encrypted boolean: "+n);r=!1}break;default:throw new Error("Invalid encrypted value type code: "+e[1])}}else r=t.replace(/\x91(.)([^\x92]*)\x92/g,function(t,r,e){if("S"!==r)throw new Error("Invalid multi-segment encrypted value: "+r);return this._decryptString(e)});return this._decryptionCache&&this._decryptionCache.set(t,r),r}getType(t){if(Array.isArray(t))return"array";var r=typeof t;return"object"===r&&(t instanceof String?r="string":t instanceof Number?r="number":t instanceof Boolean&&(r="boolean")),r}compilePattern(t){var r=this._patternRegexes[t];return r||(r=this._patternRegexes[t]=new RegExp("^"+t.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$")),r}}class r{constructor(t,r){this._ref=r.decryptRef(t.ref),this._path=r.refToPath(this._ref),this._snap=t,this._crypto=r}get key(){return this._ref.key}get ref(){return new i(this._ref.ref,this._crypto)}val(){return this._crypto.transformValue(this._path,this._snap.val(),this._crypto.decrypt.bind(this._crypto))}child(t){return new r(this._snap.child(t),this._crypto)}forEach(t){return this._snap.forEach(e=>t(new r(e),this._crypto))}exists(){return this._snap.exists.apply(this._snap,arguments)}hasChild(t){return t=this._crypto.encryptPath(t.split("/"),this._crypto.specForPath(this._path)).join("/"),this._snap.hasChild(t)}hasChildren(){return this._snap.hasChildren.apply(this._snap,arguments)}numChildren(){return this._snap.numChildren.apply(this._snap,arguments)}toJSON(){const t=this._snap.toJSON.apply(this._snap,arguments);return this._crypto.transformValue(this._path,t,this._crypto.decrypt.bind(this._crypto))}}class e{constructor(t,r,e,n){this._query=t,this._order=r||{},this._originalRef=e||t,this._crypto=n}_wrapQueryCallback(t){if(!t||t.firecryptCallback)return;const e=(e,n)=>t.call(this,new r(e,this._crypto),n,this._crypto);e.firecryptCallback=e,t.firecryptCallback=e}get ref(){return new i(this._crypto.decryptRef(this._query.ref),this._crypto)}on(t,r,e,n){return this._wrapQueryCallback(r),this._originalRef.on.call(this._query,t,r.firecryptCallback,e,n)}off(t,r,e){return r&&r.firecryptCallback&&(r=r.firecryptCallback),this._originalRef.off.call(this._query,t,r,e)}once(t,e,n,i){return this._wrapQueryCallback(e),this._originalRef.once.call(this._query,t,e&&e.firecryptCallback,n,i).then(t=>new r(t,this._crypto))}orderByChild(t){return this._orderBy("orderByChild","child",t)}orderByKey(){return this._orderBy("orderByKey","key")}orderByValue(){return this._orderBy("orderByValue","value")}startAt(t,r){return this._checkCanSort(void 0!==r),this._delegate("startAt",arguments)}endAt(t,r){return this._checkCanSort(void 0!==r),this._delegate("endAt",arguments)}equalTo(t,r){return this._order[this._order.by+"Encrypted"]&&(t=this._crypto.encrypt(t,this._crypto.getType(t),this._order[this._order.by+"Encrypted"])),void 0!==r&&this._order.keyEncrypted&&(r=this._crypto.encrypt(r,"string",this._order.keyEncrypted)),new e(this._originalRef.equalTo.call(this._query,t,r),this._order,this._crypto)}limitToFirst(){return this._delegate("limitToFirst",arguments)}limitToLast(){return this._delegate("limitToLast",arguments)}limit(){return this._delegate("limit",arguments)}_delegate(t,r){return new e(this._originalRef[t].apply(this._query,r),this._order,this._crypto)}_checkCanSort(t){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||t&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")}_orderBy(t,r,n){const i=this._crypto.specForPath(this._crypto.refToPath(this.ref)),o={by:r};let s;if(i){const t=n&&n.split("/");for(const r in i){if(!i.hasOwnProperty(r))continue;const e=i[r];if(e[".encrypt"]&&(e[".encrypt"].key&&(o.keyEncrypted=e[".encrypt"].key),e[".encrypt"].value&&(o.valueEncrypted=e[".encrypt"].value)),n){const r=this._crypto.specForPath(t,e);r&&r[".encrypt"]&&r[".encrypt"].value&&(o.childEncrypted=r[".encrypt"].value);const i=this._crypto.encryptPath(t,e).join("/");if(s&&i!==s)throw new Error('Incompatible encryption specifications for orderByChild("'+n+'")');s=i}}}return new e(n?this._originalRef[t].call(this._query,s||n):this._originalRef[t].call(this._query),o,this._crypto)}}class n{constructor(t,r,e){this._path=t,this._crypto=e,this._originalOnDisconnect=r}_interceptOnDisconnectWrite(t,r,e){const n=this;this[t]=function(){const i=Array.prototype.slice.call(r);return e>=0&&e<i.length&&(i[e]=n._crypto.transformValue(n._path,i[e],n._crypto.encrypt.bind(n._crypto))),n._originalOnDisconnect[t].apply(n._originalOnDisconnect,i)}}set(){return this._interceptOnDisconnectWrite("set",arguments,0)}update(){return this._interceptOnDisconnectWrite("update",arguments,0)}remove(){return this._interceptOnDisconnectWrite("remove",arguments)}cancel(){return this._interceptOnDisconnectWrite("cancel",arguments)}}class i{constructor(t,r){this._ref=t,this._crypto=r,["on","off","once","orderByChild","orderByKey","orderByValue","startAt","endAt","equalTo","limitToFirst","limitToLast"].forEach(t=>{this._interceptQuery(t)})}static get SERVER_TIMESTAMP(){return{".sv":"timestamp"}}get key(){return this._ref.key}get path(){return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length-1)}get ref(){return this._ref.isEqual(this._ref.ref)?this:new i(this._ref.ref,this._crypto)}get root(){return this._ref.isEqual(this._ref.root)?this:new i(this._ref.root,this._crypto)}get parent(){return null===this._ref.parent?null:new i(this._ref.parent,this._crypto)}child(t){return new i(this._ref.child(t),this._crypto)}toJSON(){return this._ref.toJSON()}isEqual(t){return this._ref.isEqual(t._ref)}toString(){return decodeURIComponent(this._ref.toString())}push(){const t=this._ref.push(),r=Array.prototype.slice.call(arguments);if(void 0!==r[0]){const e=this._crypto.encryptRef(t),n=this._crypto.refToPath(t);r[0]=this._crypto.transformValue(n,r[0],this._crypto.encrypt.bind(this._crypto)),t.set.apply(e,r)}const e=new i(this._crypto.decryptRef(t),this._crypto);return e.then=t.then,e.catch=t.catch,t.finally&&(e.finally=t.finally),e}_interceptWrite(t,r,e){const n=this._crypto.encryptRef(this._ref),i=Array.prototype.slice.call(r);if(e>=0&&e<i.length){const t=this._crypto.refToPath(this._ref);i[e]=this._crypto.transformValue(t,i[e],this._crypto.encrypt.bind(this._crypto))}return this._ref[t].apply(n,i)}set(){return this._interceptWrite("set",arguments,0)}remove(){return this._interceptWrite("remove",arguments)}update(){return this._interceptWrite("update",arguments,0)}childrenKeys(){if(!this._ref.childrenKeys)throw new Error("childrenKeys() is not implemented.");const t=this._crypto.encryptRef(this._ref);return this._ref.childrenKeys.apply(t,arguments).then(t=>t.some(t=>/\x91/.test(t))?t.map(this._crypto.decrypt.bind(this._crypto)):t)}onDisconnect(){const t=this._crypto.encryptRef(this._ref);return new n(t,this._ref.onDisconnect.call(t),this._crypto)}_interceptQuery(t){const r=this;this[t]=function(){const n=r._crypto.encryptRef(r._ref),i=new e(n,{},r._ref,r._crypto);return i[t].apply(i,arguments)}}transaction(){const t=this,e=this._crypto.encryptRef(this._ref),n=this._crypto.refToPath(this._ref),i=Array.prototype.slice.call(arguments),o=i[0];if(i[0]=o&&function(r){return r=t._crypto.transformValue(n,r,t._crypto.decrypt.bind(t._crypto)),r=o(r),r=t._crypto.transformValue(n,r,t._crypto.encrypt.bind(t._crypto))},i.length>1){const t=i[1];i[1]=t&&function(e,n,i){return t(e,n,i&&new r(i))}}return this._ref.transaction.apply(e,i).then(t=>(t.snapshot=t.snapshot&&new r(t.snapshot,this._crypto),t))}}"undefined"!=typeof require&&("undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv")),CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};return class{constructor(t){if("object"!=typeof t||null===t||"object"!=typeof t.app||"function"!=typeof t.ref)throw new Error(`Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got "${t}".`);this._db=t,this._crypto=void 0}_ensureEncryptionConfigured(){if(void 0===this._crypto)throw new Error("Encryption for this FireCrypt reference has not been configured yet.")}_setupAesSiv(t,r){const e=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(t)),n=t=>CryptoJS.enc.Base64UrlSafe.stringify(e.encrypt(t)),i=t=>{const r=e.decrypt(CryptoJS.enc.Base64UrlSafe.parse(t));if(!1===r){const t=new Error("Wrong decryption key");throw t.firecrypt="WRONG_KEY",t}return CryptoJS.enc.Utf8.stringify(r)};return this._crypto.setStringEncryptionFunctions(n,i),r&&i(r),n(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))}get app(){return this._ensureEncryptionConfigured(),this._db.app}configureEncryption(r={},e={}){if("object"!=typeof r||null===r)throw new Error(`Expected second argument passed to configureEncryption() to be an object, but got "${r}".`);if("object"!=typeof e||null===e)throw new Error(`Expected third argument passed to configureEncryption() to be an object, but got "${e}".`);let n;switch(r.cacheSize=r.cacheSize||5e6,r.encryptionCacheSize=r.encryptionCacheSize||r.cacheSize,r.decryptionCacheSize=r.decryptionCacheSize||r.cacheSize,this._crypto=new t(r,e),r.algorithm){case"aes-siv":if(!r.key)throw new Error("You must specify a key to use AES encryption.");n=this._setupAesSiv(r.key,r.keyCheckValue);break;case"passthrough":this._crypto.setStringEncryptionFunctions(t=>t,t=>t);break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+r.algorithm+'".')}return n}goOnline(){return this._ensureEncryptionConfigured(),this._db.goOnline()}goOffline(){return this._ensureEncryptionConfigured(),this._db.goOffline()}ref(t){if(this._ensureEncryptionConfigured(),void 0!==t&&"string"!=typeof t)throw new Error(`Expected first argument passed to ref() to be undefined or a string, but got "${t}".`);return new i(this._db.ref(t),this._crypto)}refFromURL(t){if(this._ensureEncryptionConfigured(),"string"!=typeof t||null===t.match(/^https:\/\/.*/g))throw new Error(`Expected first argument passed to refFromURL() to be a string URL, but got "${t}".`);return new i(this._db.refFromURL(path),this._crypto)}}}();
//# sourceMappingURL=firecrypt.min.js.map
