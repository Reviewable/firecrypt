var FireCrypt=function(){"use strict";let e,r,t,n,i;function o(r){e=function e(r,t){var n=Object.keys(r);for(var i=0;i<n.length;i++){var o=n[i];if(".encrypt"===o)for(var s=Object.keys(r[o]),c=0;c<s.length;c++){var a=s[c];if("key"!==a&&"value"!==a&&"few"!==a)throw new Error("Illegal .encrypt subkey: "+s[c])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(o)||/[$]/.test(o.slice(1)))throw new Error("Illegal character in specification key: "+o);e(r[o],(t||"")+"/"+o)}switch(o.charAt(0)){case"$":if("$"===o)break;if(r.$)throw new Error("Multiple wildcard keys in specification at "+t);r.$=r[o],delete r[o];break;case".":if(".encrypt"!==o)throw new Error("Unknown directive at "+t+": "+o)}}return r}(r)}function s(e,n){r=e,t=n}function c(){var e=new Error("Encryption not set up");throw e.firecrypt="NO_KEY",e}function a(e,r){return r.length+("string"==typeof e?e.length:4)}function h(r,t){t=t||e.rules,r=r.slice();for(var n=0;n<r.length&&(t=t[r[n]]||t.$);n++)t[".encrypt"]&&t[".encrypt"].key&&(r[n]=d(r[n],"string",t[".encrypt"].key));return r}function l(e,r){var t=h(r||y(e));return t.length?e.root.child(t.join("/")):e.root}function p(e){for(var r=y(e,!0),t=!1,n=0;n<r.length;n++){var i=g(r[n]);i!==r[n]&&(r[n]=i,t=!0)}return t?e.root.child(r.join("/")):e}function u(r,t){t=t||e.rules;for(var n=0;t&&n<r.length;n++)t=t[r[n]]||t.$;return t}function f(e,r,t){return function e(r,t,n){if(!t)return r;var i=w(r);var o;if(/^(string|number|boolean)$/.test(i))t[".encrypt"]&&t[".encrypt"].value&&(r=n(r,i,t[".encrypt"].value));else if("object"===i&&null!==r){var s={};for(var c in r)if(r.hasOwnProperty(c)){var a,h=r[c];if(c.indexOf("/")>=0){var l=c.split("/");for(a=t,o=0;o<l.length;o++)n===g?(l[o]=g(l[o]),a=a&&(a[l[o]]||a.$)):(a=a&&(a[l[o]]||a.$))&&a[".encrypt"]&&a[".encrypt"].key&&(l[o]=n(l[o],"string",a[".encrypt"].key));c=l.join("/")}else n===g?(c=g(c),a=t[c]||t.$):(a=t[c]||t.$)&&a[".encrypt"]&&a[".encrypt"].key&&(c=n(c,"string",a[".encrypt"].key));s[c]=e(h,a,n)}r=s}else if("array"===i){if(!t.$)return r;for(o=0;o<r.length;o++)r[o]=e(r[o],t.$,n)}return r}(r,u(e),t)}function y(e,r){var t=e.root;if(e===t)return[];var n=decodeURIComponent(e.toString().slice(t.toString().length));if(!r&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function d(e,r,t){var i,o;if(n&&(i=r.charAt(0)+t+""+e,n.has(i)))return n.get(i);if("#"===t)o=_(e,r);else{if("string"!==r)throw new Error("Can't encrypt a "+r+" using pattern ["+t+"]");var s=e.match(function(e){var r=b[e];r||(r=b[e]=new RegExp("^"+e.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return r}(t));if(!s)throw new Error("Can't encrypt as value doesn't match pattern ["+t+"]: "+e);var c=0;o=t.replace(/[#\.]/g,function(e){var r=s[++c];return"#"===e&&(r=_(r,"string")),r})}return n&&n.set(i,o),o}function _(e,t){if(!/^(string|number|boolean)$/.test(t))throw new Error("Can't encrypt a "+t);switch(t){case"number":e=""+e;break;case"boolean":e=e?"t":"f"}return""+t.charAt(0).toUpperCase()+r(e)+""}function g(e){if(i&&i.has(e))return i.get(e);if(!/\x91/.test(e))return e;var r,n=e.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var o=t(n[2]);switch(n[1]){case"S":r=o;break;case"N":if((r=Number(o))!=r)throw new Error("Invalid encrypted number: "+o);break;case"B":if("t"===o)r=!0;else{if("f"!==o)throw new Error("Invalid encrypted boolean: "+o);r=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else r=e.replace(/\x91(.)([^\x92]*)\x92/g,function(e,r,n){if("S"!==r)throw new Error("Invalid multi-segment encrypted value: "+r);return t(n)});return i&&i.set(e,r),r}function w(e){if(Array.isArray(e))return"array";var r=typeof e;return"object"===r&&(e instanceof String?r="string":e instanceof Number?r="number":e instanceof Boolean&&(r="boolean")),r}var b={};class v{constructor(e){this._ref=p(e.ref),this._path=y(this._ref),this._snap=e}get key(){return this._ref.key}get ref(){return new k(this._ref.ref)}val(){return f(this._path,this._snap.val(),g)}child(e){return new v(this._snap.child(e))}forEach(e){return this._snap.forEach(function(r){return e(new v(r))})}exists(){return this._snap.exists.apply(this._snap,arguments)}hasChild(e){return e=h(e.split("/"),u(this._path)).join("/"),this._snap.hasChild(e)}hasChildren(){return this._snap.hasChildren.apply(this._snap,arguments)}numChildren(){return this._snap.numChildren.apply(this._snap,arguments)}toJSON(){const e=this._snap.toJSON.apply(this._snap,arguments);return f(this._path,e,g)}}class C{constructor(e,r,t){this._query=e,this._order=r||{},this._originalRef=t||e}get ref(){return new k(p(this._query.ref))}on(e,r,t,n){return E(r),this._originalRef.on.call(this._query,e,r.firecryptCallback,t,n)}off(e,r,t){return r&&r.firecryptCallback&&(r=r.firecryptCallback),this._originalRef.off.call(this._query,e,r,t)}once(e,r,t,n){return E(r),this._originalRef.once.call(this._query,e,r&&r.firecryptCallback,t,n).then(e=>new v(e))}orderByChild(e){return this._orderBy("orderByChild","child",e)}orderByKey(){return this._orderBy("orderByKey","key")}orderByValue(){return this._orderBy("orderByValue","value")}startAt(e,r){return this._checkCanSort(void 0!==r),this._delegate("startAt",arguments)}endAt(e,r){return this._checkCanSort(void 0!==r),this._delegate("endAt",arguments)}equalTo(e,r){return this._order[this._order.by+"Encrypted"]&&(e=d(e,w(e),this._order[this._order.by+"Encrypted"])),void 0!==r&&this._order.keyEncrypted&&(r=d(r,"string",this._order.keyEncrypted)),new C(this._originalRef.equalTo.call(this._query,e,r),this._order)}limitToFirst(){return this._delegate("limitToFirst",arguments)}limitToLast(){return this._delegate("limitToLast",arguments)}limit(){return this._delegate("limit",arguments)}_delegate(e,r){return new C(this._originalRef[e].apply(this._query,r),this._order)}_checkCanSort(e){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||e&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")}_orderBy(e,r,t){const n=u(y(this.ref)),i={by:r};let o;if(n){const e=t&&t.split("/");for(const r in n){if(!n.hasOwnProperty(r))continue;const s=n[r];if(s[".encrypt"]&&(s[".encrypt"].key&&(i.keyEncrypted=s[".encrypt"].key),s[".encrypt"].value&&(i.valueEncrypted=s[".encrypt"].value)),t){const r=u(e,s);r&&r[".encrypt"]&&r[".encrypt"].value&&(i.childEncrypted=r[".encrypt"].value);const n=h(e,s).join("/");if(o&&n!==o)throw new Error('Incompatible encryption specifications for orderByChild("'+t+'")');o=n}}}return new C(t?this._originalRef[e].call(this._query,o||t):this._originalRef[e].call(this._query),i)}}function E(e){if(!e||e.firecryptCallback)return;const r=function(r,t){return e.call(this,new v(r),t)};r.firecryptCallback=r,e.firecryptCallback=r}class m{constructor(e,r){this._path=e,this._originalOnDisconnect=r}_interceptOnDisconnectWrite(e,r,t){this[e]=function(){const n=Array.prototype.slice.call(r);return t>=0&&t<n.length&&(n[t]=f(this._path,n[t],d)),this._originalOnDisconnect[e].apply(this._originalOnDisconnect,n)}}set(){return this._interceptOnDisconnectWrite("set",arguments,0)}update(){return this._interceptOnDisconnectWrite("update",arguments,0)}remove(){return this._interceptOnDisconnectWrite("remove",arguments)}cancel(){return this._interceptOnDisconnectWrite("cancel",arguments)}}class k{constructor(e){this._ref=e,["on","off","once","orderByChild","orderByKey","orderByValue","startAt","endAt","equalTo","limitToFirst","limitToLast"].forEach(e=>{this._interceptQuery(e)})}static get SERVER_TIMESTAMP(){return{".sv":"timestamp"}}get key(){return this._ref.key}get path(){return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length-1)}get ref(){return this._ref.isEqual(this._ref.ref)?this:new k(this._ref.ref)}get root(){return this._ref.isEqual(this._ref.root)?this:new k(this._ref.root)}get parent(){return null===this._ref.parent?null:new k(this._ref.parent)}child(e){return new k(this._ref.child(e))}toJSON(){return this._ref.toJSON()}isEqual(e){return this._ref.isEqual(e._ref)}toString(){return decodeURIComponent(this._ref.toString())}push(){const e=this._ref.push(),r=Array.prototype.slice.call(arguments);if(void 0!==r[0]){const t=l(e),n=y(e);r[0]=f(n,r[0],d),e.set.apply(t,r)}const t=new k(p(e));return t.then=e.then,t.catch=e.catch,e.finally&&(t.finally=e.finally),t}_interceptWrite(e,r,t){const n=l(this._ref),i=y(this._ref),o=Array.prototype.slice.call(r);return t>=0&&t<o.length&&(o[t]=f(i,o[t],d)),this._ref[e].apply(n,o)}set(){return this._interceptWrite("set",arguments,0)}remove(){return this._interceptWrite("remove",arguments)}update(){return this._interceptWrite("update",arguments,0)}childrenKeys(){if(!this._ref.childrenKeys)throw new Error("childrenKeys() is not implemented.");const e=l(this._ref);return this._ref.childrenKeys.apply(e,arguments).then(e=>e.some(e=>/\x91/.test(e))?e.map(g):e)}onDisconnect(){const e=l(this._ref);return new m(e,this._ref.onDisconnect.call(e))}_interceptQuery(e){this[e]=function(){const r=l(this._ref),t=new C(r,{},this._ref);return t[e].apply(t,arguments)}}transaction(){const e=l(this._ref),r=y(this._ref),t=Array.prototype.slice.call(arguments),n=t[0];if(t[0]=n&&function(e){return e=f(r,e,g),e=n(e),e=f(r,e,d)},t.length>1){const e=t[1];t[1]=e&&function(r,t,n){return e(r,t,n&&new v(n))}}return this._ref.transaction.apply(e,t).then(function(e){return e.snapshot=e.snapshot&&new v(e.snapshot),e})}}"undefined"!=typeof require&&("undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv")),CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};return class{constructor(e,r={},t={}){if("object"!=typeof e||null===e||"object"!=typeof e.app||"function"!=typeof e.ref)throw new Error(`Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got "${e}".`);if("object"!=typeof r||null===r)throw new Error(`Expected second argument passed to FireCrypt constructor to be an object, but got "${r}".`);if("object"!=typeof t||null===t)throw new Error(`Expected third argument passed to FireCrypt constructor to be an object, but got "${t}".`);var h;switch(this._db=e,r.cacheSize=r.cacheSize||5e6,r.encryptionCacheSize=r.encryptionCacheSize||r.cacheSize,r.decryptionCacheSize=r.decryptionCacheSize||r.cacheSize,s(c,c),"function"==typeof LRUCache&&(h=new LRUCache({max:r.encryptionCacheSize,length:a}),n=h,function(e){i=e}(new LRUCache({max:r.decryptionCacheSize,length:a}))),r.algorithm){case"aes-siv":if(!r.key)throw new Error("You must specify a key to use AES encryption.");this.encryptionKeyCheckValue=function(e,r){const t=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(e)),n=e=>CryptoJS.enc.Base64UrlSafe.stringify(t.encrypt(e)),i=e=>{const r=t.decrypt(CryptoJS.enc.Base64UrlSafe.parse(e));if(!1===r){const e=new Error("Wrong decryption key");throw e.firecrypt="WRONG_KEY",e}return CryptoJS.enc.Utf8.stringify(r)};return s(n,i),r&&i(r),n(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))}(r.key,r.keyCheckValue);break;case"passthrough":s(e=>e,e=>e);break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+r.algorithm+'".')}return o(t),()=>this}get app(){return this._db.app}goOnline(){return this._db.goOnline()}goOffline(){return this._db.goOffline()}ref(e){if(void 0!==e&&"string"!=typeof e)throw new Error(`Expected first argument passed to ref() to be undefined or a string, but got "${e}".`);return new k(this._db.ref(e))}refFromURL(e){if("string"!=typeof e||null===e.match(/^https:\/\/.*/g))throw new Error(`Expected first argument passed to refFromURL() to be a string URL, but got "${e}".`);return new k(this._db.refFromURL(path))}}}();
//# sourceMappingURL=firecrypt.min.js.map
