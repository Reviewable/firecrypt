!function(){"use strict";let r,t,e;function n(t){r=function r(t,e){var n=Object.keys(t);for(var i=0;i<n.length;i++){var o=n[i];if(".encrypt"===o)for(var c=Object.keys(t[o]),a=0;a<c.length;a++){var s=c[a];if("key"!==s&&"value"!==s&&"few"!==s)throw new Error("Illegal .encrypt subkey: "+c[a])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(o)||/[$]/.test(o.slice(1)))throw new Error("Illegal character in specification key: "+o);r(t[o],(e||"")+"/"+o)}switch(o.charAt(0)){case"$":if("$"===o)break;if(t.$)throw new Error("Multiple wildcard keys in specification at "+e);t.$=t[o],delete t[o];break;case".":if(".encrypt"!==o)throw new Error("Unknown directive at "+e+": "+o)}}return t}(t)}function i(){var r=new Error("Encryption not set up");throw r.firecrypt="NO_KEY",r}function o(r,t){return t.length+("string"==typeof r?r.length:4)}function c(t,e){e=e||r.rules,t=t.slice();for(var n=0;n<t.length&&(e=e[t[n]]||e.$);n++)e[".encrypt"]&&e[".encrypt"].key&&(t[n]=l(t[n],"string",e[".encrypt"].key));return t}function a(r,t){var e=c(t||u(r));return e.length?r.root().child(e.join("/")):r.root()}function s(r){for(var t=u(r,!0),e=!1,n=0;n<t.length;n++){var i=f(t[n]);i!==t[n]&&(t[n]=i,e=!0)}return e?r.root().child(t.join("/")):r}function p(t,e){e=e||r.rules;for(var n=0;e&&n<t.length;n++)e=e[t[n]]||e.$;return e}function y(r,t,e){return function r(t,e,n){if(!e)return t;var i=d(t);var o;if(/^(string|number|boolean)$/.test(i))e[".encrypt"]&&e[".encrypt"].value&&(t=n(t,i,e[".encrypt"].value));else if("object"===i&&null!==t){var c={};for(var a in t)if(t.hasOwnProperty(a)){var s,p=t[a];if(a.indexOf("/")>=0){var y=a.split("/");for(s=e,o=0;o<y.length;o++)n===f?(y[o]=f(y[o]),s=s&&(s[y[o]]||s.$)):(s=s&&(s[y[o]]||s.$))&&s[".encrypt"]&&s[".encrypt"].key&&(y[o]=n(y[o],"string",s[".encrypt"].key));a=y.join("/")}else n===f?(a=f(a),s=e[a]||e.$):(s=e[a]||e.$)&&s[".encrypt"]&&s[".encrypt"].key&&(a=n(a,"string",s[".encrypt"].key));c[a]=r(p,s,n)}t=c}else if("array"===i){if(!e.$)return t;for(o=0;o<t.length;o++)t[o]=r(t[o],e.$,n)}return t}(t,p(r),e)}function u(r,t){var e=r.root();if(r===e)return[];var n=decodeURIComponent(r.toString().slice(e.toString().length));if(!t&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function l(r,e,n){var i,o;if(t&&(i=e.charAt(0)+n+""+r,t.has(i)))return t.get(i);if("#"===n)o=h(r,e);else{if("string"!==e)throw new Error("Can't encrypt a "+e+" using pattern ["+n+"]");var c=r.match(function(r){var t=v[r];t||(t=v[r]=new RegExp("^"+r.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return t}(n));if(!c)throw new Error("Can't encrypt as value doesn't match pattern ["+n+"]: "+r);var a=0;o=n.replace(/[#\.]/g,function(r){var t=c[++a];return"#"===r&&(t=h(t,"string")),t})}return t&&t.set(i,o),o}function h(r,t){if(!/^(string|number|boolean)$/.test(t))throw new Error("Can't encrypt a "+t);switch(t){case"number":r=""+r;break;case"boolean":r=r?"t":"f"}return""+t.charAt(0).toUpperCase()+encryptString(r)+""}function f(r){if(e&&e.has(r))return e.get(r);if(!/\x91/.test(r))return r;var t,n=r.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var i=decryptString(n[2]);switch(n[1]){case"S":t=i;break;case"N":if((t=Number(i))!=t)throw new Error("Invalid encrypted number: "+i);break;case"B":if("t"===i)t=!0;else{if("f"!==i)throw new Error("Invalid encrypted boolean: "+i);t=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else t=r.replace(/\x91(.)([^\x92]*)\x92/g,function(r,t,e){if("S"!==t)throw new Error("Invalid multi-segment encrypted value: "+t);return decryptString(e)});return e&&e.set(r,t),t}function d(r){if(Array.isArray(r))return"array";var t=typeof r;return"object"===t&&(r instanceof String?t="string":r instanceof Number?t="number":r instanceof Boolean&&(t="boolean")),t}var v={};class _{constructor(r,t){this._path=r,this._originalOnDisconnect=t,this._interceptOnDisconnectWrite("set",0),this._interceptOnDisconnectWrite("update",0),this._interceptOnDisconnectWrite("remove"),this._interceptOnDisconnectWrite("setWithPriority",0),this._interceptOnDisconnectWrite("cancel")}_interceptOnDisconnectWrite(r,t){this[r]=function(){const e=Array.prototype.slice.call(arguments);return t>=0&&t<e.length&&(e[t]=y(this._path,e[t],l)),this._originalOnDisconnect[r].apply(this._originalOnDisconnect,e)}}}if("undefined"!=typeof require){"undefined"==typeof Firebase&&(global.Firebase=require("firebase")),"undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv");try{require("firebase-childrenkeys")}catch(r){}}CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};var g,w,b=Firebase.prototype,k={},C=!1;function S(r,t,e){this._query=r,this._order=t||{},this._original=e||r}function m(r){this._ref=s(r.ref()),this._path=u(this._ref),this._snap=r}function E(r,t){var e=b[r];b[r]=function(){var r=u(this),n=a(this,r),i=Array.prototype.slice.call(arguments);return t>=0&&t<i.length&&(i[t]=y(r,i[t],l)),e.apply(n,i)}}function B(r){if(r&&!r.firecryptCallback){var t=function(t,e){return r.call(this,new m(t),e)};t.firecryptCallback=t,r.firecryptCallback=t}}function x(r){m.prototype[r]=function(){return this._snap[r].apply(this._snap,arguments)}}Firebase.initializeEncryption=function(r,c){var p,h;switch(r.cacheSize=r.cacheSize||5e6,r.encryptionCacheSize=r.encryptionCacheSize||r.cacheSize,r.decryptionCacheSize=r.decryptionCacheSize||r.cacheSize,g=w=i,"function"==typeof LRUCache&&(h=new LRUCache({max:r.encryptionCacheSize,length:o}),t=h,function(r){e=r}(new LRUCache({max:r.decryptionCacheSize,length:o}))),r.algorithm){case"aes-siv":if(!r.key)throw new Error("You must specify a key to use AES encryption.");p=function(r,t){var e=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(r));g=function(r){return CryptoJS.enc.Base64UrlSafe.stringify(e.encrypt(r))},w=function(r){var t=e.decrypt(CryptoJS.enc.Base64UrlSafe.parse(r));if(!1===t){var n=new Error("Wrong decryption key");throw n.firecrypt="WRONG_KEY",n}return CryptoJS.enc.Utf8.stringify(t)},t&&w(t);return g(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))}(r.key,r.keyCheckValue);break;case"passthrough":g=w=function(r){return r};break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+r.algorithm+'".')}return n(c),function(){if(C)return;E("set",0),E("update",0),r=b.push,b.push=function(){var t=r.apply(this,arguments),e=s(t);return e.then=t.then,e.catch=t.catch,t.finally&&(e.finally=t.finally),e},E("setWithPriority",0),E("setPriority"),b.childrenKeys&&function(){var r=b.childrenKeys;b.childrenKeys=function(){return r.apply(a(this),arguments).then(function(r){return r.some(function(r){return/\x91/.test(r)})?r.map(f):r})}}();var r;(function(){var r=b.transaction;b.transaction=function(){var t=u(this),e=a(this,t),n=Array.prototype.slice.call(arguments),i=n[0];if(n[0]=i&&function(r){return r=y(t,r,f),r=i(r),r=y(t,r,l)},n.length>1){var o=n[1];n[1]=o&&function(r,t,e){return o(r,t,e&&new m(e))}}return r.apply(e,n).then(function(r){return r.snapshot=r.snapshot&&new m(r.snapshot),r})}})(),function(){var r=b.onDisconnect;b.onDisconnect=function(){var t=u(this);return new _(t,r.call(a(this,t)))}}(),["on","off","once","orderByChild","orderByKey","orderByValue","orderByPriority","startAt","endAt","equalTo","limitToFirst","limitToLast","limit","ref"].forEach(function(r){!function(r){k[r]=b[r],b[r]=function(){var t=new S(a(this),{},k);return t[r].apply(t,arguments)}}(r)}),C=!0}(),p},S.prototype.on=function(r,t,e,n){return B(t),this._original.on.call(this._query,r,t.firecryptCallback,e,n)},S.prototype.off=function(r,t,e){return t&&t.firecryptCallback&&(t=t.firecryptCallback),this._original.off.call(this._query,r,t,e)},S.prototype.once=function(r,t,e,n){return B(t),this._original.once.call(this._query,r,t&&t.firecryptCallback,e,n).then(function(r){return new m(r)})},S.prototype.orderByChild=function(r){return this._orderBy("orderByChild","child",r)},S.prototype.orderByKey=function(){return this._orderBy("orderByKey","key")},S.prototype.orderByValue=function(){return this._orderBy("orderByValue","value")},S.prototype.orderByPriority=function(){return this._orderBy("orderByPriority","priority")},S.prototype.startAt=function(r,t){return this._checkCanSort(void 0!==t),this._delegate("startAt",arguments)},S.prototype.endAt=function(r,t){return this._checkCanSort(void 0!==t),this._delegate("endAt",arguments)},S.prototype.equalTo=function(r,t){return this._order[this._order.by+"Encrypted"]&&(r=l(r,d(r),this._order[this._order.by+"Encrypted"])),void 0!==t&&this._order.keyEncrypted&&(t=l(t,"string",this._order.keyEncrypted)),new S(this._original.equalTo.call(this._query,r,t),this._order)},S.prototype.limitToFirst=function(){return this._delegate("limitToFirst",arguments)},S.prototype.limitToLast=function(){return this._delegate("limitToLast",arguments)},S.prototype.limit=function(){return this._delegate("limit",arguments)},S.prototype.ref=function(){return s(this._original.ref.call(this._query))},S.prototype._delegate=function(r,t){return new S(this._original[r].apply(this._query,t),this._order)},S.prototype._checkCanSort=function(r){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||r&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")},S.prototype._orderBy=function(r,t,e){var n,i=p(u(this.ref())),o={by:t};if(i){var a=e&&e.split("/");for(var s in i)if(i.hasOwnProperty(s)){var y=i[s];if(y[".encrypt"]&&(y[".encrypt"].key&&(o.keyEncrypted=y[".encrypt"].key),y[".encrypt"].value&&(o.valueEncrypted=y[".encrypt"].value)),e){var l=p(a,y);l&&l[".encrypt"]&&l[".encrypt"].value&&(o.childEncrypted=l[".encrypt"].value);var h=c(a,y).join("/");if(n&&h!==n)throw new Error('Incompatible encryption specifications for orderByChild("'+e+'")');n=h}}}return new S(e?this._original[r].call(this._query,n||e):this._original[r].call(this._query),o)},x("exists"),x("hasChildren"),x("numChildren"),x("getPriority"),m.prototype.val=function(){return y(this._path,this._snap.val(),f)},m.prototype.child=function(r){return new m(this._snap.child(r))},m.prototype.forEach=function(r){return this._snap.forEach(function(t){return r(new m(t))})},m.prototype.hasChild=function(r){return r=c(r.split("/"),p(this._path)).join("/"),this._snap.hasChild(r)},m.prototype.key=function(){return this._ref.key()},m.prototype.name=function(){return this._ref.name()},m.prototype.ref=function(){return this._ref},m.prototype.exportVal=function(){return y(this._path,this._snap.exportVal(),f)}}();
//# sourceMappingURL=firecrypt.min.js.map
