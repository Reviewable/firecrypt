var FireCrypt=function(){"use strict";let e,t,r;function n(t){e=function e(t,r){var n=Object.keys(t);for(var i=0;i<n.length;i++){var o=n[i];if(".encrypt"===o)for(var s=Object.keys(t[o]),a=0;a<s.length;a++){var c=s[a];if("key"!==c&&"value"!==c&&"few"!==c)throw new Error("Illegal .encrypt subkey: "+s[a])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(o)||/[$]/.test(o.slice(1)))throw new Error("Illegal character in specification key: "+o);e(t[o],(r||"")+"/"+o)}switch(o.charAt(0)){case"$":if("$"===o)break;if(t.$)throw new Error("Multiple wildcard keys in specification at "+r);t.$=t[o],delete t[o];break;case".":if(".encrypt"!==o)throw new Error("Unknown directive at "+r+": "+o)}}return t}(t)}function i(){var e=new Error("Encryption not set up");throw e.firecrypt="NO_KEY",e}function o(e,t){return t.length+("string"==typeof e?e.length:4)}function s(t,r){r=r||e.rules,t=t.slice();for(var n=0;n<t.length&&(r=r[t[n]]||r.$);n++)r[".encrypt"]&&r[".encrypt"].key&&(t[n]=y(t[n],"string",r[".encrypt"].key));return t}function a(e,t){var r=s(t||p(e));return r.length?e.root.child(r.join("/")):e.root}function c(e){for(var t=p(e,!0),r=!1,n=0;n<t.length;n++){var i=u(t[n]);i!==t[n]&&(t[n]=i,r=!0)}return r?e.root.child(t.join("/")):e}function h(t,r){r=r||e.rules;for(var n=0;r&&n<t.length;n++)r=r[t[n]]||r.$;return r}function l(e,t,r){return function e(t,r,n){if(!r)return t;var i=function(e){if(Array.isArray(e))return"array";var t=typeof e;"object"===t&&(e instanceof String?t="string":e instanceof Number?t="number":e instanceof Boolean&&(t="boolean"));return t}(t);var o;if(/^(string|number|boolean)$/.test(i))r[".encrypt"]&&r[".encrypt"].value&&(t=n(t,i,r[".encrypt"].value));else if("object"===i&&null!==t){var s={};for(var a in t)if(t.hasOwnProperty(a)){var c,h=t[a];if(a.indexOf("/")>=0){var l=a.split("/");for(c=r,o=0;o<l.length;o++)n===u?(l[o]=u(l[o]),c=c&&(c[l[o]]||c.$)):(c=c&&(c[l[o]]||c.$))&&c[".encrypt"]&&c[".encrypt"].key&&(l[o]=n(l[o],"string",c[".encrypt"].key));a=l.join("/")}else n===u?(a=u(a),c=r[a]||r.$):(c=r[a]||r.$)&&c[".encrypt"]&&c[".encrypt"].key&&(a=n(a,"string",c[".encrypt"].key));s[a]=e(h,c,n)}t=s}else if("array"===i){if(!r.$)return t;for(o=0;o<t.length;o++)t[o]=e(t[o],r.$,n)}return t}(t,h(e),r)}function p(e,t){var r=e.root;if(e===r)return[];var n=decodeURIComponent(e.toString().slice(r.toString().length));if(!t&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function y(e,r,n){var i,o;if(t&&(i=r.charAt(0)+n+""+e,t.has(i)))return t.get(i);if("#"===n)o=f(e,r);else{if("string"!==r)throw new Error("Can't encrypt a "+r+" using pattern ["+n+"]");var s=e.match(function(e){var t=d[e];t||(t=d[e]=new RegExp("^"+e.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return t}(n));if(!s)throw new Error("Can't encrypt as value doesn't match pattern ["+n+"]: "+e);var a=0;o=n.replace(/[#\.]/g,function(e){var t=s[++a];return"#"===e&&(t=f(t,"string")),t})}return t&&t.set(i,o),o}function f(e,t){if(!/^(string|number|boolean)$/.test(t))throw new Error("Can't encrypt a "+t);switch(t){case"number":e=""+e;break;case"boolean":e=e?"t":"f"}return""+t.charAt(0).toUpperCase()+encryptString(e)+""}function u(e){if(r&&r.has(e))return r.get(e);if(!/\x91/.test(e))return e;var t,n=e.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var i=decryptString(n[2]);switch(n[1]){case"S":t=i;break;case"N":if((t=Number(i))!=t)throw new Error("Invalid encrypted number: "+i);break;case"B":if("t"===i)t=!0;else{if("f"!==i)throw new Error("Invalid encrypted boolean: "+i);t=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else t=e.replace(/\x91(.)([^\x92]*)\x92/g,function(e,t,r){if("S"!==t)throw new Error("Invalid multi-segment encrypted value: "+t);return decryptString(r)});return r&&r.set(e,t),t}var d={};class _{constructor(e,t){this._path=e,this._originalOnDisconnect=t,this._interceptOnDisconnectWrite("set",0),this._interceptOnDisconnectWrite("update",0),this._interceptOnDisconnectWrite("remove"),this._interceptOnDisconnectWrite("setWithPriority",0),this._interceptOnDisconnectWrite("cancel")}_interceptOnDisconnectWrite(e,t){this[e]=function(){const r=Array.prototype.slice.call(arguments);return t>=0&&t<r.length&&(r[t]=l(this._path,r[t],y)),this._originalOnDisconnect[e].apply(this._originalOnDisconnect,r)}}}class g{constructor(e){this._ref=e,this.get=e.get,this.remove=e.remove,this._interceptPush(),this._interceptTransaction(),this._interceptOnDisconnect(),["on","off","once","orderByChild","orderByKey","orderByValue","startAt","endAt","equalTo","limitToFirst","limitToLast"].forEach(e=>{this._interceptQuery(e)}),this.set=this._interceptWrite(e,"set",0),this.update=this._interceptWrite(e,"update",0),this.setPriority=this._interceptWrite(e,"setPriority"),this.setWithPriority=this._interceptWrite(e,"setWithPriority",0),e.childrenKeys&&(this.childrenKeys=this._interceptChildrenKeys(e))}static get SERVER_TIMESTAMP(){return{".sv":"timestamp"}}get key(){return console.log("GETTING KEY:",this._ref.key),this._ref.key}get path(){return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length-1)}get ref(){return this._ref.isEqual(this._ref.ref)?this:new g(this._ref.ref)}get root(){return this._ref.isEqual(this._ref.root)?this:new g(this._ref.root)}get parent(){return null===this._ref.parent?null:new g(this._ref.parent)}child(e){return new g(this._ref.child(e))}toJSON(){return this._ref.toJSON()}isEqual(e){return this._ref.isEqual(e._ref)}toString(){return decodeURIComponent(this._ref.toString())}_interceptPush(){this.push=(()=>{const e=this._ref.push.apply(this._ref,arguments),t=c(e);return t.then=e.then,t.catch=e.catch,e.finally&&(t.finally=e.finally),t})}_interceptWrite(e,t){this[e]=(()=>{const r=a(this._ref),n=Array.prototype.slice.call(arguments);return t>=0&&t<n.length&&(n[t]=l(p(path),n[t],encrypt)),this._ref[e].apply(r,n)})}_interceptChildrenKeys(){this.childrenKeys=(()=>{const e=a(this._ref);return this._ref.childrenKeys.apply(e,arguments).then(e=>e.some(e=>/\x91/.test(e))?e.map(u):e)})}_interceptOnDisconnect(){this.onDisconnect=(()=>{const e=a(this._ref);return new _(e,this._ref.onDisconnect.call(e))})}_interceptQuery(e){this[e]=(()=>{const t=a(this._ref);var r=new v(t,{},this._ref);return r[e].apply(r,arguments)})}_interceptTransaction(){this.transaction=(()=>{var e=a(this._ref),t=Array.prototype.slice.call(arguments),r=t[0];if(t[0]=r&&function(e){return e=l(path,e,u),e=r(e),e=l(path,e,y)},t.length>1){var n=t[1];t[1]=n&&function(e,t,r){return n(e,t,r&&new w(r))}}return this._ref.transaction.apply(e,t).then(function(e){return e.snapshot=e.snapshot&&new w(e.snapshot),e})})}}class w{constructor(e){this._ref=c(e.ref),this._path=p(this._ref),this._snap=e,this._delegateSnapshot("exists"),this._delegateSnapshot("toJSON"),this._delegateSnapshot("hasChildren"),this._delegateSnapshot("numChildren"),this._delegateSnapshot("getPriority")}_delegateSnapshot(e){this[e]=function(){return this._snap[e].apply(this._snap,arguments)}}get key(){return console.log("getting snapshot key"),this._ref.key}get ref(){return new g(this._ref.ref)}val(){return l(this._path,this._snap.val(),u)}child(e){return new w(this._snap.child(e))}forEach(e){return this._snap.forEach(function(t){return e(new w(t))})}hasChild(e){return e=s(e.split("/"),h(this._path)).join("/"),this._snap.hasChild(e)}exportVal(){return l(this._path,this._snap.exportVal(),u)}}class v{constructor(e,t,r){this._query=e,this._order=t||{},this._originalRef=r||e}get ref(){return new g(c(this._query.ref))}on(e,t,r,n){return b(t),this._originalRef.on.call(this._query,e,t.firecryptCallback,r,n)}off(e,t,r){return t&&t.firecryptCallback&&(t=t.firecryptCallback),this._originalRef.off.call(this._query,e,t,r)}once(e,t,r,n){return b(t),this._originalRef.once.call(this._query,e,t&&t.firecryptCallback,r,n).then(e=>new w(e))}orderByChild(e){return this._orderBy("orderByChild","child",e)}orderByKey(){return this._orderBy("orderByKey","key")}orderByValue(){return this._orderBy("orderByValue","value")}orderByPriority(){return this._orderBy("orderByPriority","priority")}startAt(e,t){return this._checkCanSort(void 0!==t),this._delegate("startAt",arguments)}endAt(e,t){return this._checkCanSort(void 0!==t),this._delegate("endAt",arguments)}equalTo(e,t){return this._order[this._order.by+"Encrypted"]&&(e=y(e,getType(e),this._order[this._order.by+"Encrypted"])),void 0!==t&&this._order.keyEncrypted&&(t=y(t,"string",this._order.keyEncrypted)),new v(this._originalRef.equalTo.call(this._query,e,t),this._order)}limitToFirst(){return this._delegate("limitToFirst",arguments)}limitToLast(){return this._delegate("limitToLast",arguments)}limit(){return this._delegate("limit",arguments)}ref(){return c(this._originalRef.ref.call(this._query))}_delegate(e,t){return new v(this._originalRef[e].apply(this._query,t),this._order)}_checkCanSort(e){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||e&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")}_orderBy(e,t,r){var n,i=h(p(this.ref)),o={by:t};if(i){var a=r&&r.split("/");for(var c in i)if(i.hasOwnProperty(c)){var l=i[c];if(l[".encrypt"]&&(l[".encrypt"].key&&(o.keyEncrypted=l[".encrypt"].key),l[".encrypt"].value&&(o.valueEncrypted=l[".encrypt"].value)),r){var y=h(a,l);y&&y[".encrypt"]&&y[".encrypt"].value&&(o.childEncrypted=y[".encrypt"].value);var f=s(a,l).join("/");if(n&&f!==n)throw new Error('Incompatible encryption specifications for orderByChild("'+r+'")');n=f}}}return new v(r?this._originalRef[e].call(this._query,n||r):this._originalRef[e].call(this._query),o)}}function b(e){if(e&&!e.firecryptCallback){var t=function(t,r){return e.call(this,new w(t),r)};t.firecryptCallback=t,e.firecryptCallback=t}}if("undefined"!=typeof require){"undefined"==typeof Firebase&&(global.Firebase=require("firebase")),"undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv");try{require("firebase-childrenkeys")}catch(e){}}let k,C;CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};return class{constructor(e,s={},a={}){if("object"!=typeof e||null===e||"object"!=typeof e.app||"function"!=typeof e.ref)throw new Error(`Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got "${e}".`);if("object"!=typeof s||null===s)throw new Error(`Expected second argument passed to FireCrypt constructor to be an object, but got "${s}".`);if("object"!=typeof a||null===a)throw new Error(`Expected third argument passed to FireCrypt constructor to be an object, but got "${a}".`);var c,h,l,p;switch(this._db=e,s.cacheSize=s.cacheSize||5e6,s.encryptionCacheSize=s.encryptionCacheSize||s.cacheSize,s.decryptionCacheSize=s.decryptionCacheSize||s.cacheSize,k=C=i,"function"==typeof LRUCache&&(c=new LRUCache({max:s.encryptionCacheSize,length:o}),t=c,function(e){r=e}(new LRUCache({max:s.decryptionCacheSize,length:o}))),s.algorithm){case"aes-siv":if(!s.key)throw new Error("You must specify a key to use AES encryption.");this.encryptionKeyCheckValue=(h=s.key,l=s.keyCheckValue,p=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(h)),k=function(e){return CryptoJS.enc.Base64UrlSafe.stringify(p.encrypt(e))},C=function(e){var t=p.decrypt(CryptoJS.enc.Base64UrlSafe.parse(e));if(!1===t){var r=new Error("Wrong decryption key");throw r.firecrypt="WRONG_KEY",r}return CryptoJS.enc.Utf8.stringify(t)},l&&C(l),k(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10))));break;case"passthrough":k=C=(e=>e);break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+s.algorithm+'".')}return n(a),this}get app(){return this._db.app}goOnline(){return this._db.goOnline()}goOffline(){return this._db.goOffline()}ref(e){return new g(this._db.ref(e))}}}();
//# sourceMappingURL=firecrypt.min.js.map
