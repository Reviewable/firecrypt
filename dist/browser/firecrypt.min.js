!function(){"use strict";let r,e,t;function n(e){r=function r(e,t){var n=Object.keys(e);for(var i=0;i<n.length;i++){var o=n[i];if(".encrypt"===o)for(var a=Object.keys(e[o]),c=0;c<a.length;c++){var s=a[c];if("key"!==s&&"value"!==s&&"few"!==s)throw new Error("Illegal .encrypt subkey: "+a[c])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(o)||/[$]/.test(o.slice(1)))throw new Error("Illegal character in specification key: "+o);r(e[o],(t||"")+"/"+o)}switch(o.charAt(0)){case"$":if("$"===o)break;if(e.$)throw new Error("Multiple wildcard keys in specification at "+t);e.$=e[o],delete e[o];break;case".":if(".encrypt"!==o)throw new Error("Unknown directive at "+t+": "+o)}}return e}(e)}function i(){var r=new Error("Encryption not set up");throw r.firecrypt="NO_KEY",r}function o(r,e){return e.length+("string"==typeof r?r.length:4)}function a(e,t){t=t||r.rules,e=e.slice();for(var n=0;n<e.length&&(t=t[e[n]]||t.$);n++)t[".encrypt"]&&t[".encrypt"].key&&(e[n]=l(e[n],"string",t[".encrypt"].key));return e}function c(r,e){var t=a(e||u(r));return t.length?r.root().child(t.join("/")):r.root()}function s(r){for(var e=u(r,!0),t=!1,n=0;n<e.length;n++){var i=h(e[n]);i!==e[n]&&(e[n]=i,t=!0)}return t?r.root().child(e.join("/")):r}function p(e,t){t=t||r.rules;for(var n=0;t&&n<e.length;n++)t=t[e[n]]||t.$;return t}function y(r,e,t){return function r(e,t,n){if(!t)return e;var i=d(e);var o;if(/^(string|number|boolean)$/.test(i))t[".encrypt"]&&t[".encrypt"].value&&(e=n(e,i,t[".encrypt"].value));else if("object"===i&&null!==e){var a={};for(var c in e)if(e.hasOwnProperty(c)){var s,p=e[c];if(c.indexOf("/")>=0){var y=c.split("/");for(s=t,o=0;o<y.length;o++)n===h?(y[o]=h(y[o]),s=s&&(s[y[o]]||s.$)):(s=s&&(s[y[o]]||s.$))&&s[".encrypt"]&&s[".encrypt"].key&&(y[o]=n(y[o],"string",s[".encrypt"].key));c=y.join("/")}else n===h?(c=h(c),s=t[c]||t.$):(s=t[c]||t.$)&&s[".encrypt"]&&s[".encrypt"].key&&(c=n(c,"string",s[".encrypt"].key));a[c]=r(p,s,n)}e=a}else if("array"===i){if(!t.$)return e;for(o=0;o<e.length;o++)e[o]=r(e[o],t.$,n)}return e}(e,p(r),t)}function u(r,e){var t=r.root();if(r===t)return[];var n=decodeURIComponent(r.toString().slice(t.toString().length));if(!e&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function l(r,t,n){var i,o;if(e&&(i=t.charAt(0)+n+""+r,e.has(i)))return e.get(i);if("#"===n)o=f(r,t);else{if("string"!==t)throw new Error("Can't encrypt a "+t+" using pattern ["+n+"]");var a=r.match(function(r){var e=v[r];e||(e=v[r]=new RegExp("^"+r.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return e}(n));if(!a)throw new Error("Can't encrypt as value doesn't match pattern ["+n+"]: "+r);var c=0;o=n.replace(/[#\.]/g,function(r){var e=a[++c];return"#"===r&&(e=f(e,"string")),e})}return e&&e.set(i,o),o}function f(r,e){if(!/^(string|number|boolean)$/.test(e))throw new Error("Can't encrypt a "+e);switch(e){case"number":r=""+r;break;case"boolean":r=r?"t":"f"}return""+e.charAt(0).toUpperCase()+encryptString(r)+""}function h(r){if(t&&t.has(r))return t.get(r);if(!/\x91/.test(r))return r;var e,n=r.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var i=decryptString(n[2]);switch(n[1]){case"S":e=i;break;case"N":if((e=Number(i))!=e)throw new Error("Invalid encrypted number: "+i);break;case"B":if("t"===i)e=!0;else{if("f"!==i)throw new Error("Invalid encrypted boolean: "+i);e=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else e=r.replace(/\x91(.)([^\x92]*)\x92/g,function(r,e,t){if("S"!==e)throw new Error("Invalid multi-segment encrypted value: "+e);return decryptString(t)});return t&&t.set(r,e),e}function d(r){if(Array.isArray(r))return"array";var e=typeof r;return"object"===e&&(r instanceof String?e="string":r instanceof Number?e="number":r instanceof Boolean&&(e="boolean")),e}var v={};if("undefined"!=typeof require){"undefined"==typeof Firebase&&(global.Firebase=require("firebase")),"undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv");try{require("firebase-childrenkeys")}catch(r){}}CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};var g,_,w=Firebase.prototype,b={},k=!1;function C(r,e,t){this._query=r,this._order=e||{},this._original=t||r}function S(r){this._ref=s(r.ref()),this._path=u(this._ref),this._snap=r}function m(r,e){this._path=r,this._originalOnDisconnect=e}function E(r,e){var t=w[r];w[r]=function(){var r=u(this),n=c(this,r),i=Array.prototype.slice.call(arguments);return e>=0&&e<i.length&&(i[e]=y(r,i[e],l)),t.apply(n,i)}}function B(r,e){m.prototype[r]=function(){var t=Array.prototype.slice.call(arguments);return e>=0&&e<t.length&&(t[e]=y(this._path,t[e],l)),console.log("ARGS:",t),this._originalOnDisconnect[r].apply(this._originalOnDisconnect,t)}}function x(r){if(r&&!r.firecryptCallback){var e=function(e,t){return r.call(this,new S(e),t)};e.firecryptCallback=e,r.firecryptCallback=e}}function q(r){S.prototype[r]=function(){return this._snap[r].apply(this._snap,arguments)}}Firebase.initializeEncryption=function(r,a){var p,f;switch(r.cacheSize=r.cacheSize||5e6,r.encryptionCacheSize=r.encryptionCacheSize||r.cacheSize,r.decryptionCacheSize=r.decryptionCacheSize||r.cacheSize,g=_=i,"function"==typeof LRUCache&&(f=new LRUCache({max:r.encryptionCacheSize,length:o}),e=f,function(r){t=r}(new LRUCache({max:r.decryptionCacheSize,length:o}))),r.algorithm){case"aes-siv":if(!r.key)throw new Error("You must specify a key to use AES encryption.");p=function(r,e){var t=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(r));g=function(r){return CryptoJS.enc.Base64UrlSafe.stringify(t.encrypt(r))},_=function(r){var e=t.decrypt(CryptoJS.enc.Base64UrlSafe.parse(r));if(!1===e){var n=new Error("Wrong decryption key");throw n.firecrypt="WRONG_KEY",n}return CryptoJS.enc.Utf8.stringify(e)},e&&_(e);return g(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))}(r.key,r.keyCheckValue);break;case"passthrough":g=_=function(r){return r};break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+r.algorithm+'".')}return n(a),function(){if(k)return;E("set",0),E("update",0),r=w.push,w.push=function(){var e=r.apply(this,arguments),t=s(e);return t.then=e.then,t.catch=e.catch,e.finally&&(t.finally=e.finally),t},E("setWithPriority",0),E("setPriority"),w.childrenKeys&&function(){var r=w.childrenKeys;w.childrenKeys=function(){return r.apply(c(this),arguments).then(function(r){return r.some(function(r){return/\x91/.test(r)})?r.map(h):r})}}();var r;(function(){var r=w.transaction;w.transaction=function(){var e=u(this),t=c(this,e),n=Array.prototype.slice.call(arguments),i=n[0];if(n[0]=i&&function(r){return r=y(e,r,h),r=i(r),r=y(e,r,l)},n.length>1){var o=n[1];n[1]=o&&function(r,e,t){return o(r,e,t&&new S(t))}}return r.apply(t,n).then(function(r){return r.snapshot=r.snapshot&&new S(r.snapshot),r})}})(),function(){var r=w.onDisconnect;w.onDisconnect=function(){var e=u(this);return new m(e,r.call(c(this,e)))}}(),["on","off","once","orderByChild","orderByKey","orderByValue","orderByPriority","startAt","endAt","equalTo","limitToFirst","limitToLast","limit","ref"].forEach(function(r){!function(r){b[r]=w[r],w[r]=function(){var e=new C(c(this),{},b);return e[r].apply(e,arguments)}}(r)}),k=!0}(),p},C.prototype.on=function(r,e,t,n){return x(e),this._original.on.call(this._query,r,e.firecryptCallback,t,n)},C.prototype.off=function(r,e,t){return e&&e.firecryptCallback&&(e=e.firecryptCallback),this._original.off.call(this._query,r,e,t)},C.prototype.once=function(r,e,t,n){return x(e),this._original.once.call(this._query,r,e&&e.firecryptCallback,t,n).then(function(r){return new S(r)})},C.prototype.orderByChild=function(r){return this._orderBy("orderByChild","child",r)},C.prototype.orderByKey=function(){return this._orderBy("orderByKey","key")},C.prototype.orderByValue=function(){return this._orderBy("orderByValue","value")},C.prototype.orderByPriority=function(){return this._orderBy("orderByPriority","priority")},C.prototype.startAt=function(r,e){return this._checkCanSort(void 0!==e),this._delegate("startAt",arguments)},C.prototype.endAt=function(r,e){return this._checkCanSort(void 0!==e),this._delegate("endAt",arguments)},C.prototype.equalTo=function(r,e){return this._order[this._order.by+"Encrypted"]&&(r=l(r,d(r),this._order[this._order.by+"Encrypted"])),void 0!==e&&this._order.keyEncrypted&&(e=l(e,"string",this._order.keyEncrypted)),new C(this._original.equalTo.call(this._query,r,e),this._order)},C.prototype.limitToFirst=function(){return this._delegate("limitToFirst",arguments)},C.prototype.limitToLast=function(){return this._delegate("limitToLast",arguments)},C.prototype.limit=function(){return this._delegate("limit",arguments)},C.prototype.ref=function(){return s(this._original.ref.call(this._query))},C.prototype._delegate=function(r,e){return new C(this._original[r].apply(this._query,e),this._order)},C.prototype._checkCanSort=function(r){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||r&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")},C.prototype._orderBy=function(r,e,t){var n,i=p(u(this.ref())),o={by:e};if(i){var c=t&&t.split("/");for(var s in i)if(i.hasOwnProperty(s)){var y=i[s];if(y[".encrypt"]&&(y[".encrypt"].key&&(o.keyEncrypted=y[".encrypt"].key),y[".encrypt"].value&&(o.valueEncrypted=y[".encrypt"].value)),t){var l=p(c,y);l&&l[".encrypt"]&&l[".encrypt"].value&&(o.childEncrypted=l[".encrypt"].value);var f=a(c,y).join("/");if(n&&f!==n)throw new Error('Incompatible encryption specifications for orderByChild("'+t+'")');n=f}}}return new C(t?this._original[r].call(this._query,n||t):this._original[r].call(this._query),o)},q("exists"),q("hasChildren"),q("numChildren"),q("getPriority"),S.prototype.val=function(){return y(this._path,this._snap.val(),h)},S.prototype.child=function(r){return new S(this._snap.child(r))},S.prototype.forEach=function(r){return this._snap.forEach(function(e){return r(new S(e))})},S.prototype.hasChild=function(r){return r=a(r.split("/"),p(this._path)).join("/"),this._snap.hasChild(r)},S.prototype.key=function(){return this._ref.key()},S.prototype.name=function(){return this._ref.name()},S.prototype.ref=function(){return this._ref},S.prototype.exportVal=function(){return y(this._path,this._snap.exportVal(),h)},B("set",0),B("update",0),B("remove"),B("setWithPriority",0),B("cancel")}();
//# sourceMappingURL=firecrypt.min.js.map
