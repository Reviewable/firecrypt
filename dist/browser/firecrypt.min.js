var FireCrypt=function(){"use strict";let e,t,r,n,i;function o(t){e=function e(t,r){var n=Object.keys(t);for(var i=0;i<n.length;i++){var o=n[i];if(".encrypt"===o)for(var s=Object.keys(t[o]),c=0;c<s.length;c++){var a=s[c];if("key"!==a&&"value"!==a&&"few"!==a)throw new Error("Illegal .encrypt subkey: "+s[c])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(o)||/[$]/.test(o.slice(1)))throw new Error("Illegal character in specification key: "+o);e(t[o],(r||"")+"/"+o)}switch(o.charAt(0)){case"$":if("$"===o)break;if(t.$)throw new Error("Multiple wildcard keys in specification at "+r);t.$=t[o],delete t[o];break;case".":if(".encrypt"!==o)throw new Error("Unknown directive at "+r+": "+o)}}return t}(t)}function s(e){t=e}function c(e){r=e}function a(){var e=new Error("Encryption not set up");throw e.firecrypt="NO_KEY",e}function h(e,t){return t.length+("string"==typeof e?e.length:4)}function l(t,r){r=r||e.rules,t=t.slice();for(var n=0;n<t.length&&(r=r[t[n]]||r.$);n++)r[".encrypt"]&&r[".encrypt"].key&&(t[n]=_(t[n],"string",r[".encrypt"].key));return t}function p(e,t){var r=l(t||d(e));return r.length?e.root.child(r.join("/")):e.root}function f(e){for(var t=d(e,!0),r=!1,n=0;n<t.length;n++){var i=w(t[n]);i!==t[n]&&(t[n]=i,r=!0)}return r?e.root.child(t.join("/")):e}function u(t,r){r=r||e.rules;for(var n=0;r&&n<t.length;n++)r=r[t[n]]||r.$;return r}function y(e,t,r){return function e(t,r,n){if(!r)return t;var i=b(t);var o;if(/^(string|number|boolean)$/.test(i))r[".encrypt"]&&r[".encrypt"].value&&(t=n(t,i,r[".encrypt"].value));else if("object"===i&&null!==t){var s={};for(var c in t)if(t.hasOwnProperty(c)){var a,h=t[c];if(c.indexOf("/")>=0){var l=c.split("/");for(a=r,o=0;o<l.length;o++)n===w?(l[o]=w(l[o]),a=a&&(a[l[o]]||a.$)):(a=a&&(a[l[o]]||a.$))&&a[".encrypt"]&&a[".encrypt"].key&&(l[o]=n(l[o],"string",a[".encrypt"].key));c=l.join("/")}else n===w?(c=w(c),a=r[c]||r.$):(a=r[c]||r.$)&&a[".encrypt"]&&a[".encrypt"].key&&(c=n(c,"string",a[".encrypt"].key));s[c]=e(h,a,n)}t=s}else if("array"===i){if(!r.$)return t;for(o=0;o<t.length;o++)t[o]=e(t[o],r.$,n)}return t}(t,u(e),r)}function d(e,t){var r=e.root;if(e===r)return[];var n=decodeURIComponent(e.toString().slice(r.toString().length));if(!t&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function _(e,t,r){var i,o;if(n&&(i=t.charAt(0)+r+""+e,n.has(i)))return n.get(i);if("#"===r)o=g(e,t);else{if("string"!==t)throw new Error("Can't encrypt a "+t+" using pattern ["+r+"]");var s=e.match(function(e){var t=v[e];t||(t=v[e]=new RegExp("^"+e.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return t}(r));if(!s)throw new Error("Can't encrypt as value doesn't match pattern ["+r+"]: "+e);var c=0;o=r.replace(/[#\.]/g,function(e){var t=s[++c];return"#"===e&&(t=g(t,"string")),t})}return n&&n.set(i,o),o}function g(e,r){if(!/^(string|number|boolean)$/.test(r))throw new Error("Can't encrypt a "+r);switch(r){case"number":e=""+e;break;case"boolean":e=e?"t":"f"}return""+r.charAt(0).toUpperCase()+t(e)+""}function w(e){if(i&&i.has(e))return i.get(e);if(!/\x91/.test(e))return e;var t,n=e.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var o=r(n[2]);switch(n[1]){case"S":t=o;break;case"N":if((t=Number(o))!=t)throw new Error("Invalid encrypted number: "+o);break;case"B":if("t"===o)t=!0;else{if("f"!==o)throw new Error("Invalid encrypted boolean: "+o);t=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else t=e.replace(/\x91(.)([^\x92]*)\x92/g,function(e,t,n){if("S"!==t)throw new Error("Invalid multi-segment encrypted value: "+t);return r(n)});return i&&i.set(e,t),t}function b(e){if(Array.isArray(e))return"array";var t=typeof e;return"object"===t&&(e instanceof String?t="string":e instanceof Number?t="number":e instanceof Boolean&&(t="boolean")),t}var v={};class C{constructor(e){this._ref=f(e.ref),this._path=d(this._ref),this._snap=e,this._delegateSnapshot("exists"),this._delegateSnapshot("toJSON"),this._delegateSnapshot("hasChildren"),this._delegateSnapshot("numChildren")}_delegateSnapshot(e){this[e]=function(){return this._snap[e].apply(this._snap,arguments)}}get key(){return this._ref.key}get ref(){return new m(this._ref.ref)}val(){return y(this._path,this._snap.val(),w)}child(e){return new C(this._snap.child(e))}forEach(e){return this._snap.forEach(function(t){return e(new C(t))})}hasChild(e){return e=l(e.split("/"),u(this._path)).join("/"),this._snap.hasChild(e)}exportVal(){return y(this._path,this._snap.exportVal(),w)}}class k{constructor(e,t,r){this._query=e,this._order=t||{},this._originalRef=r||e}get ref(){return new m(f(this._query.ref))}on(e,t,r,n){return E(t),this._originalRef.on.call(this._query,e,t.firecryptCallback,r,n)}off(e,t,r){return t&&t.firecryptCallback&&(t=t.firecryptCallback),this._originalRef.off.call(this._query,e,t,r)}once(e,t,r,n){return E(t),this._originalRef.once.call(this._query,e,t&&t.firecryptCallback,r,n).then(e=>new C(e))}orderByChild(e){return this._orderBy("orderByChild","child",e)}orderByKey(){return this._orderBy("orderByKey","key")}orderByValue(){return this._orderBy("orderByValue","value")}startAt(e,t){return this._checkCanSort(void 0!==t),this._delegate("startAt",arguments)}endAt(e,t){return this._checkCanSort(void 0!==t),this._delegate("endAt",arguments)}equalTo(e,t){return this._order[this._order.by+"Encrypted"]&&(e=_(e,b(e),this._order[this._order.by+"Encrypted"])),void 0!==t&&this._order.keyEncrypted&&(t=_(t,"string",this._order.keyEncrypted)),new k(this._originalRef.equalTo.call(this._query,e,t),this._order)}limitToFirst(){return this._delegate("limitToFirst",arguments)}limitToLast(){return this._delegate("limitToLast",arguments)}limit(){return this._delegate("limit",arguments)}_delegate(e,t){return new k(this._originalRef[e].apply(this._query,t),this._order)}_checkCanSort(e){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||e&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")}_orderBy(e,t,r){const n=u(d(this.ref)),i={by:t};let o;if(n){const e=r&&r.split("/");for(const t in n){if(!n.hasOwnProperty(t))continue;const s=n[t];if(s[".encrypt"]&&(s[".encrypt"].key&&(i.keyEncrypted=s[".encrypt"].key),s[".encrypt"].value&&(i.valueEncrypted=s[".encrypt"].value)),r){const t=u(e,s);t&&t[".encrypt"]&&t[".encrypt"].value&&(i.childEncrypted=t[".encrypt"].value);const n=l(e,s).join("/");if(o&&n!==o)throw new Error('Incompatible encryption specifications for orderByChild("'+r+'")');o=n}}}return new k(r?this._originalRef[e].call(this._query,o||r):this._originalRef[e].call(this._query),i)}}function E(e){if(!e||e.firecryptCallback)return;const t=function(t,r){return e.call(this,new C(t),r)};t.firecryptCallback=t,e.firecryptCallback=t}class S{constructor(e,t){this._path=e,this._originalOnDisconnect=t,this._interceptOnDisconnectWrite("set",0),this._interceptOnDisconnectWrite("update",0),this._interceptOnDisconnectWrite("remove"),this._interceptOnDisconnectWrite("cancel")}_interceptOnDisconnectWrite(e,t){this[e]=function(){const r=Array.prototype.slice.call(arguments);return t>=0&&t<r.length&&(r[t]=y(this._path,r[t],_)),this._originalOnDisconnect[e].apply(this._originalOnDisconnect,r)}}}class m{constructor(e){this._ref=e,this._interceptPush(),this._interceptTransaction(),this._interceptOnDisconnect(),["on","off","once","orderByChild","orderByKey","orderByValue","startAt","endAt","equalTo","limitToFirst","limitToLast"].forEach(e=>{this._interceptQuery(e)}),this._interceptWrite("set",0),this._interceptWrite("remove"),this._interceptWrite("update",0),e.childrenKeys&&this._interceptChildrenKeys(e)}static get SERVER_TIMESTAMP(){return{".sv":"timestamp"}}get key(){return this._ref.key}get path(){return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length-1)}get ref(){return this._ref.isEqual(this._ref.ref)?this:new m(this._ref.ref)}get root(){return this._ref.isEqual(this._ref.root)?this:new m(this._ref.root)}get parent(){return null===this._ref.parent?null:new m(this._ref.parent)}child(e){return new m(this._ref.child(e))}toJSON(){return this._ref.toJSON()}isEqual(e){return this._ref.isEqual(e._ref)}toString(){return decodeURIComponent(this._ref.toString())}_interceptPush(){this.push=function(){const e=this._ref.push(),t=Array.prototype.slice.call(arguments);if(void 0!==t[0]){const r=p(e),n=d(e);t[0]=y(n,t[0],_),e.set.apply(r,t)}const r=new m(f(e));return r.then=e.then,r.catch=e.catch,e.finally&&(r.finally=e.finally),r}}_interceptWrite(e,t){this[e]=function(){const r=p(this._ref),n=d(this._ref),i=Array.prototype.slice.call(arguments);return t>=0&&t<i.length&&(i[t]=y(n,i[t],_)),this._ref[e].apply(r,i)}}_interceptChildrenKeys(){this.childrenKeys=function(){const e=p(this._ref);return this._ref.childrenKeys.apply(e,arguments).then(e=>e.some(e=>/\x91/.test(e))?e.map(w):e)}}_interceptOnDisconnect(){this.onDisconnect=function(){const e=p(this._ref);return new S(e,this._ref.onDisconnect.call(e))}}_interceptQuery(e){this[e]=function(){const t=p(this._ref),r=new k(t,{},this._ref);return r[e].apply(r,arguments)}}_interceptTransaction(){this.transaction=function(){const e=p(this._ref),t=d(this._ref),r=Array.prototype.slice.call(arguments),n=r[0];if(r[0]=n&&function(e){return e=y(t,e,w),e=n(e),e=y(t,e,_)},r.length>1){const e=r[1];r[1]=e&&function(t,r,n){return e(t,r,n&&new C(n))}}return this._ref.transaction.apply(e,r).then(function(e){return e.snapshot=e.snapshot&&new C(e.snapshot),e})}}}"undefined"!=typeof require&&("undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv")),CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};return class{constructor(e,t={},r={}){if("object"!=typeof e||null===e||"object"!=typeof e.app||"function"!=typeof e.ref)throw new Error(`Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got "${e}".`);if("object"!=typeof t||null===t)throw new Error(`Expected second argument passed to FireCrypt constructor to be an object, but got "${t}".`);if("object"!=typeof r||null===r)throw new Error(`Expected third argument passed to FireCrypt constructor to be an object, but got "${r}".`);var l;switch(this._db=e,t.cacheSize=t.cacheSize||5e6,t.encryptionCacheSize=t.encryptionCacheSize||t.cacheSize,t.decryptionCacheSize=t.decryptionCacheSize||t.cacheSize,s(a),c(a),"function"==typeof LRUCache&&(l=new LRUCache({max:t.encryptionCacheSize,length:h}),n=l,function(e){i=e}(new LRUCache({max:t.decryptionCacheSize,length:h}))),t.algorithm){case"aes-siv":if(!t.key)throw new Error("You must specify a key to use AES encryption.");this.encryptionKeyCheckValue=function(e,t){const r=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(e)),n=e=>CryptoJS.enc.Base64UrlSafe.stringify(r.encrypt(e)),i=e=>{const t=r.decrypt(CryptoJS.enc.Base64UrlSafe.parse(e));if(!1===t){const e=new Error("Wrong decryption key");throw e.firecrypt="WRONG_KEY",e}return CryptoJS.enc.Utf8.stringify(t)};return s(n),c(i),t&&i(t),n(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))}(t.key,t.keyCheckValue);break;case"passthrough":s(e=>e),c(e=>e);break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+t.algorithm+'".')}return o(r),()=>this}get app(){return this._db.app}goOnline(){return this._db.goOnline()}goOffline(){return this._db.goOffline()}ref(e){const t="string"==typeof e&&""!==e,r="object"==typeof e&&null!==e&&"object"==typeof e.ref&&"function"!=typeof e.ref.transaction;if(!t&&!r)throw new Error(`Expected first argument passed to ref()to be a non-empty string or a Firebase Database\n        reference, but got "${e}".`);return new m(this._db.ref(e))}}}();
//# sourceMappingURL=firecrypt.min.js.map
