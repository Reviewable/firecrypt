var firecrypt=function(t){"use strict";var e=function(t,e){this._spec=this._cleanSpecification(e),this._encryptString=this._throwNotSetUpError,this._decryptString=this._throwNotSetUpError,this._patternRegexes={},"function"==typeof LRUCache&&(this._encryptionCache=new LRUCache({max:t.encryptionCacheSize,length:this._computeCacheItemSize}),this._decryptionCache=new LRUCache({max:t.decryptionCacheSize,length:this._computeCacheItemSize}))};e.prototype._cleanSpecification=function(t,e){for(var r=0,n=Object.keys(t);r<n.length;r+=1){var i=n[r];if(".encrypt"===i)for(var o=0,c=Object.keys(t[i]);o<c.length;o+=1){var p=c[o];if("key"!==p&&"value"!==p&&"few"!==p)throw new Error("Illegal .encrypt subkey: "+p)}else{if(/[\x00-\x1f\x7f\x91\x92.#[\]/]/.test(i)||/[$]/.test(i.slice(1)))throw new Error("Illegal character in specification key: "+i);this._cleanSpecification(t[i],(e||"")+"/"+i)}switch(i.charAt(0)){case"$":if("$"===i)break;if(t.$)throw new Error("Multiple wildcard keys in specification at "+e);t.$=t[i],delete t[i];break;case".":if(".encrypt"!==i)throw new Error("Unknown directive at "+e+": "+i)}}return t},e.prototype._throwNotSetUpError=function(){var t=new Error("Encryption not set up");throw t.firecrypt="NO_KEY",t},e.prototype._computeCacheItemSize=function(t,e){return e.length+("string"==typeof t?t.length:4)},e.prototype.setStringEncryptionFunctions=function(t,e){this._encryptString=t,this._decryptString=e},e.prototype.encryptPath=function(t,e){e=e||this._spec.rules,t=t.slice();for(var r=0;r<t.length&&(e=e[t[r]]||e.$);r++)e[".encrypt"]&&e[".encrypt"].key&&(t[r]=this.encrypt(t[r],"string",e[".encrypt"].key));return t},e.prototype.encryptRef=function(t,e){var r=this.encryptPath(e||this.refToPath(t));return r.length?t.root.child(r.join("/")):t.root},e.prototype.decryptRef=function(t){for(var e=this.refToPath(t,!0),r=!1,n=0;n<e.length;n++){var i=this.decrypt(e[n]);i!==e[n]&&(e[n]=i,r=!0)}return r?t.root.child(e.join("/")):t},e.prototype.specForPath=function(t,e){e=e||this._spec.rules;for(var r=0;e&&r<t.length;r++)e=e[t[r]]||e.$;return e},e.prototype.transformValue=function(t,e,r){if("encrypt"!==r&&"decrypt"!==r)throw new Error('Transform type must be either "encrypt" or "decrypt", but got "'+r+'".');var n="encrypt"===r?this.encrypt.bind(this):this.decrypt.bind(this);return this.transformTree(e,this.specForPath(t),n)},e.prototype.transformTree=function(t,e,r){if(!e)return t;var n,i=this.getType(t);if(/^(string|number|boolean)$/.test(i))e[".encrypt"]&&e[".encrypt"].value&&(t=r(t,i,e[".encrypt"].value));else if("object"===i&&null!==t){var o={};for(var c in t)if(t.hasOwnProperty(c)){var p=t[c],s=void 0;if(c.indexOf("/")>=0){var a=c.split("/");for(s=e,n=0;n<a.length;n++)r===this.decrypt?(a[n]=this.decrypt(a[n]),s=s&&(s[a[n]]||s.$)):(s=s&&(s[a[n]]||s.$))&&s[".encrypt"]&&s[".encrypt"].key&&(a[n]=r(a[n],"string",s[".encrypt"].key));c=a.join("/")}else r===this.decrypt?s=e[c=this.decrypt(c)]||e.$:(s=e[c]||e.$)&&s[".encrypt"]&&s[".encrypt"].key&&(c=r(c,"string",s[".encrypt"].key));o[c]=this.transformTree(p,s,r)}t=o}else if("array"===i){if(!e.$)return t;for(n=0;n<t.length;n++)t[n]=this.transformTree(t[n],e.$,r)}return t},e.prototype.refToPath=function(t,e){var r=t.root;if(t===r)return[];var n=decodeURIComponent(t.toString().slice(r.toString().length));if(!e&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92.#$[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")},e.prototype.encrypt=function(t,e,r){var n,i,o=this;if(this._encryptionCache&&(n=e.charAt(0)+r+""+t,this._encryptionCache.has(n)))return this._encryptionCache.get(n);if("#"===r)i=this.encryptValue(t,e);else{if("string"!==e)throw new Error("Can't encrypt a "+e+" using pattern ["+r+"]");var c=t.match(this.compilePattern(r));if(!c)throw new Error("Can't encrypt as value doesn't match pattern ["+r+"]: "+t);var p=0;i=r.replace(/[#.]/g,function(t){var e=c[++p];return"#"===t&&(e=o.encryptValue(e,"string")),e})}return this._encryptionCache&&this._encryptionCache.set(n,i),i},e.prototype.encryptValue=function(t,e){if(!/^(string|number|boolean)$/.test(e))throw new Error("Can't encrypt a "+e);switch(e){case"number":t=""+t;break;case"boolean":t=t?"t":"f"}return""+e.charAt(0).toUpperCase()+this._encryptString(t)+""},e.prototype.decrypt=function(t){var e,r=this;if(this._decryptionCache&&this._decryptionCache.has(t))return this._decryptionCache.get(t);if(!/\x91/.test(t))return t;var n=t.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var i=this._decryptString(n[2]);switch(n[1]){case"S":e=i;break;case"N":if((e=Number(i))!=e)throw new Error("Invalid encrypted number: "+i);break;case"B":if("t"===i)e=!0;else{if("f"!==i)throw new Error("Invalid encrypted boolean: "+i);e=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else e=t.replace(/\x91(.)([^\x92]*)\x92/g,function(t,e,n){if("S"!==e)throw new Error("Invalid multi-segment encrypted value: "+e);return r._decryptString(n)});return this._decryptionCache&&this._decryptionCache.set(t,e),e},e.prototype.getType=function(t){if(Array.isArray(t))return"array";var e=typeof t;return"object"===e&&(t instanceof String?e="string":t instanceof Number?e="number":t instanceof Boolean&&(e="boolean")),e},e.prototype.compilePattern=function(t){var e=this._patternRegexes[t];return e||(e=this._patternRegexes[t]=new RegExp("^"+t.replace(/\./g,"#").replace(/[-[\]/{}()*+?.\\^$|]/g,"\\$&").replace(/#/g,"(.*?)")+"$")),e};var r=function(t,e){this._ref=e.decryptRef(t.ref),this._path=e.refToPath(this._ref),this._snap=t,this._crypto=e},n={key:{configurable:!0},ref:{configurable:!0}};n.key.get=function(){return this._ref.key},n.ref.get=function(){return new s(this._ref.ref,this._crypto)},r.prototype.val=function(){return this._crypto.transformValue(this._path,this._snap.val(),"decrypt")},r.prototype.child=function(t){return new r(this._snap.child(t),this._crypto)},r.prototype.forEach=function(t){var e=this;return this._snap.forEach(function(n){return t(new r(n),e._crypto)})},r.prototype.exists=function(){return this._snap.exists.apply(this._snap,arguments)},r.prototype.hasChild=function(t){return t=this._crypto.encryptPath(t.split("/"),this._crypto.specForPath(this._path)).join("/"),this._snap.hasChild(t)},r.prototype.hasChildren=function(){return this._snap.hasChildren.apply(this._snap,arguments)},r.prototype.numChildren=function(){return this._snap.numChildren.apply(this._snap,arguments)},r.prototype.toJSON=function(){var t=this._snap.toJSON.apply(this._snap,arguments);return this._crypto.transformValue(this._path,t,"decrypt")},Object.defineProperties(r.prototype,n);var i=function(t,e,r,n){this._query=t,this._order=e||{},this._originalRef=r||t,this._crypto=n},o={ref:{configurable:!0}};i.prototype._wrapQueryCallback=function(t){if(t&&!t.firecryptCallback){var e=this,n=function(n,i){return t.call(this,new r(n,e._crypto),i,e._crypto)};n.firecryptCallback=n,t.firecryptCallback=n}},o.ref.get=function(){return new s(this._crypto.decryptRef(this._query.ref),this._crypto)},i.prototype.on=function(t,e,r,n){return this._wrapQueryCallback(e),this._originalRef.on.call(this._query,t,e.firecryptCallback,r,n)},i.prototype.off=function(t,e,r){return e&&e.firecryptCallback&&(e=e.firecryptCallback),this._originalRef.off.call(this._query,t,e,r)},i.prototype.once=function(t,e,n,i){var o=this;return this._wrapQueryCallback(e),this._originalRef.once.call(this._query,t,e&&e.firecryptCallback,n,i).then(function(t){return new r(t,o._crypto)})},i.prototype.orderByChild=function(t){return this._orderBy("orderByChild","child",t)},i.prototype.orderByKey=function(){return this._orderBy("orderByKey","key")},i.prototype.orderByValue=function(){return this._orderBy("orderByValue","value")},i.prototype.startAt=function(t,e){return this._checkCanSort(void 0!==e),this._delegate("startAt",arguments)},i.prototype.endAt=function(t,e){return this._checkCanSort(void 0!==e),this._delegate("endAt",arguments)},i.prototype.equalTo=function(t,e){return this._order[this._order.by+"Encrypted"]&&(t=this._crypto.encrypt(t,this._crypto.getType(t),this._order[this._order.by+"Encrypted"])),void 0!==e&&this._order.keyEncrypted&&(e=this._crypto.encrypt(e,"string",this._order.keyEncrypted)),new i(this._originalRef.equalTo.call(this._query,t,e),this._order,this._originalRef,this._crypto)},i.prototype.limitToFirst=function(){return this._delegate("limitToFirst",arguments)},i.prototype.limitToLast=function(){return this._delegate("limitToLast",arguments)},i.prototype._delegate=function(t,e){return new i(this._originalRef[t].apply(this._query,e),this._order,this._originalRef,this._crypto)},i.prototype._checkCanSort=function(t){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||t&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")},i.prototype._orderBy=function(t,e,r){var n,o=this._crypto.specForPath(this._crypto.refToPath(this.ref)),c={by:e};if(o){var p=r&&r.split("/");for(var s in o)if(o.hasOwnProperty(s)){var a=o[s];if(a[".encrypt"]&&(a[".encrypt"].key&&(c.keyEncrypted=a[".encrypt"].key),a[".encrypt"].value&&(c.valueEncrypted=a[".encrypt"].value)),r){var y=this._crypto.specForPath(p,a);y&&y[".encrypt"]&&y[".encrypt"].value&&(c.childEncrypted=y[".encrypt"].value);var h=this._crypto.encryptPath(p,a).join("/");if(n&&h!==n)throw new Error('Incompatible encryption specifications for orderByChild("'+r+'")');n=h}}}return new i(r?this._originalRef[t].call(this._query,n||r):this._originalRef[t].call(this._query),c,this._originalRef,this._crypto)},Object.defineProperties(i.prototype,o);var c,p=function(t,e,r){this._path=t,this._crypto=r,this._originalOnDisconnect=e};p.prototype._interceptOnDisconnectWrite=function(t,e,r){var n=this;this[t]=function(){var i=Array.prototype.slice.call(e);return r>=0&&r<i.length&&(i[r]=n._crypto.transformValue(n._path,i[r],"encrypt")),n._originalOnDisconnect[t].apply(n._originalOnDisconnect,i)}},p.prototype.set=function(){return this._interceptOnDisconnectWrite("set",arguments,0)},p.prototype.update=function(){return this._interceptOnDisconnectWrite("update",arguments,0)},p.prototype.remove=function(){return this._interceptOnDisconnectWrite("remove",arguments)},p.prototype.cancel=function(){return this._interceptOnDisconnectWrite("cancel",arguments)};try{c=require("firebase-childrenkeys")}catch(t){}var s=function(t,e){this._ref=t,this._crypto=e},a={key:{configurable:!0},path:{configurable:!0},ref:{configurable:!0},root:{configurable:!0},parent:{configurable:!0},database:{configurable:!0}},y={SERVER_TIMESTAMP:{configurable:!0}};function h(t){var e=t.initializeApp(void 0,"firecrypt_init_patch"),r=e.constructor.prototype.database;Object.defineProperty(e.constructor.prototype,"database",{value:function(){var t=r.apply(this,arguments);return t.firecrypt||Object.defineProperty(t,"firecrypt",{value:new f(t)}),t.firecrypt}})}s.prototype._interceptQuery=function(t,e){var r=this._crypto.encryptRef(this._ref),n=new i(r,{},this._ref,this._crypto);return n[t].apply(n,e)},s.prototype._interceptWrite=function(t,e,r){var n=this._crypto.encryptRef(this._ref),i=Array.prototype.slice.call(e);if(r>=0&&r<i.length){var o=this._crypto.refToPath(this._ref);i[r]=this._crypto.transformValue(o,i[r],"encrypt")}return this._ref[t].apply(n,i)},y.SERVER_TIMESTAMP.get=function(){return{".sv":"timestamp"}},a.key.get=function(){return this._ref.key},a.path.get=function(){return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length-1)},a.ref.get=function(){return this._ref.isEqual(this._ref.ref)?this:new s(this._ref.ref,this._crypto)},a.root.get=function(){return this._ref.isEqual(this._ref.root)?this:new s(this._ref.root,this._crypto)},a.parent.get=function(){return null===this._ref.parent?null:new s(this._ref.parent,this._crypto)},a.database.get=function(){return this._ref.ref.database.firecrypt},s.prototype.child=function(t){return new s(this._ref.child(t),this._crypto)},s.prototype.toJSON=function(){return this._ref.toJSON()},s.prototype.isEqual=function(t){return this._ref.isEqual(t._ref)},s.prototype.toString=function(){return decodeURIComponent(this._ref.toString())},s.prototype.push=function(){var t,e=this.child(this._ref.push().key);return t=void 0===arguments[0]?Promise.resolve():e.set.apply(e,arguments),e.then=t.then.bind(t),e.catch=t.catch.bind(t),t.finally&&(e.finally=t.finally.bind(t)),e},s.prototype.set=function(){return this._interceptWrite("set",arguments,0)},s.prototype.remove=function(){return this._interceptWrite("remove",arguments)},s.prototype.update=function(){return this._interceptWrite("update",arguments,0)},s.prototype.childrenKeys=function(){for(var t=this,e=arguments.length,r=Array(e);e--;)r[e]=arguments[e];var n=this._ref.childrenKeys||c;if("function"!=typeof n)throw new Error("childrenKeys() is not implemented. You must either provide a Firebase Database Reference\n        which implements childrenKeys() or npm install the firebase-children keys libary.");var i=this._crypto.encryptRef(this._ref);return n.apply(i,[i].concat(r)).then(function(e){return e.some(function(t){return/\x91/.test(t)})?e.map(t._crypto.decrypt.bind(t._crypto)):e})},s.prototype.onDisconnect=function(){var t=this._crypto.encryptRef(this._ref);return new p(t,this._ref.onDisconnect.call(t),this._crypto)},s.prototype.on=function(){return this._interceptQuery("on",arguments)},s.prototype.off=function(){return this._interceptQuery("off",arguments)},s.prototype.once=function(){return this._interceptQuery("once",arguments)},s.prototype.orderByChild=function(){return this._interceptQuery("orderByChild",arguments)},s.prototype.orderByKey=function(){return this._interceptQuery("orderByKey",arguments)},s.prototype.orderByValue=function(){return this._interceptQuery("orderByValue",arguments)},s.prototype.startAt=function(){return this._interceptQuery("startAt",arguments)},s.prototype.endAt=function(){return this._interceptQuery("endAt",arguments)},s.prototype.equalTo=function(){return this._interceptQuery("equalTo",arguments)},s.prototype.limitToFirst=function(){return this._interceptQuery("limitToFirst",arguments)},s.prototype.limitToLast=function(){return this._interceptQuery("limitToLast",arguments)},s.prototype.transaction=function(){var t=this,e=this._crypto.encryptRef(this._ref),n=this._crypto.refToPath(this._ref),i=Array.prototype.slice.call(arguments),o=i[0];if(i[0]=o&&function(e){return e=t._crypto.transformValue(n,e,"decrypt"),e=o(e),e=t._crypto.transformValue(n,e,"encrypt")},i.length>1){var c=i[1];i[1]=c&&function(e,n,i){return c(e,n,i&&new r(i,t._crypto))}}return this._ref.transaction.apply(e,i).then(function(e){return e.snapshot=e.snapshot&&new r(e.snapshot,t._crypto),e})},Object.defineProperties(s.prototype,a),Object.defineProperties(s,y),"undefined"!=typeof require&&("undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv")),CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};var f=function(t){if(!("object"==typeof t&&null!==t)||"object"!=typeof t.app||"function"!=typeof t.ref)throw new Error('Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, but got "'+t+'".');this._db=t,this._crypto=void 0},u={app:{configurable:!0}};return f.prototype._ensureEncryptionConfigured=function(){if(void 0===this._crypto)throw new Error("Encryption for this FireCrypt reference has not been configured yet.")},f.prototype._setupAesSiv=function(t,e){var r=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(t)),n=function(t){return CryptoJS.enc.Base64UrlSafe.stringify(r.encrypt(t))},i=function(t){var e=r.decrypt(CryptoJS.enc.Base64UrlSafe.parse(t));if(!1===e){var n=new Error("Wrong decryption key");throw n.firecrypt="WRONG_KEY",n}return CryptoJS.enc.Utf8.stringify(e)};return this._crypto.setStringEncryptionFunctions(n,i),e&&i(e),n(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))},u.app.get=function(){return this._db.app},f.prototype.configureEncryption=function(t,r){if(void 0===t&&(t={}),void 0===r&&(r={}),"object"!=typeof t||null===t)throw new Error('Expected second argument passed to configureEncryption() to be an object, but got "'+t+'".');if("object"!=typeof r||null===r)throw new Error('Expected third argument passed to configureEncryption() to be an object, but got "'+r+'".');var n;switch(t.cacheSize=t.cacheSize||5e6,t.encryptionCacheSize=t.encryptionCacheSize||t.cacheSize,t.decryptionCacheSize=t.decryptionCacheSize||t.cacheSize,this._crypto=new e(t,r),t.algorithm){case"aes-siv":if(!t.key)throw new Error("You must specify a key to use AES encryption.");n=this._setupAesSiv(t.key,t.keyCheckValue);break;case"passthrough":this._crypto.setStringEncryptionFunctions(function(t){return t},function(t){return t});break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+t.algorithm+'".')}return this.encryptionKeyCheckValue=n,n},f.prototype.goOnline=function(){return this._ensureEncryptionConfigured(),this._db.goOnline()},f.prototype.goOffline=function(){return this._ensureEncryptionConfigured(),this._db.goOffline()},f.prototype.ref=function(t){if(this._ensureEncryptionConfigured(),void 0!==t&&"string"!=typeof t)throw new Error('Expected first argument passed to ref() to be undefined or a string, but got "'+t+'".');return new s(this._db.ref(t),this._crypto)},f.prototype.refFromURL=function(t){if(this._ensureEncryptionConfigured(),"string"!=typeof t||null===t.match(/^https:\/\/.*/g))throw new Error('Expected first argument passed to refFromURL() to be a string URL, but got "'+t+'".');return new s(this._db.refFromURL(t),this._crypto)},Object.defineProperties(f.prototype,u),t.patchFirebase=function(){if("undefined"!=typeof require){var t=0;try{h(require("firebase-admin")),t++}catch(t){}try{h(require("firebase")),t++}catch(t){}if(!t)throw new Error("No Firebase SDK detected.")}else{if("undefined"==typeof firebase)throw new Error("No Firebase SDK detected.");h(firebase)}},t}({});
//# sourceMappingURL=firecrypt.min.js.map
