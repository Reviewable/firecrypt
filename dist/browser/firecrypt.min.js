!function(){"use strict";let r,e,t;function n(e){r=function r(e,t){var n=Object.keys(e);for(var i=0;i<n.length;i++){var a=n[i];if(".encrypt"===a)for(var o=Object.keys(e[a]),c=0;c<o.length;c++){var s=o[c];if("key"!==s&&"value"!==s&&"few"!==s)throw new Error("Illegal .encrypt subkey: "+o[c])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(a)||/[$]/.test(a.slice(1)))throw new Error("Illegal character in specification key: "+a);r(e[a],(t||"")+"/"+a)}switch(a.charAt(0)){case"$":if("$"===a)break;if(e.$)throw new Error("Multiple wildcard keys in specification at "+t);e.$=e[a],delete e[a];break;case".":if(".encrypt"!==a)throw new Error("Unknown directive at "+t+": "+a)}}return e}(e)}function i(){var r=new Error("Encryption not set up");throw r.firecrypt="NO_KEY",r}function a(r,e){return e.length+("string"==typeof r?r.length:4)}function o(e,t){t=t||r.rules,e=e.slice();for(var n=0;n<e.length&&(t=t[e[n]]||t.$);n++)t[".encrypt"]&&t[".encrypt"].key&&(e[n]=u(e[n],"string",t[".encrypt"].key));return e}function c(r,e){var t=o(e||y(r));return t.length?r.root().child(t.join("/")):r.root()}function s(r){for(var e=y(r,!0),t=!1,n=0;n<e.length;n++){var i=f(e[n]);i!==e[n]&&(e[n]=i,t=!0)}return t?r.root().child(e.join("/")):r}function l(e,t){t=t||r.rules;for(var n=0;t&&n<e.length;n++)t=t[e[n]]||t.$;return t}function h(r,e,t){return function r(e,t,n){if(!t)return e;var i=function(r){if(Array.isArray(r))return"array";var e=typeof r;"object"===e&&(r instanceof String?e="string":r instanceof Number?e="number":r instanceof Boolean&&(e="boolean"));return e}(e);var a;if(/^(string|number|boolean)$/.test(i))t[".encrypt"]&&t[".encrypt"].value&&(e=n(e,i,t[".encrypt"].value));else if("object"===i&&null!==e){var o={};for(var c in e)if(e.hasOwnProperty(c)){var s,l=e[c];if(c.indexOf("/")>=0){var h=c.split("/");for(s=t,a=0;a<h.length;a++)n===f?(h[a]=f(h[a]),s=s&&(s[h[a]]||s.$)):(s=s&&(s[h[a]]||s.$))&&s[".encrypt"]&&s[".encrypt"].key&&(h[a]=n(h[a],"string",s[".encrypt"].key));c=h.join("/")}else n===f?(c=f(c),s=t[c]||t.$):(s=t[c]||t.$)&&s[".encrypt"]&&s[".encrypt"].key&&(c=n(c,"string",s[".encrypt"].key));o[c]=r(l,s,n)}e=o}else if("array"===i){if(!t.$)return e;for(a=0;a<e.length;a++)e[a]=r(e[a],t.$,n)}return e}(e,l(r),t)}function y(r,e){var t=r.root();if(r===t)return[];var n=decodeURIComponent(r.toString().slice(t.toString().length));if(!e&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function u(r,t,n){var i,a;if(e&&(i=t.charAt(0)+n+""+r,e.has(i)))return e.get(i);if("#"===n)a=p(r,t);else{if("string"!==t)throw new Error("Can't encrypt a "+t+" using pattern ["+n+"]");var o=r.match(function(r){var e=d[r];e||(e=d[r]=new RegExp("^"+r.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return e}(n));if(!o)throw new Error("Can't encrypt as value doesn't match pattern ["+n+"]: "+r);var c=0;a=n.replace(/[#\.]/g,function(r){var e=o[++c];return"#"===r&&(e=p(e,"string")),e})}return e&&e.set(i,a),a}function p(r,e){if(!/^(string|number|boolean)$/.test(e))throw new Error("Can't encrypt a "+e);switch(e){case"number":r=""+r;break;case"boolean":r=r?"t":"f"}return""+e.charAt(0).toUpperCase()+encryptString(r)+""}function f(r){if(t&&t.has(r))return t.get(r);if(!/\x91/.test(r))return r;var e,n=r.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var i=decryptString(n[2]);switch(n[1]){case"S":e=i;break;case"N":if((e=Number(i))!=e)throw new Error("Invalid encrypted number: "+i);break;case"B":if("t"===i)e=!0;else{if("f"!==i)throw new Error("Invalid encrypted boolean: "+i);e=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else e=r.replace(/\x91(.)([^\x92]*)\x92/g,function(r,e,t){if("S"!==e)throw new Error("Invalid multi-segment encrypted value: "+e);return decryptString(t)});return t&&t.set(r,e),e}var d={};class g{constructor(r){this._ref=s(r.ref()),this._path=y(this._ref),this._snap=r,this._delegateSnapshot("exists"),this._delegateSnapshot("hasChildren"),this._delegateSnapshot("numChildren"),this._delegateSnapshot("getPriority")}_delegateSnapshot(r){this[r]=function(){return this._snap[r].apply(this._snap,arguments)}}val(){return h(this._path,this._snap.val(),f)}child(r){return new g(this._snap.child(r))}forEach(r){return this._snap.forEach(function(e){return r(new g(e))})}hasChild(r){return r=o(r.split("/"),l(this._path)).join("/"),this._snap.hasChild(r)}key(){return this._ref.key()}name(){return this._ref.name()}ref(){return this._ref}exportVal(){return h(this._path,this._snap.exportVal(),f)}}class _{constructor(r,e,t){this._query=r,this._order=e||{},this._original=t||r}on(r,e,t,n){return v(e),this._original.on.call(this._query,r,e.firecryptCallback,t,n)}off(r,e,t){return e&&e.firecryptCallback&&(e=e.firecryptCallback),this._original.off.call(this._query,r,e,t)}once(r,e,t,n){return v(e),this._original.once.call(this._query,r,e&&e.firecryptCallback,t,n).then(r=>new g(r))}orderByChild(r){return this._orderBy("orderByChild","child",r)}orderByKey(){return this._orderBy("orderByKey","key")}orderByValue(){return this._orderBy("orderByValue","value")}orderByPriority(){return this._orderBy("orderByPriority","priority")}startAt(r,e){return this._checkCanSort(void 0!==e),this._delegate("startAt",arguments)}endAt(r,e){return this._checkCanSort(void 0!==e),this._delegate("endAt",arguments)}equalTo(r,e){return this._order[this._order.by+"Encrypted"]&&(r=u(r,getType(r),this._order[this._order.by+"Encrypted"])),void 0!==e&&this._order.keyEncrypted&&(e=u(e,"string",this._order.keyEncrypted)),new _(this._original.equalTo.call(this._query,r,e),this._order)}limitToFirst(){return this._delegate("limitToFirst",arguments)}limitToLast(){return this._delegate("limitToLast",arguments)}limit(){return this._delegate("limit",arguments)}ref(){return s(this._original.ref.call(this._query))}_delegate(r,e){return new _(this._original[r].apply(this._query,e),this._order)}_checkCanSort(r){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||r&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")}_orderBy(r,e,t){var n,i=l(y(this.ref())),a={by:e};if(i){var c=t&&t.split("/");for(var s in i)if(i.hasOwnProperty(s)){var h=i[s];if(h[".encrypt"]&&(h[".encrypt"].key&&(a.keyEncrypted=h[".encrypt"].key),h[".encrypt"].value&&(a.valueEncrypted=h[".encrypt"].value)),t){var u=l(c,h);u&&u[".encrypt"]&&u[".encrypt"].value&&(a.childEncrypted=u[".encrypt"].value);var p=o(c,h).join("/");if(n&&p!==n)throw new Error('Incompatible encryption specifications for orderByChild("'+t+'")');n=p}}}return new _(t?this._original[r].call(this._query,n||t):this._original[r].call(this._query),a)}}function v(r){if(r&&!r.firecryptCallback){var e=function(e,t){return r.call(this,new g(e),t)};e.firecryptCallback=e,r.firecryptCallback=e}}class w{constructor(r,e){this._path=r,this._originalOnDisconnect=e,this._interceptOnDisconnectWrite("set",0),this._interceptOnDisconnectWrite("update",0),this._interceptOnDisconnectWrite("remove"),this._interceptOnDisconnectWrite("setWithPriority",0),this._interceptOnDisconnectWrite("cancel")}_interceptOnDisconnectWrite(r,e){this[r]=function(){const t=Array.prototype.slice.call(arguments);return e>=0&&e<t.length&&(t[e]=h(this._path,t[e],u)),this._originalOnDisconnect[r].apply(this._originalOnDisconnect,t)}}}if("undefined"!=typeof require){"undefined"==typeof Firebase&&(global.Firebase=require("firebase")),"undefined"==typeof LRUCache&&(global.LRUCache=require("lru-cache")),"undefined"==typeof CryptoJS&&(global.CryptoJS=require("crypto-js/core")),require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv");try{require("firebase-childrenkeys")}catch(r){}}CryptoJS.enc.Base64UrlSafe={stringify:CryptoJS.enc.Base64.stringify,parse:CryptoJS.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};var b,k,C=Firebase.prototype,S={},m=!1;function E(r,e){var t=C[r];C[r]=function(){var r=y(this),n=c(this,r),i=Array.prototype.slice.call(arguments);return e>=0&&e<i.length&&(i[e]=h(r,i[e],u)),t.apply(n,i)}}Firebase.initializeEncryption=function(r,o){var l,p;switch(r.cacheSize=r.cacheSize||5e6,r.encryptionCacheSize=r.encryptionCacheSize||r.cacheSize,r.decryptionCacheSize=r.decryptionCacheSize||r.cacheSize,b=k=i,"function"==typeof LRUCache&&(p=new LRUCache({max:r.encryptionCacheSize,length:a}),e=p,function(r){t=r}(new LRUCache({max:r.decryptionCacheSize,length:a}))),r.algorithm){case"aes-siv":if(!r.key)throw new Error("You must specify a key to use AES encryption.");l=function(r,e){var t=CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(r));b=function(r){return CryptoJS.enc.Base64UrlSafe.stringify(t.encrypt(r))},k=function(r){var e=t.decrypt(CryptoJS.enc.Base64UrlSafe.parse(r));if(!1===e){var n=new Error("Wrong decryption key");throw n.firecrypt="WRONG_KEY",n}return CryptoJS.enc.Utf8.stringify(e)},e&&k(e);return b(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)))}(r.key,r.keyCheckValue);break;case"passthrough":b=k=function(r){return r};break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+r.algorithm+'".')}return n(o),function(){if(m)return;E("set",0),E("update",0),r=C.push,C.push=function(){var e=r.apply(this,arguments),t=s(e);return t.then=e.then,t.catch=e.catch,e.finally&&(t.finally=e.finally),t},E("setWithPriority",0),E("setPriority"),C.childrenKeys&&function(){var r=C.childrenKeys;C.childrenKeys=function(){return r.apply(c(this),arguments).then(function(r){return r.some(function(r){return/\x91/.test(r)})?r.map(f):r})}}();var r;(function(){var r=C.transaction;C.transaction=function(){var e=y(this),t=c(this,e),n=Array.prototype.slice.call(arguments),i=n[0];if(n[0]=i&&function(r){return r=h(e,r,f),r=i(r),r=h(e,r,u)},n.length>1){var a=n[1];n[1]=a&&function(r,e,t){return a(r,e,t&&new g(t))}}return r.apply(t,n).then(function(r){return r.snapshot=r.snapshot&&new g(r.snapshot),r})}})(),function(){var r=C.onDisconnect;C.onDisconnect=function(){var e=y(this);return new w(e,r.call(c(this,e)))}}(),["on","off","once","orderByChild","orderByKey","orderByValue","orderByPriority","startAt","endAt","equalTo","limitToFirst","limitToLast","limit","ref"].forEach(function(r){!function(r){S[r]=C[r],C[r]=function(){var e=new _(c(this),{},S);return e[r].apply(e,arguments)}}(r)}),m=!0}(),l}}();
//# sourceMappingURL=firecrypt.min.js.map
