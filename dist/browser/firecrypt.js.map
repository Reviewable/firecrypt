{"version":3,"file":"firecrypt.js","sources":["src/crypto.js","src/FireCryptSnapshot.js","src/FireCryptQuery.js","src/FireCryptOnDisconnect.js","src/FireCryptReference.js","src/firecrypt.js"],"sourcesContent":["let _spec;\nlet _encryptString;\nlet _decryptString;\nlet _encryptionCache;\nlet _decryptionCache;\n\nexport function setSpec(spec) {\n  _spec = cleanSpecification(spec);\n}\n\nexport function setStringEncryptionFunctions(encryptString, decryptString) {\n  _encryptString = encryptString;\n  _decryptString = decryptString;\n}\n\nexport function setEncryptionCache(cache) {\n  _encryptionCache = cache;\n}\n\nexport function setDecryptionCache(cache) {\n  _decryptionCache = cache;\n}\n\nexport function cleanSpecification(def, path) {\n  var keys = Object.keys(def);\n  for (var i = 0; i < keys.length; i++) {\n    var key = keys[i];\n    if (key === '.encrypt') {\n      var encryptKeys = Object.keys(def[key]);\n      for (var j = 0; j < encryptKeys.length; j++) {\n        var encryptKey = encryptKeys[j];\n        if (encryptKey !== 'key' && encryptKey !== 'value' && encryptKey !== 'few') {\n          throw new Error('Illegal .encrypt subkey: ' + encryptKeys[j]);\n        }\n      }\n    } else {\n      if (/[\\x00-\\x1f\\x7f\\x91\\x92\\.#\\[\\]/]/.test(key) || /[$]/.test(key.slice(1))) {\n        throw new Error('Illegal character in specification key: ' + key);\n      }\n      cleanSpecification(def[key], (path || '') + '/' + key);\n    }\n    switch (key.charAt(0)) {\n      case '$':\n        if (key === '$') break;\n        if (def.$) throw new Error('Multiple wildcard keys in specification at ' + path);\n        def.$ = def[key];\n        delete def[key];\n        break;\n      case '.':\n        if (key !== '.encrypt') throw new Error('Unknown directive at ' + path + ': ' + key);\n        break;\n    }\n  }\n  return def;\n}\n\nexport function throwNotSetUpError() {\n  var e = new Error('Encryption not set up');\n  e.firecrypt = 'NO_KEY';\n  throw e;\n}\n\nexport function computeCacheItemSize(value, key) {\n  return key.length + (typeof value === 'string' ? value.length : 4);\n}\n\nexport function encryptPath(path, def) {\n  def = def || _spec.rules;\n  path = path.slice();\n  for (var i = 0; i < path.length; i++) {\n    def = def[path[i]] || def.$;\n    if (!def) break;\n    if (def['.encrypt'] && def['.encrypt'].key) {\n      path[i] = encrypt(path[i], 'string', def['.encrypt'].key);\n    }\n  }\n  return path;\n}\n\nexport function encryptRef(ref, path) {\n  var encryptedPath = encryptPath(path || refToPath(ref));\n  return encryptedPath.length ? ref.root.child(encryptedPath.join('/')) : ref.root;\n}\n\nexport function decryptRef(ref) {\n  var path = refToPath(ref, true);\n  var changed = false;\n  for (var i = 0; i < path.length; i++) {\n    var decryptedPathSegment = decrypt(path[i]);\n    if (decryptedPathSegment !== path[i]) {\n      path[i] = decryptedPathSegment;\n      changed = true;\n    }\n  }\n  return changed ? ref.root.child(path.join('/')) : ref;\n}\n\nexport function specForPath(path, def) {\n  def = def || _spec.rules;\n  for (var i = 0; def && i < path.length; i++) {\n    def = def[path[i]] || def.$;\n  }\n  return def;\n}\n\nexport function transformValue(path, value, transform) {\n  return transformTree(value, specForPath(path), transform);\n}\n\nexport function transformTree(value, def, transform) {\n  if (!def) return value;\n  var type = getType(value);\n  var i;\n  if (/^(string|number|boolean)$/.test(type)) {\n    if (def['.encrypt'] && def['.encrypt'].value) {\n      value = transform(value, type, def['.encrypt'].value);\n    }\n  } else if (type === 'object' && value !== null) {\n    var transformedValue = {};\n    for (var key in value) {\n      if (!value.hasOwnProperty(key)) continue;\n      var subValue = value[key], subDef;\n      if (key.indexOf('/') >= 0) {  // for deep update keys\n        var keyParts = key.split('/');\n        subDef = def;\n        for (i = 0; i < keyParts.length; i++) {\n          if (transform === decrypt) {\n            keyParts[i] = decrypt(keyParts[i]);\n            subDef = subDef && (subDef[keyParts[i]] || subDef.$);\n          } else {\n            subDef = subDef && (subDef[keyParts[i]] || subDef.$);\n            if (subDef && subDef['.encrypt'] && subDef['.encrypt'].key) {\n              keyParts[i] = transform(keyParts[i], 'string', subDef['.encrypt'].key);\n            }\n          }\n        }\n        key = keyParts.join('/');\n      } else {\n        if (transform === decrypt) {\n          key = decrypt(key);\n          subDef = def[key] || def.$;\n        } else {\n          subDef = def[key] || def.$;\n          if (subDef && subDef['.encrypt'] && subDef['.encrypt'].key) {\n            key = transform(key, 'string', subDef['.encrypt'].key);\n          }\n        }\n      }\n      transformedValue[key] = transformTree(subValue, subDef, transform);\n    }\n    value = transformedValue;\n  } else if (type === 'array') {\n    if (!def.$) return value;\n    for (i = 0; i < value.length; i++) value[i] = transformTree(value[i], def.$, transform);\n  }\n  return value;\n}\n\nexport function refToPath(ref, encrypted) {\n  var root = ref.root;\n  if (ref === root) return [];\n  var pathStr = decodeURIComponent(ref.toString().slice(root.toString().length));\n  if (!encrypted && pathStr && pathStr.charAt(0) !== '.' &&\n      /[\\x00-\\x1f\\x7f\\x91\\x92\\.#$\\[\\]]/.test(pathStr)) {\n    throw new Error('Path contains invalid characters: ' + pathStr);\n  }\n  return pathStr.split('/');\n}\n\nexport function encrypt(value, type, pattern) {\n  var cacheKey;\n  if (_encryptionCache) {\n    cacheKey = type.charAt(0) + pattern + '\\x91' + value;\n    if (_encryptionCache.has(cacheKey)) return _encryptionCache.get(cacheKey);\n  }\n  var result;\n  if (pattern === '#') {\n    result = encryptValue(value, type);\n  } else {\n    if (type !== 'string') {\n      throw new Error('Can\\'t encrypt a ' + type + ' using pattern [' + pattern + ']');\n    }\n    var match = value.match(compilePattern(pattern));\n    if (!match) {\n      throw new Error(\n        'Can\\'t encrypt as value doesn\\'t match pattern [' + pattern + ']: ' + value);\n    }\n    var i = 0;\n    result = pattern.replace(/[#\\.]/g, function(placeholder) {\n      var part = match[++i];\n      if (placeholder === '#') part = encryptValue(part, 'string');\n      return part;\n    });\n  }\n  if (_encryptionCache) _encryptionCache.set(cacheKey, result);\n  return result;\n}\n\nexport function encryptValue(value, type) {\n  if (!/^(string|number|boolean)$/.test(type)) throw new Error('Can\\'t encrypt a ' + type);\n  switch (type) {\n    case 'number': value = '' + value; break;\n    case 'boolean': value = value ? 't' : 'f'; break;\n  }\n  return '\\x91' + type.charAt(0).toUpperCase() + _encryptString(value) + '\\x92';\n}\n\nexport function decrypt(value) {\n  if (_decryptionCache && _decryptionCache.has(value)) return _decryptionCache.get(value);\n  if (!/\\x91/.test(value)) return value;\n  var result;\n  var match = value.match(/^\\x91(.)([^\\x92]*)\\x92$/);\n  if (match) {\n    var decryptedString = _decryptString(match[2]);\n    switch (match[1]) {\n      case 'S':\n        result = decryptedString;\n        break;\n      case 'N':\n        result = Number(decryptedString);\n        // Check for NaN, since it's the only value where x !== x.\n        if (result !== result) throw new Error('Invalid encrypted number: ' + decryptedString);\n        break;\n      case 'B':\n        if (decryptedString === 't') result = true;\n        else if (decryptedString === 'f') result = false;\n        else throw new Error('Invalid encrypted boolean: ' + decryptedString);\n        break;\n      default:\n        throw new Error('Invalid encrypted value type code: ' + match[1]);\n    }\n  } else {\n    result = value.replace(/\\x91(.)([^\\x92]*)\\x92/g, function(match, typeCode, encryptedString) {\n      if (typeCode !== 'S') throw new Error('Invalid multi-segment encrypted value: ' + typeCode);\n      return _decryptString(encryptedString);\n    });\n  }\n  if (_decryptionCache) _decryptionCache.set(value, result);\n  return result;\n}\n\nexport function getType(value) {\n  if (Array.isArray(value)) return 'array';\n  var type = typeof value;\n  if (type === 'object') {\n    if (value instanceof String) type = 'string';\n    else if (value instanceof Number) type = 'number';\n    else if (value instanceof Boolean) type = 'boolean';\n  }\n  return type;\n}\n\nvar patternRegexes = {};\nexport function compilePattern(pattern) {\n  var regex = patternRegexes[pattern];\n  if (!regex) {\n    regex = patternRegexes[pattern] = new RegExp('^' + pattern\n      .replace(/\\./g, '#')\n      .replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, '\\\\$&')  // escape regex chars\n      .replace(/#/g, '(.*?)') + '$');\n  }\n  return regex;\n}\n","import * as crypto from './crypto';\nimport FireCryptReference from './FireCryptReference';\n\nexport default class FireCryptSnapshot {\n  constructor(snap) {\n    this._ref = crypto.decryptRef(snap.ref);\n    this._path = crypto.refToPath(this._ref);\n    this._snap = snap;\n  }\n\n  get key() {\n    return this._ref.key;\n  }\n\n  get ref() {\n    return new FireCryptReference(this._ref.ref);\n  }\n\n  val() {\n    return crypto.transformValue(this._path, this._snap.val(), crypto.decrypt);\n  }\n\n  child(childPath) {\n    return new FireCryptSnapshot(this._snap.child(childPath));\n  }\n\n  forEach(action) {\n    return this._snap.forEach(function(childSnap) {\n      return action(new FireCryptSnapshot(childSnap));\n    });\n  }\n\n  exists() {\n    return this._snap.exists.apply(this._snap, arguments)\n  }\n\n  hasChild(childPath) {\n    childPath = crypto.encryptPath(childPath.split('/'), crypto.specForPath(this._path)).join('/');\n    return this._snap.hasChild(childPath);\n  }\n\n  hasChildren() {\n    return this._snap.hasChildren.apply(this._snap, arguments)\n  }\n\n  numChildren() {\n    return this._snap.numChildren.apply(this._snap, arguments)\n  }\n\n  toJSON() {\n    const json = this._snap.toJSON.apply(this._snap, arguments);\n    return crypto.transformValue(this._path, json, crypto.decrypt);\n  }\n}\n","import * as crypto from './crypto';\nimport FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptReference from './FireCryptReference';\n\nexport default class FireCryptQuery {\n  constructor(query, order, originalRef) {\n    this._query = query;\n    this._order = order || {};\n    this._originalRef = originalRef || query;\n  }\n\n  get ref() {\n    return new FireCryptReference(crypto.decryptRef(this._query.ref));\n  }\n\n  on(eventType, callback, cancelCallback, context) {\n    wrapQueryCallback(callback);\n    return this._originalRef.on.call(\n      this._query, eventType, callback.firecryptCallback, cancelCallback, context);\n  }\n\n  off(eventType, callback, context) {\n    if (callback && callback.firecryptCallback) callback = callback.firecryptCallback;\n    return this._originalRef.off.call(this._query, eventType, callback, context);\n  }\n\n  once(eventType, successCallback, failureCallback, context) {\n    wrapQueryCallback(successCallback);\n    return this._originalRef.once.call(\n      this._query, eventType, successCallback && successCallback.firecryptCallback, failureCallback,\n      context\n    ).then((snap) => {\n      return new FireCryptSnapshot(snap);\n    });\n  }\n  \n  orderByChild(key) {\n    return this._orderBy('orderByChild', 'child', key);\n  }\n\n  orderByKey() {\n    return this._orderBy('orderByKey', 'key');\n  }\n\n  orderByValue() {\n    return this._orderBy('orderByValue', 'value');\n  }\n\n  startAt(value, key) {\n    this._checkCanSort(key !== undefined);\n    return this._delegate('startAt', arguments);\n  }\n\n  endAt(value, key) {\n    this._checkCanSort(key !== undefined);\n    return this._delegate('endAt', arguments);\n  }\n\n  equalTo(value, key) {\n    if (this._order[this._order.by + 'Encrypted']) {\n      value = crypto.encrypt(value, crypto.getType(value), this._order[this._order.by + 'Encrypted']);\n    }\n    if (key !== undefined && this._order.keyEncrypted) {\n      key = crypto.encrypt(key, 'string', this._order.keyEncrypted);\n    }\n    return new FireCryptQuery(this._originalRef.equalTo.call(this._query, value, key), this._order);\n  }\n\n  limitToFirst() {\n    return this._delegate('limitToFirst', arguments);\n  }\n\n  limitToLast() {\n    return this._delegate('limitToLast', arguments);\n  }\n\n  limit() {\n    return this._delegate('limit', arguments);\n  }\n\n  _delegate(methodName, args) {\n    return new FireCryptQuery(this._originalRef[methodName].apply(this._query, args), this._order);\n  }\n\n  _checkCanSort(hasExtraKey) {\n    if (this._order.by === 'key' ?\n        this._order.keyEncrypted :\n        this._order.valueEncrypted || hasExtraKey && this._order.keyEncrypted) {\n      throw new Error('Encrypted items cannot be ordered');\n    }\n  }\n\n  _orderBy(methodName, by, childKey) {\n    const def = crypto.specForPath(crypto.refToPath(this.ref));\n    const order = {by: by}\n\n    let encryptedChildKey;\n    if (def) {\n      const childPath = childKey && childKey.split('/');\n      for (const subKey in def) {\n        if (!def.hasOwnProperty(subKey)) continue;\n        const subDef = def[subKey];\n        if (subDef['.encrypt']) {\n          if (subDef['.encrypt'].key) order.keyEncrypted = subDef['.encrypt'].key;\n          if (subDef['.encrypt'].value) order.valueEncrypted = subDef['.encrypt'].value;\n        }\n        if (childKey) {\n          const childDef = crypto.specForPath(childPath, subDef);\n          if (childDef && childDef['.encrypt'] && childDef['.encrypt'].value) {\n            order.childEncrypted = childDef['.encrypt'].value;\n          }\n          const encryptedChildKeyCandidate = crypto.encryptPath(childPath, subDef).join('/');\n          if (encryptedChildKey && encryptedChildKeyCandidate !== encryptedChildKey) {\n            throw new Error(\n              'Incompatible encryption specifications for orderByChild(\"' + childKey + '\")');\n          }\n          encryptedChildKey = encryptedChildKeyCandidate;\n        }\n      }\n    }\n    if (childKey) {\n      return new FireCryptQuery(\n        this._originalRef[methodName].call(this._query, encryptedChildKey || childKey), order);\n    } else {\n      return new FireCryptQuery(this._originalRef[methodName].call(this._query), order);\n    }\n  }\n}\n\nfunction wrapQueryCallback(callback) {\n  if (!callback || callback.firecryptCallback) return;\n  const wrappedCallback = function(snap, previousChildKey) {\n    return callback.call(this, new FireCryptSnapshot(snap), previousChildKey);\n  };\n  wrappedCallback.firecryptCallback = wrappedCallback;\n  callback.firecryptCallback = wrappedCallback;\n}\n","import * as crypto from './crypto';\n\nexport default class FireCryptOnDisconnect {\n  constructor(path, originalOnDisconnect) {\n    this._path = path;\n    this._originalOnDisconnect = originalOnDisconnect;\n  }\n\n  _interceptOnDisconnectWrite(methodName, originalArguments, argIndex) {\n    this[methodName] = function() {\n      const args = Array.prototype.slice.call(originalArguments);\n      if (argIndex >= 0 && argIndex < args.length) {\n        args[argIndex] = crypto.transformValue(this._path, args[argIndex], crypto.encrypt);\n      }\n\n      return this._originalOnDisconnect[methodName].apply(this._originalOnDisconnect, args);\n    };\n  }\n\n  set() {\n    return this._interceptOnDisconnectWrite('set', arguments, 0);\n  }\n\n  update() {\n    return this._interceptOnDisconnectWrite('update', arguments, 0);\n  }\n\n  remove() {\n    return this._interceptOnDisconnectWrite('remove', arguments);\n  }\n\n  cancel() {\n    return this._interceptOnDisconnectWrite('cancel', arguments);\n  }\n}\n","import * as crypto from './crypto';\nimport FireCryptQuery from './FireCryptQuery';\nimport FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptOnDisconnect from './FireCryptOnDisconnect';\n\nexport default class FireCryptReference {\n  constructor(ref) {\n    this._ref = ref;\n\n    [\n      'on', 'off', 'once', 'orderByChild', 'orderByKey', 'orderByValue', 'startAt', 'endAt',\n      'equalTo', 'limitToFirst', 'limitToLast'\n    ].forEach((methodName) => {this._interceptQuery(methodName);});\n  }\n\n  /**\n   * Returns a placeholder value for auto-populating the current timestamp (time since the Unix\n   * epoch, in milliseconds) as determined by the Firebase servers.\n   * @return {Object} A timestamp placeholder value.\n   */\n  static get SERVER_TIMESTAMP() {\n    return {\n      '.sv': 'timestamp'\n    };\n  }\n\n  /**\n   * Returns the last part of this reference's path. The key of a root reference is `null`.\n   * @return {string|null} The last part this reference's path.\n   */\n  get key() {\n    return this._ref.key;\n  }\n\n  /**\n   * Returns just the path component of the reference's URL.\n   * @return {string} The path component of the Firebase URL wrapped by this reference.\n   */\n  get path() {\n    return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length - 1);\n  }\n\n  /**\n   * Returns a FireCryptReference at the same location as this query or reference.\n   * @return {FireCryptReference|null} A FireCryptReference at the same location as this query or\n   *     reference.\n   */\n  get ref() {\n    if (this._ref.isEqual(this._ref.ref)) {\n      return this;\n    } else {\n      return new FireCryptReference(this._ref.ref);\n    }\n  }\n\n  /**\n   * Returns a FireCryptReference reference to the root of the database.\n   * @return {FireCryptReference} The root reference of the database.\n   */\n  get root() {\n    if (this._ref.isEqual(this._ref.root)) {\n      return this;\n    } else {\n      return new FireCryptReference(this._ref.root);\n    }\n  }\n\n  /**\n   * Returns a FireCryptReference to the parent location of this reference. The parent of a root\n   * reference is `null`.\n   * @return {FireCryptReference|null} The parent location of this reference.\n   */\n  get parent() {\n    if (this._ref.parent === null) {\n      return null;\n    } else {\n      return new FireCryptReference(this._ref.parent);\n    }\n  }\n\n  /**\n   * Creates a new FireCryptReference object on a child of this one.\n   * @param  {string} path The path to the desired child, relative to this reference.\n   * @return {FireCryptReference} The child reference.\n   */\n  child(path) {\n    return new FireCryptReference(this._ref.child(path));\n  }\n\n  /**\n   * Returns a JSON-serializable representation of this object.\n   * @return {Object} A JSON-serializable representation of this object.\n   */\n  toJSON() {\n    return this._ref.toJSON();\n  }\n\n  /**\n   * Returns whether or not this FireCryptReference is equivalent to the provided FireCryptReference.\n   * @return {FireCryptReference} Another FireCryptReference instance against which to compare.\n   */\n  isEqual(otherRef) {\n    return this._ref.isEqual(otherRef._ref);\n  }\n\n  /**\n   * Stringifies the wrapped reference.\n   * @return {string} The Firebase URL wrapped by this FireCryptReference object.\n   */\n  toString() {\n    return decodeURIComponent(this._ref.toString());\n  }\n\n  push() {\n    const pushedRef = this._ref.push();\n\n    const args = Array.prototype.slice.call(arguments);\n    if (typeof args[0] !== 'undefined') {\n      const encryptedRef = crypto.encryptRef(pushedRef);\n      const path = crypto.refToPath(pushedRef);\n\n      args[0] = crypto.transformValue(path, args[0], crypto.encrypt);\n\n      pushedRef.set.apply(encryptedRef, args);\n    }\n\n    const decryptedPushedRef = new FireCryptReference(crypto.decryptRef(pushedRef));\n    decryptedPushedRef.then = pushedRef.then;\n    decryptedPushedRef.catch = pushedRef.catch;\n    if (pushedRef.finally) decryptedPushedRef.finally = pushedRef.finally;\n\n    return decryptedPushedRef;\n  }\n\n  _interceptWrite(methodName, originalArguments, argIndex) {\n    const encryptedRef = crypto.encryptRef(this._ref);\n    const path = crypto.refToPath(this._ref);\n\n    const args = Array.prototype.slice.call(originalArguments);\n    if (argIndex >= 0 && argIndex < args.length) {\n      args[argIndex] = crypto.transformValue(path, args[argIndex], crypto.encrypt);\n    }\n\n    return this._ref[methodName].apply(encryptedRef, args);\n  }\n\n  set() {\n    return this._interceptWrite('set', arguments, 0);\n  }\n\n  remove() {\n    return this._interceptWrite('remove', arguments);\n  }\n\n  update() {\n    return this._interceptWrite('update', arguments, 0);\n  }\n\n  childrenKeys() {\n    if (!this._ref.childrenKeys) {\n      throw new Error('childrenKeys() is not implemented.');\n    }\n\n    const encryptedRef = crypto.encryptRef(this._ref);\n    return this._ref.childrenKeys.apply(encryptedRef, arguments).then((keys) => {\n      if (!keys.some((key) => /\\x91/.test(key))) {\n        return keys;\n      }\n      return keys.map(crypto.decrypt);\n    });\n  }\n\n  onDisconnect() {\n    const encryptedRef = crypto.encryptRef(this._ref);\n    return new FireCryptOnDisconnect(encryptedRef, this._ref.onDisconnect.call(encryptedRef));\n  }\n\n  _interceptQuery(methodName) {\n    this[methodName] = function() {\n      const encryptedRef = crypto.encryptRef(this._ref);\n      const query = new FireCryptQuery(encryptedRef, {}, this._ref);\n      return query[methodName].apply(query, arguments);\n    }\n  }\n\n  transaction() {\n    const encryptedRef = crypto.encryptRef(this._ref);\n    const path = crypto.refToPath(this._ref);\n\n    const args = Array.prototype.slice.call(arguments);\n    const originalCompute = args[0];\n    args[0] = originalCompute && function(value) {\n      value = crypto.transformValue(path, value, crypto.decrypt);\n      value = originalCompute(value);\n      value = crypto.transformValue(path, value, crypto.encrypt);\n      return value;\n    };\n    if (args.length > 1) {\n      const originalOnComplete = args[1];\n      args[1] = originalOnComplete && function(error, committed, snapshot) {\n        return originalOnComplete(error, committed, snapshot && new FireCryptSnapshot(snapshot));\n      };\n    }\n    return this._ref.transaction.apply(encryptedRef, args).then(function(result) {\n      result.snapshot = result.snapshot && new FireCryptSnapshot(result.snapshot);\n      return result;\n    });\n  };\n}\n","if (typeof require !== 'undefined') {\n  if (typeof LRUCache === 'undefined') global.LRUCache = require('lru-cache');\n  if (typeof CryptoJS === 'undefined') global.CryptoJS = require('crypto-js/core');\n  require('crypto-js/enc-base64');\n  require('cryptojs-extension/build_node/siv');\n}\n\nCryptoJS.enc.Base64UrlSafe = {\n  stringify: CryptoJS.enc.Base64.stringify,\n  parse: CryptoJS.enc.Base64.parse,\n  _map: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_',\n};\n\nimport * as crypto from './crypto';\nimport FireCryptReference from './FireCryptReference';\n\nexport default class FireCrypt {\n  constructor(db, options = {}, specification = {}) {\n    const dbIsNonNullObject = typeof db === 'object' && db !== null;\n    if (!dbIsNonNullObject || typeof db.app !== 'object' || typeof db.ref !== 'function') {\n      throw new Error(\n        `Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got \"${db}\".`\n      );\n    } else if (typeof options !== 'object' || options === null) {\n      throw new Error(\n        `Expected second argument passed to FireCrypt constructor to be an object, but got \"${options}\".`\n      );\n    } else if (typeof specification !== 'object' || specification === null) {\n      throw new Error(\n        `Expected third argument passed to FireCrypt constructor to be an object, but got \"${specification}\".`\n      );\n    }\n\n    this._db = db;\n\n    options.cacheSize = options.cacheSize || 5 * 1000 * 1000;\n    options.encryptionCacheSize = options.encryptionCacheSize || options.cacheSize;\n    options.decryptionCacheSize = options.decryptionCacheSize || options.cacheSize;\n\n    crypto.setStringEncryptionFunctions(crypto.throwNotSetUpError, crypto.throwNotSetUpError);\n\n    if (typeof LRUCache === 'function') {\n      crypto.setEncryptionCache(new LRUCache({\n        max: options.encryptionCacheSize, length: crypto.computeCacheItemSize\n      }));\n      crypto.setDecryptionCache(new LRUCache({\n        max: options.decryptionCacheSize, length: crypto.computeCacheItemSize\n      }));\n    }\n\n    switch (options.algorithm) {\n      case 'aes-siv':\n        if (!options.key) throw new Error('You must specify a key to use AES encryption.');\n        this.encryptionKeyCheckValue = setupAesSiv(options.key, options.keyCheckValue);\n        break;\n      case 'passthrough':\n        crypto.setStringEncryptionFunctions((str) => str, (str) => str);\n        break;\n      case 'none':\n        break;\n      default:\n        throw new Error('Unknown encryption algorithm \"' + options.algorithm + '\".');\n    }\n\n    crypto.setSpec(specification);\n\n    return () => {\n      return this;\n    };\n  }\n\n  get app() {\n    return this._db.app;\n  }\n\n  goOnline() {\n    return this._db.goOnline();\n  }\n\n  goOffline() {\n    return this._db.goOffline();\n  }\n\n  ref(path) {\n    if (typeof path !== 'undefined' && typeof path !== 'string') {\n      throw new Error(\n        `Expected first argument passed to ref() to be undefined or a string, but got \"${path}\".`\n      );\n    }\n\n    return new FireCryptReference(this._db.ref(path));\n  }\n\n  refFromURL(url) {\n    if (typeof url !== 'string' || url.match(/^https:\\/\\/.*/g) === null) {\n      throw new Error(\n        `Expected first argument passed to refFromURL() to be a string URL, but got \"${url}\".`\n      );\n    }\n\n    return new FireCryptReference(this._db.refFromURL(path));\n  }\n}\n\nfunction setupAesSiv(key, checkValue) {\n  const siv = CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(key));\n  const encryptString = (str) => {\n    return CryptoJS.enc.Base64UrlSafe.stringify(siv.encrypt(str));\n  };\n  const decryptString = (str) => {\n    const result = siv.decrypt(CryptoJS.enc.Base64UrlSafe.parse(str));\n    if (result === false) {\n      const e = new Error('Wrong decryption key');\n      e.firecrypt = 'WRONG_KEY';\n      throw e;\n    }\n    return CryptoJS.enc.Utf8.stringify(result);\n  };\n\n  crypto.setStringEncryptionFunctions(encryptString, decryptString);\n\n  if (checkValue) decryptString(checkValue);\n  return encryptString(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)));\n}\n"],"names":["_spec","_encryptString","_decryptString","_encryptionCache","_decryptionCache","setSpec","spec","cleanSpecification","setStringEncryptionFunctions","encryptString","decryptString","setEncryptionCache","cache","setDecryptionCache","def","path","keys","Object","i","length","key","encryptKeys","j","encryptKey","Error","test","slice","charAt","$","throwNotSetUpError","e","firecrypt","computeCacheItemSize","value","encryptPath","rules","encrypt","encryptRef","ref","encryptedPath","refToPath","root","child","join","decryptRef","changed","decryptedPathSegment","decrypt","specForPath","transformValue","transform","transformTree","type","getType","transformedValue","hasOwnProperty","subValue","subDef","indexOf","keyParts","split","encrypted","pathStr","decodeURIComponent","toString","pattern","cacheKey","has","get","result","encryptValue","match","compilePattern","replace","placeholder","part","set","toUpperCase","decryptedString","Number","typeCode","encryptedString","Array","isArray","String","Boolean","patternRegexes","regex","RegExp","FireCryptSnapshot","constructor","snap","_ref","crypto","_path","_snap","FireCryptReference","val","childPath","forEach","action","childSnap","exists","apply","arguments","hasChild","hasChildren","numChildren","toJSON","json","FireCryptQuery","query","order","originalRef","_query","_order","_originalRef","on","eventType","callback","cancelCallback","context","wrapQueryCallback","call","firecryptCallback","off","once","successCallback","failureCallback","then","orderByChild","_orderBy","orderByKey","orderByValue","startAt","_checkCanSort","undefined","_delegate","endAt","equalTo","by","keyEncrypted","limitToFirst","limitToLast","limit","methodName","args","hasExtraKey","valueEncrypted","childKey","encryptedChildKey","subKey","childDef","childEncrypted","encryptedChildKeyCandidate","wrappedCallback","previousChildKey","FireCryptOnDisconnect","originalOnDisconnect","_originalOnDisconnect","_interceptOnDisconnectWrite","originalArguments","argIndex","prototype","update","remove","cancel","_interceptQuery","SERVER_TIMESTAMP","isEqual","parent","otherRef","push","pushedRef","encryptedRef","decryptedPushedRef","catch","finally","_interceptWrite","childrenKeys","some","map","onDisconnect","transaction","originalCompute","originalOnComplete","error","committed","snapshot","require","LRUCache","global","CryptoJS","enc","Base64UrlSafe","stringify","Base64","parse","_map","FireCrypt","db","options","specification","dbIsNonNullObject","app","_db","cacheSize","encryptionCacheSize","decryptionCacheSize","max","algorithm","encryptionKeyCheckValue","setupAesSiv","keyCheckValue","str","goOnline","goOffline","refFromURL","url","checkValue","siv","SIV","create","Utf8","lib","WordArray","random"],"mappings":"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"}