{"version":3,"file":"firecrypt.js","sources":["src/crypto.js","src/FireCryptSnapshot.js","src/FireCryptQuery.js","src/FireCryptOnDisconnect.js","src/FireCryptReference.js","src/firecrypt.js"],"sourcesContent":["export default class Crypto {\n  constructor(options, spec) {\n    this._spec = this._cleanSpecification(spec);\n    this._encryptString = this._throwNotSetUpError;\n    this._decryptString = this._throwNotSetUpError;\n\n    this._patternRegexes = {};\n\n    if (typeof LRUCache === 'function') {\n      this._encryptionCache = new LRUCache({\n        max: options.encryptionCacheSize,\n        length: this._computeCacheItemSize,\n      });\n      this._decryptionCache = new LRUCache({\n        max: options.decryptionCacheSize,\n        length: this._computeCacheItemSize,\n      });\n    }\n  }\n\n  _cleanSpecification(def, path) {\n    var keys = Object.keys(def);\n    for (var i = 0; i < keys.length; i++) {\n      var key = keys[i];\n      if (key === '.encrypt') {\n        var encryptKeys = Object.keys(def[key]);\n        for (var j = 0; j < encryptKeys.length; j++) {\n          var encryptKey = encryptKeys[j];\n          if (encryptKey !== 'key' && encryptKey !== 'value' && encryptKey !== 'few') {\n            throw new Error('Illegal .encrypt subkey: ' + encryptKeys[j]);\n          }\n        }\n      } else {\n        if (/[\\x00-\\x1f\\x7f\\x91\\x92\\.#\\[\\]/]/.test(key) || /[$]/.test(key.slice(1))) {\n          throw new Error('Illegal character in specification key: ' + key);\n        }\n        this._cleanSpecification(def[key], (path || '') + '/' + key);\n      }\n      switch (key.charAt(0)) {\n        case '$':\n          if (key === '$') break;\n          if (def.$) throw new Error('Multiple wildcard keys in specification at ' + path);\n          def.$ = def[key];\n          delete def[key];\n          break;\n        case '.':\n          if (key !== '.encrypt') throw new Error('Unknown directive at ' + path + ': ' + key);\n          break;\n      }\n    }\n    return def;\n  }\n\n  _throwNotSetUpError() {\n    var e = new Error('Encryption not set up');\n    e.firecrypt = 'NO_KEY';\n    throw e;\n  }\n\n  _computeCacheItemSize(value, key) {\n    return key.length + (typeof value === 'string' ? value.length : 4);\n  }\n\n  setStringEncryptionFunctions(encryptString, decryptString) {\n    this._encryptString = encryptString;\n    this._decryptString = decryptString;\n  }\n\n  encryptPath(path, def) {\n    def = def || this._spec.rules;\n    path = path.slice();\n    for (var i = 0; i < path.length; i++) {\n      def = def[path[i]] || def.$;\n      if (!def) break;\n      if (def['.encrypt'] && def['.encrypt'].key) {\n        path[i] = this.encrypt(path[i], 'string', def['.encrypt'].key);\n      }\n    }\n    return path;\n  }\n\n  encryptRef(ref, path) {\n    var encryptedPath = this.encryptPath(path || this.refToPath(ref));\n    return encryptedPath.length ? ref.root.child(encryptedPath.join('/')) : ref.root;\n  }\n\n  decryptRef(ref) {\n    var path = this.refToPath(ref, true);\n    var changed = false;\n    for (var i = 0; i < path.length; i++) {\n      var decryptedPathSegment = this.decrypt(path[i]);\n      if (decryptedPathSegment !== path[i]) {\n        path[i] = decryptedPathSegment;\n        changed = true;\n      }\n    }\n    return changed ? ref.root.child(path.join('/')) : ref;\n  }\n\n  specForPath(path, def) {\n    def = def || this._spec.rules;\n    for (var i = 0; def && i < path.length; i++) {\n      def = def[path[i]] || def.$;\n    }\n    return def;\n  }\n\n  transformValue(path, value, transformType) {\n    if (transformType !== 'encrypt' && transformType !== 'decrypt') {\n      throw new Error(\n        `Transform type must be either \"encrypt\" or \"decrypt\", but got \"${transformType}\".`\n      );\n    }\n    const transform = transformType === 'encrypt' ? this.encrypt.bind(this) : this.decrypt.bind(this);\n    return this.transformTree(value, this.specForPath(path), transform);\n  }\n\n  transformTree(value, def, transform) {\n    if (!def) return value;\n    var type = this.getType(value);\n    var i;\n    if (/^(string|number|boolean)$/.test(type)) {\n      if (def['.encrypt'] && def['.encrypt'].value) {\n        value = transform(value, type, def['.encrypt'].value);\n      }\n    } else if (type === 'object' && value !== null) {\n      var transformedValue = {};\n      for (var key in value) {\n        if (!value.hasOwnProperty(key)) continue;\n        var subValue = value[key], subDef;\n        if (key.indexOf('/') >= 0) {  // for deep update keys\n          var keyParts = key.split('/');\n          subDef = def;\n          for (i = 0; i < keyParts.length; i++) {\n            if (transform === this.decrypt) {\n              keyParts[i] = this.decrypt(keyParts[i]);\n              subDef = subDef && (subDef[keyParts[i]] || subDef.$);\n            } else {\n              subDef = subDef && (subDef[keyParts[i]] || subDef.$);\n              if (subDef && subDef['.encrypt'] && subDef['.encrypt'].key) {\n                keyParts[i] = transform(keyParts[i], 'string', subDef['.encrypt'].key);\n              }\n            }\n          }\n          key = keyParts.join('/');\n        } else {\n          if (transform === this.decrypt) {\n            key = this.decrypt(key);\n            subDef = def[key] || def.$;\n          } else {\n            subDef = def[key] || def.$;\n            if (subDef && subDef['.encrypt'] && subDef['.encrypt'].key) {\n              key = transform(key, 'string', subDef['.encrypt'].key);\n            }\n          }\n        }\n        transformedValue[key] = this.transformTree(subValue, subDef, transform);\n      }\n      value = transformedValue;\n    } else if (type === 'array') {\n      if (!def.$) return value;\n      for (i = 0; i < value.length; i++) value[i] = this.transformTree(value[i], def.$, transform);\n    }\n    return value;\n  }\n\n  refToPath(ref, encrypted) {\n    var root = ref.root;\n    if (ref === root) return [];\n    var pathStr = decodeURIComponent(ref.toString().slice(root.toString().length));\n    if (!encrypted && pathStr && pathStr.charAt(0) !== '.' &&\n        /[\\x00-\\x1f\\x7f\\x91\\x92\\.#$\\[\\]]/.test(pathStr)) {\n      throw new Error('Path contains invalid characters: ' + pathStr);\n    }\n    return pathStr.split('/');\n  }\n\n  encrypt(value, type, pattern) {\n    var cacheKey;\n    if (this._encryptionCache) {\n      cacheKey = type.charAt(0) + pattern + '\\x91' + value;\n      if (this._encryptionCache.has(cacheKey)) return this._encryptionCache.get(cacheKey);\n    }\n    var result;\n    if (pattern === '#') {\n      result = this.encryptValue(value, type);\n    } else {\n      if (type !== 'string') {\n        throw new Error('Can\\'t encrypt a ' + type + ' using pattern [' + pattern + ']');\n      }\n      var match = value.match(this.compilePattern(pattern));\n      if (!match) {\n        throw new Error(\n          'Can\\'t encrypt as value doesn\\'t match pattern [' + pattern + ']: ' + value);\n      }\n      var i = 0;\n      result = pattern.replace(/[#\\.]/g, (placeholder) => {\n        var part = match[++i];\n        if (placeholder === '#') part = this.encryptValue(part, 'string');\n        return part;\n      });\n    }\n    if (this._encryptionCache) this._encryptionCache.set(cacheKey, result);\n    return result;\n  }\n\n  encryptValue(value, type) {\n    if (!/^(string|number|boolean)$/.test(type)) throw new Error('Can\\'t encrypt a ' + type);\n    switch (type) {\n      case 'number': value = '' + value; break;\n      case 'boolean': value = value ? 't' : 'f'; break;\n    }\n    return '\\x91' + type.charAt(0).toUpperCase() + this._encryptString(value) + '\\x92';\n  }\n\n  decrypt(value) {\n    if (this._decryptionCache && this._decryptionCache.has(value)) return this._decryptionCache.get(value);\n    if (!/\\x91/.test(value)) return value;\n    var result;\n    var match = value.match(/^\\x91(.)([^\\x92]*)\\x92$/);\n    if (match) {\n      var decryptedString = this._decryptString(match[2]);\n      switch (match[1]) {\n        case 'S':\n          result = decryptedString;\n          break;\n        case 'N':\n          result = Number(decryptedString);\n          // Check for NaN, since it's the only value where x !== x.\n          if (result !== result) throw new Error('Invalid encrypted number: ' + decryptedString);\n          break;\n        case 'B':\n          if (decryptedString === 't') result = true;\n          else if (decryptedString === 'f') result = false;\n          else throw new Error('Invalid encrypted boolean: ' + decryptedString);\n          break;\n        default:\n          throw new Error('Invalid encrypted value type code: ' + match[1]);\n      }\n    } else {\n      result = value.replace(/\\x91(.)([^\\x92]*)\\x92/g, (match, typeCode, encryptedString) => {\n        if (typeCode !== 'S') throw new Error('Invalid multi-segment encrypted value: ' + typeCode);\n        return this._decryptString(encryptedString);\n      });\n    }\n    if (this._decryptionCache) this._decryptionCache.set(value, result);\n    return result;\n  }\n\n  getType(value) {\n    if (Array.isArray(value)) return 'array';\n    var type = typeof value;\n    if (type === 'object') {\n      if (value instanceof String) type = 'string';\n      else if (value instanceof Number) type = 'number';\n      else if (value instanceof Boolean) type = 'boolean';\n    }\n    return type;\n  }\n\n  compilePattern(pattern) {\n    var regex = this._patternRegexes[pattern];\n    if (!regex) {\n      regex = this._patternRegexes[pattern] = new RegExp('^' + pattern\n        .replace(/\\./g, '#')\n        .replace(/[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g, '\\\\$&')  // escape regex chars\n        .replace(/#/g, '(.*?)') + '$');\n    }\n    return regex;\n  }\n}\n","import FireCryptReference from './FireCryptReference';\n\nexport default class FireCryptSnapshot {\n  constructor(snap, crypto) {\n    this._ref = crypto.decryptRef(snap.ref);\n    this._path = crypto.refToPath(this._ref);\n    this._snap = snap;\n    this._crypto = crypto;\n\n  }\n\n  get key() {\n    return this._ref.key;\n  }\n\n  get ref() {\n    return new FireCryptReference(this._ref.ref, this._crypto);\n  }\n\n  val() {\n    return this._crypto.transformValue(this._path, this._snap.val(), 'decrypt');\n  }\n\n  child(childPath) {\n    return new FireCryptSnapshot(this._snap.child(childPath), this._crypto);\n  }\n\n  forEach(action) {\n    return this._snap.forEach((childSnap) => {\n      return action(new FireCryptSnapshot(childSnap), this._crypto);\n    });\n  }\n\n  exists() {\n    return this._snap.exists.apply(this._snap, arguments)\n  }\n\n  hasChild(childPath) {\n    childPath = this._crypto.encryptPath(childPath.split('/'), this._crypto.specForPath(this._path)).join('/');\n    return this._snap.hasChild(childPath);\n  }\n\n  hasChildren() {\n    return this._snap.hasChildren.apply(this._snap, arguments)\n  }\n\n  numChildren() {\n    return this._snap.numChildren.apply(this._snap, arguments)\n  }\n\n  toJSON() {\n    const json = this._snap.toJSON.apply(this._snap, arguments);\n    return this._crypto.transformValue(this._path, json, 'decrypt');\n  }\n}\n","import FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptReference from './FireCryptReference';\n\nexport default class FireCryptQuery {\n  constructor(query, order, originalRef, crypto) {\n    this._query = query;\n    this._order = order || {};\n    this._originalRef = originalRef || query;\n    this._crypto = crypto;\n  }\n\n  _wrapQueryCallback(callback) {\n    if (!callback || callback.firecryptCallback) return;\n    const self = this;\n    const wrappedCallback = function (snap, previousChildKey) {\n      return callback.call(this, new FireCryptSnapshot(snap, self._crypto), previousChildKey, self._crypto);\n    };\n    wrappedCallback.firecryptCallback = wrappedCallback;\n    callback.firecryptCallback = wrappedCallback;\n  }\n\n  get ref() {\n    return new FireCryptReference(this._crypto.decryptRef(this._query.ref), this._crypto);\n  }\n\n  on(eventType, callback, cancelCallback, context) {\n    this._wrapQueryCallback(callback);\n    return this._originalRef.on.call(\n      this._query, eventType, callback.firecryptCallback, cancelCallback, context);\n  }\n\n  off(eventType, callback, context) {\n    if (callback && callback.firecryptCallback) callback = callback.firecryptCallback;\n    return this._originalRef.off.call(this._query, eventType, callback, context);\n  }\n\n  once(eventType, successCallback, failureCallback, context) {\n    this._wrapQueryCallback(successCallback);\n    return this._originalRef.once.call(\n      this._query, eventType, successCallback && successCallback.firecryptCallback, failureCallback,\n      context\n    ).then((snap) => {\n      return new FireCryptSnapshot(snap, this._crypto);\n    });\n  }\n  \n  orderByChild(key) {\n    return this._orderBy('orderByChild', 'child', key);\n  }\n\n  orderByKey() {\n    return this._orderBy('orderByKey', 'key');\n  }\n\n  orderByValue() {\n    return this._orderBy('orderByValue', 'value');\n  }\n\n  startAt(value, key) {\n    this._checkCanSort(key !== undefined);\n    return this._delegate('startAt', arguments);\n  }\n\n  endAt(value, key) {\n    this._checkCanSort(key !== undefined);\n    return this._delegate('endAt', arguments);\n  }\n\n  equalTo(value, key) {\n    if (this._order[this._order.by + 'Encrypted']) {\n      value = this._crypto.encrypt(value, this._crypto.getType(value), this._order[this._order.by + 'Encrypted']);\n    }\n    if (key !== undefined && this._order.keyEncrypted) {\n      key = this._crypto.encrypt(key, 'string', this._order.keyEncrypted);\n    }\n    return new FireCryptQuery(this._originalRef.equalTo.call(this._query, value, key), this._order, this._originalRef, this._crypto);\n  }\n\n  limitToFirst() {\n    return this._delegate('limitToFirst', arguments);\n  }\n\n  limitToLast() {\n    return this._delegate('limitToLast', arguments);\n  }\n\n  _delegate(methodName, args) {\n    return new FireCryptQuery(this._originalRef[methodName].apply(this._query, args), this._order, this._originalRef, this._crypto);\n  }\n\n  _checkCanSort(hasExtraKey) {\n    if (this._order.by === 'key' ?\n        this._order.keyEncrypted :\n        this._order.valueEncrypted || hasExtraKey && this._order.keyEncrypted) {\n      throw new Error('Encrypted items cannot be ordered');\n    }\n  }\n\n  _orderBy(methodName, by, childKey) {\n    const def = this._crypto.specForPath(this._crypto.refToPath(this.ref));\n    const order = {by: by}\n\n    let encryptedChildKey;\n    if (def) {\n      const childPath = childKey && childKey.split('/');\n      for (const subKey in def) {\n        if (!def.hasOwnProperty(subKey)) continue;\n        const subDef = def[subKey];\n        if (subDef['.encrypt']) {\n          if (subDef['.encrypt'].key) order.keyEncrypted = subDef['.encrypt'].key;\n          if (subDef['.encrypt'].value) order.valueEncrypted = subDef['.encrypt'].value;\n        }\n        if (childKey) {\n          const childDef = this._crypto.specForPath(childPath, subDef);\n          if (childDef && childDef['.encrypt'] && childDef['.encrypt'].value) {\n            order.childEncrypted = childDef['.encrypt'].value;\n          }\n          const encryptedChildKeyCandidate = this._crypto.encryptPath(childPath, subDef).join('/');\n          if (encryptedChildKey && encryptedChildKeyCandidate !== encryptedChildKey) {\n            throw new Error(\n              'Incompatible encryption specifications for orderByChild(\"' + childKey + '\")');\n          }\n          encryptedChildKey = encryptedChildKeyCandidate;\n        }\n      }\n    }\n    if (childKey) {\n      return new FireCryptQuery(\n        this._originalRef[methodName].call(this._query, encryptedChildKey || childKey), order, this._originalRef, this._crypto);\n    } else {\n      return new FireCryptQuery(this._originalRef[methodName].call(this._query), order, this._originalRef, this._crypto);\n    }\n  }\n}\n","export default class FireCryptOnDisconnect {\n  constructor(path, originalOnDisconnect, crypto) {\n    this._path = path;\n    this._crypto = crypto;\n    this._originalOnDisconnect = originalOnDisconnect;\n  }\n\n  _interceptOnDisconnectWrite(methodName, originalArguments, argIndex) {\n    const self = this;\n\n    this[methodName] = function() {\n      const args = Array.prototype.slice.call(originalArguments);\n      if (argIndex >= 0 && argIndex < args.length) {\n        args[argIndex] = self._crypto.transformValue(self._path, args[argIndex], 'encrypt');\n      }\n\n      return self._originalOnDisconnect[methodName].apply(self._originalOnDisconnect, args);\n    };\n  }\n\n  set() {\n    return this._interceptOnDisconnectWrite('set', arguments, 0);\n  }\n\n  update() {\n    return this._interceptOnDisconnectWrite('update', arguments, 0);\n  }\n\n  remove() {\n    return this._interceptOnDisconnectWrite('remove', arguments);\n  }\n\n  cancel() {\n    return this._interceptOnDisconnectWrite('cancel', arguments);\n  }\n}\n","import FireCryptQuery from './FireCryptQuery';\nimport FireCryptSnapshot from './FireCryptSnapshot';\nimport FireCryptOnDisconnect from './FireCryptOnDisconnect';\n\nlet childrenKeysFromLib;\ntry {\n  childrenKeysFromLib = require('firebase-childrenkeys');\n} catch (e) {\n  // Library is optional, so ignore any errors from failure to load it.\n}\n\nexport default class FireCryptReference {\n  constructor(ref, crypto) {\n    this._ref = ref;\n    this._crypto = crypto;\n  }\n\n  _interceptQuery(methodName, originalArguments) {\n    const encryptedRef = this._crypto.encryptRef(this._ref);\n    const query = new FireCryptQuery(encryptedRef, {}, this._ref, this._crypto);\n    return query[methodName].apply(query, originalArguments);\n  }\n\n  _interceptWrite(methodName, originalArguments, argIndex) {\n    const encryptedRef = this._crypto.encryptRef(this._ref);\n\n    const args = Array.prototype.slice.call(originalArguments);\n    if (argIndex >= 0 && argIndex < args.length) {\n      const path = this._crypto.refToPath(this._ref);\n      args[argIndex] = this._crypto.transformValue(path, args[argIndex], 'encrypt');\n    }\n\n    return this._ref[methodName].apply(encryptedRef, args);\n  }\n\n  /**\n   * Returns a placeholder value for auto-populating the current timestamp (time since the Unix\n   * epoch, in milliseconds) as determined by the Firebase servers.\n   * @return {Object} A timestamp placeholder value.\n   */\n  static get SERVER_TIMESTAMP() {\n    return {\n      '.sv': 'timestamp'\n    };\n  }\n\n  /**\n   * Returns the last part of this reference's path. The key of a root reference is `null`.\n   * @return {string|null} The last part this reference's path.\n   */\n  get key() {\n    return this._ref.key;\n  }\n\n  /**\n   * Returns just the path component of the reference's URL.\n   * @return {string} The path component of the Firebase URL wrapped by this reference.\n   */\n  get path() {\n    return decodeURIComponent(this._ref.toString()).slice(this._ref.root.toString().length - 1);\n  }\n\n  /**\n   * Returns a FireCryptReference at the same location as this query or reference.\n   * @return {FireCryptReference|null} A FireCryptReference at the same location as this query or\n   *     reference.\n   */\n  get ref() {\n    if (this._ref.isEqual(this._ref.ref)) {\n      return this;\n    } else {\n      return new FireCryptReference(this._ref.ref, this._crypto);\n    }\n  }\n\n  /**\n   * Returns a FireCryptReference reference to the root of the database.\n   * @return {FireCryptReference} The root reference of the database.\n   */\n  get root() {\n    if (this._ref.isEqual(this._ref.root)) {\n      return this;\n    } else {\n      return new FireCryptReference(this._ref.root, this._crypto);\n    }\n  }\n\n  /**\n   * Returns a FireCryptReference to the parent location of this reference. The parent of a root\n   * reference is `null`.\n   * @return {FireCryptReference|null} The parent location of this reference.\n   */\n  get parent() {\n    if (this._ref.parent === null) {\n      return null;\n    } else {\n      return new FireCryptReference(this._ref.parent, this._crypto);\n    }\n  }\n\n  /**\n   * Returns the FireCrypt instance associated with this reference.\n   * @return {FireCrypt} The FireCrypt instance associated with this reference.\n   */\n  get database() {\n    return this._ref.ref.database.firecrypt;\n  }\n\n  /**\n   * Creates a new FireCryptReference object on a child of this one.\n   * @param  {string} path The path to the desired child, relative to this reference.\n   * @return {FireCryptReference} The child reference.\n   */\n  child(path) {\n    return new FireCryptReference(this._ref.child(path), this._crypto);\n  }\n\n  /**\n   * Returns a JSON-serializable representation of this object.\n   * @return {Object} A JSON-serializable representation of this object.\n   */\n  toJSON() {\n    return this._ref.toJSON();\n  }\n\n  /**\n   * Returns whether or not this FireCryptReference is equivalent to the provided FireCryptReference.\n   * @return {FireCryptReference} Another FireCryptReference instance against which to compare.\n   */\n  isEqual(otherRef) {\n    return this._ref.isEqual(otherRef._ref);\n  }\n\n  /**\n   * Stringifies the wrapped reference.\n   * @return {string} The Firebase URL wrapped by this FireCryptReference object.\n   */\n  toString() {\n    return decodeURIComponent(this._ref.toString());\n  }\n\n  push() {\n    const pushedRef = this.child(this._ref.push().key);\n\n    let promise;\n    if (typeof arguments[0] === 'undefined') {\n      // A bare pushed ref should also be thennable.\n      promise = Promise.resolve();\n    } else {\n      promise = pushedRef.set.apply(pushedRef, arguments);\n    }\n\n    pushedRef.then = promise.then.bind(promise);\n    pushedRef.catch = promise.catch.bind(promise);\n    if (promise.finally) pushedRef.finally = promise.finally.bind(promise);\n\n    return pushedRef;\n  }\n\n  set() {\n    return this._interceptWrite('set', arguments, 0);\n  }\n\n  remove() {\n    return this._interceptWrite('remove', arguments);\n  }\n\n  update() {\n    return this._interceptWrite('update', arguments, 0);\n  }\n\n  childrenKeys() {\n    const originalMethod = this._ref.childrenKeys || childrenKeysFromLib;\n\n    if (typeof originalMethod !== 'function') {\n      throw new Error(\n        `childrenKeys() is not implemented. You must either provide a Firebase Database Reference\n        which implements childrenKeys() or npm install the firebase-children keys libary.`\n      );\n    }\n\n    const encryptedRef = this._crypto.encryptRef(this._ref);\n    return originalMethod.apply(encryptedRef, [encryptedRef, ...arguments]).then((keys) => {\n      if (!keys.some((key) => /\\x91/.test(key))) {\n        return keys;\n      }\n      return keys.map(this._crypto.decrypt.bind(this._crypto));\n    });\n  }\n\n  onDisconnect() {\n    const encryptedRef = this._crypto.encryptRef(this._ref);\n    return new FireCryptOnDisconnect(encryptedRef, this._ref.onDisconnect.call(encryptedRef), this._crypto);\n  }\n\n  on() {\n    return this._interceptQuery('on', arguments);\n  }\n\n  off() {\n    return this._interceptQuery('off', arguments);\n  }\n\n  once() {\n    return this._interceptQuery('once', arguments);\n  }\n\n  orderByChild() {\n    return this._interceptQuery('orderByChild', arguments);\n  }\n\n  orderByKey() {\n    return this._interceptQuery('orderByKey', arguments);\n  }\n\n  orderByValue() {\n    return this._interceptQuery('orderByValue', arguments);\n  }\n\n  startAt() {\n    return this._interceptQuery('startAt', arguments);\n  }\n\n  endAt() {\n    return this._interceptQuery('endAt', arguments);\n  }\n\n  equalTo() {\n    return this._interceptQuery('equalTo', arguments);\n  }\n\n  limitToFirst() {\n    return this._interceptQuery('limitToFirst', arguments);\n  }\n\n  limitToLast() {\n    return this._interceptQuery('limitToLast', arguments);\n  }\n\n  transaction() {\n    const encryptedRef = this._crypto.encryptRef(this._ref);\n    const path = this._crypto.refToPath(this._ref);\n\n    const args = Array.prototype.slice.call(arguments);\n    const originalCompute = args[0];\n    args[0] = originalCompute && ((value) => {\n      value = this._crypto.transformValue(path, value, 'decrypt');\n      value = originalCompute(value);\n      value = this._crypto.transformValue(path, value, 'encrypt');\n      return value;\n    });\n    if (args.length > 1) {\n      const originalOnComplete = args[1];\n      args[1] = originalOnComplete && ((error, committed, snapshot) => {\n        return originalOnComplete(error, committed, snapshot && new FireCryptSnapshot(snapshot, this._crypto));\n      });\n    }\n    return this._ref.transaction.apply(encryptedRef, args).then((result) => {\n      result.snapshot = result.snapshot && new FireCryptSnapshot(result.snapshot, this._crypto);\n      return result;\n    });\n  };\n}\n","const patchFirebaseDatabaseApi = (fb) => {\n  // We want to wrap all instances of the Firebase database() with FireCrypt.  These are always\n  // eventually instantiated via an App's database() function, so we'd like to override that.\n  // However, we can't get at the App prototype directly so instead we patch initializeApp(),\n  // which must be called for an app instance to become available, and patch the App prototype\n  // on the first call.  Once the prototype is patched, we can restore the original initializeApp.\n  const originalInitializeApp = fb.initializeApp;\n  Object.defineProperty(fb, 'initializeApp', {value: function() {\n    const app = originalInitializeApp.apply(this, arguments);\n    const originalDatabase = app.constructor.prototype.database;\n    Object.defineProperty(app.constructor.prototype, 'database', {value: function() {\n      // The database() call caches databases by URL and can return the same instance on separate\n      // calls.  Ensure that there's a 1-to-1 correspondance between database instances and\n      // FireCrypt wrappers by associating a wrapper with its underlying database.\n      const db = originalDatabase.apply(this, arguments);\n      if (!db.firecrypt) {\n        Object.defineProperty(db, 'firecrypt', {value: new FireCrypt(db)});\n      }\n      return db.firecrypt;\n    }});\n    Object.defineProperty(fb, 'initializeApp', {value: originalInitializeApp});\n    return app;\n  }, configurable: true})\n}\n\nif (typeof require !== 'undefined') {\n  if (typeof LRUCache === 'undefined') global.LRUCache = require('lru-cache');\n  if (typeof CryptoJS === 'undefined') global.CryptoJS = require('crypto-js/core');\n  require('crypto-js/enc-base64');\n  require('cryptojs-extension/build_node/siv');\n  const admin = require('firebase-admin');\n  patchFirebaseDatabaseApi(admin);\n} else if (typeof firebase !== 'undefined') {\n  patchFirebaseDatabaseApi(firebase);\n} else {\n  throw new Error('The Firebase web client SDK must be loaded before FireCrypt.')\n}\n\nCryptoJS.enc.Base64UrlSafe = {\n  stringify: CryptoJS.enc.Base64.stringify,\n  parse: CryptoJS.enc.Base64.parse,\n  _map: 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_',\n};\n\nimport Crypto from './crypto';\nimport FireCryptReference from './FireCryptReference';\n\nclass FireCrypt {\n  constructor(db) {\n    const dbIsNonNullObject = typeof db === 'object' && db !== null;\n    if (!dbIsNonNullObject || typeof db.app !== 'object' || typeof db.ref !== 'function') {\n      throw new Error(\n        `Expected first argument passed to FireCrypt constructor to be a Firebase Database instance, \n        but got \"${db}\".`\n      );\n    }\n\n    this._db = db;\n    this._crypto = undefined;\n  }\n\n  _ensureEncryptionConfigured() {\n    if (typeof this._crypto === 'undefined') {\n      throw new Error('Encryption for this FireCrypt reference has not been configured yet.');\n    }\n  }\n\n  _setupAesSiv(key, checkValue) {\n    const siv = CryptoJS.SIV.create(CryptoJS.enc.Base64.parse(key));\n    const encryptString = (str) => {\n      return CryptoJS.enc.Base64UrlSafe.stringify(siv.encrypt(str));\n    };\n    const decryptString = (str) => {\n      const result = siv.decrypt(CryptoJS.enc.Base64UrlSafe.parse(str));\n      if (result === false) {\n        const e = new Error('Wrong decryption key');\n        e.firecrypt = 'WRONG_KEY';\n        throw e;\n      }\n      return CryptoJS.enc.Utf8.stringify(result);\n    };\n  \n    this._crypto.setStringEncryptionFunctions(encryptString, decryptString);\n  \n    if (checkValue) decryptString(checkValue);\n    return encryptString(CryptoJS.enc.Base64UrlSafe.stringify(CryptoJS.lib.WordArray.random(10)));\n  }\n\n  get app() {\n    return this._db.app;\n  }\n\n  configureEncryption(options = {}, specification = {}) {\n    if (typeof options !== 'object' || options === null) {\n      throw new Error(\n        `Expected second argument passed to configureEncryption() to be an object, but got \"${options}\".`\n      );\n    } else if (typeof specification !== 'object' || specification === null) {\n      throw new Error(\n        `Expected third argument passed to configureEncryption() to be an object, but got \"${specification}\".`\n      );\n    }\n\n    options.cacheSize = options.cacheSize || 5 * 1000 * 1000;\n    options.encryptionCacheSize = options.encryptionCacheSize || options.cacheSize;\n    options.decryptionCacheSize = options.decryptionCacheSize || options.cacheSize;\n\n    this._crypto = new Crypto(options, specification);\n\n    let result;\n\n    switch (options.algorithm) {\n      case 'aes-siv':\n        if (!options.key) throw new Error('You must specify a key to use AES encryption.');\n        result = this._setupAesSiv(options.key, options.keyCheckValue);\n        break;\n      case 'passthrough':\n        this._crypto.setStringEncryptionFunctions((str) => str, (str) => str);\n        break;\n      case 'none':\n        break;\n      default:\n        throw new Error('Unknown encryption algorithm \"' + options.algorithm + '\".');\n    }\n\n    // Make the encryption key check value available off of this FireCrypt instance and therefore\n    // off of admin.database().\n    this.encryptionKeyCheckValue = result;\n\n    return result;\n  }\n\n  goOnline() {\n    this._ensureEncryptionConfigured();\n    return this._db.goOnline();\n  }\n\n  goOffline() {\n    this._ensureEncryptionConfigured();\n    return this._db.goOffline();\n  }\n\n  ref(path) {\n    this._ensureEncryptionConfigured();\n\n    if (typeof path !== 'undefined' && typeof path !== 'string') {\n      throw new Error(\n        `Expected first argument passed to ref() to be undefined or a string, but got \"${path}\".`\n      );\n    }\n\n    return new FireCryptReference(this._db.ref(path), this._crypto);\n  }\n\n  refFromURL(url) {\n    this._ensureEncryptionConfigured();\n\n    if (typeof url !== 'string' || url.match(/^https:\\/\\/.*/g) === null) {\n      throw new Error(\n        `Expected first argument passed to refFromURL() to be a string URL, but got \"${url}\".`\n      );\n    }\n\n    return new FireCryptReference(this._db.refFromURL(path), this._crypto);\n  }\n}\n"],"names":["Crypto","constructor","options","spec","_spec","_cleanSpecification","_encryptString","_throwNotSetUpError","_decryptString","_patternRegexes","LRUCache","_encryptionCache","max","encryptionCacheSize","length","_computeCacheItemSize","_decryptionCache","decryptionCacheSize","def","path","keys","Object","i","key","encryptKeys","j","encryptKey","Error","test","slice","charAt","$","e","firecrypt","value","setStringEncryptionFunctions","encryptString","decryptString","encryptPath","rules","encrypt","encryptRef","ref","encryptedPath","refToPath","root","child","join","decryptRef","changed","decryptedPathSegment","decrypt","specForPath","transformValue","transformType","transform","bind","transformTree","type","getType","transformedValue","hasOwnProperty","subValue","subDef","indexOf","keyParts","split","encrypted","pathStr","decodeURIComponent","toString","pattern","cacheKey","has","get","result","encryptValue","match","compilePattern","replace","placeholder","part","set","toUpperCase","decryptedString","Number","typeCode","encryptedString","Array","isArray","String","Boolean","regex","RegExp","FireCryptSnapshot","snap","crypto","_ref","_path","_snap","_crypto","FireCryptReference","val","childPath","forEach","action","childSnap","exists","apply","arguments","hasChild","hasChildren","numChildren","toJSON","json","FireCryptQuery","query","order","originalRef","_query","_order","_originalRef","_wrapQueryCallback","callback","firecryptCallback","self","wrappedCallback","previousChildKey","call","on","eventType","cancelCallback","context","off","once","successCallback","failureCallback","then","orderByChild","_orderBy","orderByKey","orderByValue","startAt","_checkCanSort","undefined","_delegate","endAt","equalTo","by","keyEncrypted","limitToFirst","limitToLast","methodName","args","hasExtraKey","valueEncrypted","childKey","encryptedChildKey","subKey","childDef","childEncrypted","encryptedChildKeyCandidate","FireCryptOnDisconnect","originalOnDisconnect","_originalOnDisconnect","_interceptOnDisconnectWrite","originalArguments","argIndex","prototype","update","remove","cancel","childrenKeysFromLib","require","_interceptQuery","encryptedRef","_interceptWrite","SERVER_TIMESTAMP","isEqual","parent","database","otherRef","push","pushedRef","promise","Promise","resolve","catch","finally","childrenKeys","originalMethod","some","map","onDisconnect","transaction","originalCompute","originalOnComplete","error","committed","snapshot","patchFirebaseDatabaseApi","fb","originalInitializeApp","initializeApp","defineProperty","app","originalDatabase","db","FireCrypt","configurable","global","CryptoJS","admin","firebase","enc","Base64UrlSafe","stringify","Base64","parse","_map","dbIsNonNullObject","_db","_ensureEncryptionConfigured","_setupAesSiv","checkValue","siv","SIV","create","str","Utf8","lib","WordArray","random","configureEncryption","specification","cacheSize","algorithm","keyCheckValue","encryptionKeyCheckValue","goOnline","goOffline","refFromURL","url"],"mappings":";;;EAAe,MAAMA,MAAN,CAAa;EAC1BC,cAAYC,OAAZ,EAAqBC,IAArB,EAA2B;EACzB,SAAKC,KAAL,GAAa,KAAKC,mBAAL,CAAyBF,IAAzB,CAAb;EACA,SAAKG,cAAL,GAAsB,KAAKC,mBAA3B;EACA,SAAKC,cAAL,GAAsB,KAAKD,mBAA3B;;EAEA,SAAKE,eAAL,GAAuB,EAAvB;;EAEA,QAAI,OAAOC,QAAP,KAAoB,UAAxB,EAAoC;EAClC,WAAKC,gBAAL,GAAwB,IAAID,QAAJ,CAAa;EACnCE,aAAKV,QAAQW,mBADsB;EAEnCC,gBAAQ,KAAKC;EAFsB,OAAb,CAAxB;EAIA,WAAKC,gBAAL,GAAwB,IAAIN,QAAJ,CAAa;EACnCE,aAAKV,QAAQe,mBADsB;EAEnCH,gBAAQ,KAAKC;EAFsB,OAAb,CAAxB;EAID;EACF;;EAEDV,sBAAoBa,GAApB,EAAyBC,IAAzB,EAA+B;EAC7B,QAAIC,OAAOC,OAAOD,IAAP,CAAYF,GAAZ,CAAX;EACA,SAAK,IAAII,IAAI,CAAb,EAAgBA,IAAIF,KAAKN,MAAzB,EAAiCQ,GAAjC,EAAsC;EACpC,UAAIC,MAAMH,KAAKE,CAAL,CAAV;EACA,UAAIC,QAAQ,UAAZ,EAAwB;EACtB,YAAIC,cAAcH,OAAOD,IAAP,CAAYF,IAAIK,GAAJ,CAAZ,CAAlB;EACA,aAAK,IAAIE,IAAI,CAAb,EAAgBA,IAAID,YAAYV,MAAhC,EAAwCW,GAAxC,EAA6C;EAC3C,cAAIC,aAAaF,YAAYC,CAAZ,CAAjB;EACA,cAAIC,eAAe,KAAf,IAAwBA,eAAe,OAAvC,IAAkDA,eAAe,KAArE,EAA4E;EAC1E,kBAAM,IAAIC,KAAJ,CAAU,8BAA8BH,YAAYC,CAAZ,CAAxC,CAAN;EACD;EACF;EACF,OARD,MAQO;EACL,YAAI,kCAAkCG,IAAlC,CAAuCL,GAAvC,KAA+C,MAAMK,IAAN,CAAWL,IAAIM,KAAJ,CAAU,CAAV,CAAX,CAAnD,EAA6E;EAC3E,gBAAM,IAAIF,KAAJ,CAAU,6CAA6CJ,GAAvD,CAAN;EACD;EACD,aAAKlB,mBAAL,CAAyBa,IAAIK,GAAJ,CAAzB,EAAmC,CAACJ,QAAQ,EAAT,IAAe,GAAf,GAAqBI,GAAxD;EACD;EACD,cAAQA,IAAIO,MAAJ,CAAW,CAAX,CAAR;EACE,aAAK,GAAL;EACE,cAAIP,QAAQ,GAAZ,EAAiB;EACjB,cAAIL,IAAIa,CAAR,EAAW,MAAM,IAAIJ,KAAJ,CAAU,gDAAgDR,IAA1D,CAAN;EACXD,cAAIa,CAAJ,GAAQb,IAAIK,GAAJ,CAAR;EACA,iBAAOL,IAAIK,GAAJ,CAAP;EACA;EACF,aAAK,GAAL;EACE,cAAIA,QAAQ,UAAZ,EAAwB,MAAM,IAAII,KAAJ,CAAU,0BAA0BR,IAA1B,GAAiC,IAAjC,GAAwCI,GAAlD,CAAN;EACxB;EATJ;EAWD;EACD,WAAOL,GAAP;EACD;;EAEDX,wBAAsB;EACpB,QAAIyB,IAAI,IAAIL,KAAJ,CAAU,uBAAV,CAAR;EACAK,MAAEC,SAAF,GAAc,QAAd;EACA,UAAMD,CAAN;EACD;;EAEDjB,wBAAsBmB,KAAtB,EAA6BX,GAA7B,EAAkC;EAChC,WAAOA,IAAIT,MAAJ,IAAc,OAAOoB,KAAP,KAAiB,QAAjB,GAA4BA,MAAMpB,MAAlC,GAA2C,CAAzD,CAAP;EACD;;EAEDqB,+BAA6BC,aAA7B,EAA4CC,aAA5C,EAA2D;EACzD,SAAK/B,cAAL,GAAsB8B,aAAtB;EACA,SAAK5B,cAAL,GAAsB6B,aAAtB;EACD;;EAEDC,cAAYnB,IAAZ,EAAkBD,GAAlB,EAAuB;EACrBA,UAAMA,OAAO,KAAKd,KAAL,CAAWmC,KAAxB;EACApB,WAAOA,KAAKU,KAAL,EAAP;EACA,SAAK,IAAIP,IAAI,CAAb,EAAgBA,IAAIH,KAAKL,MAAzB,EAAiCQ,GAAjC,EAAsC;EACpCJ,YAAMA,IAAIC,KAAKG,CAAL,CAAJ,KAAgBJ,IAAIa,CAA1B;EACA,UAAI,CAACb,GAAL,EAAU;EACV,UAAIA,IAAI,UAAJ,KAAmBA,IAAI,UAAJ,EAAgBK,GAAvC,EAA4C;EAC1CJ,aAAKG,CAAL,IAAU,KAAKkB,OAAL,CAAarB,KAAKG,CAAL,CAAb,EAAsB,QAAtB,EAAgCJ,IAAI,UAAJ,EAAgBK,GAAhD,CAAV;EACD;EACF;EACD,WAAOJ,IAAP;EACD;;EAEDsB,aAAWC,GAAX,EAAgBvB,IAAhB,EAAsB;EACpB,QAAIwB,gBAAgB,KAAKL,WAAL,CAAiBnB,QAAQ,KAAKyB,SAAL,CAAeF,GAAf,CAAzB,CAApB;EACA,WAAOC,cAAc7B,MAAd,GAAuB4B,IAAIG,IAAJ,CAASC,KAAT,CAAeH,cAAcI,IAAd,CAAmB,GAAnB,CAAf,CAAvB,GAAiEL,IAAIG,IAA5E;EACD;;EAEDG,aAAWN,GAAX,EAAgB;EACd,QAAIvB,OAAO,KAAKyB,SAAL,CAAeF,GAAf,EAAoB,IAApB,CAAX;EACA,QAAIO,UAAU,KAAd;EACA,SAAK,IAAI3B,IAAI,CAAb,EAAgBA,IAAIH,KAAKL,MAAzB,EAAiCQ,GAAjC,EAAsC;EACpC,UAAI4B,uBAAuB,KAAKC,OAAL,CAAahC,KAAKG,CAAL,CAAb,CAA3B;EACA,UAAI4B,yBAAyB/B,KAAKG,CAAL,CAA7B,EAAsC;EACpCH,aAAKG,CAAL,IAAU4B,oBAAV;EACAD,kBAAU,IAAV;EACD;EACF;EACD,WAAOA,UAAUP,IAAIG,IAAJ,CAASC,KAAT,CAAe3B,KAAK4B,IAAL,CAAU,GAAV,CAAf,CAAV,GAA2CL,GAAlD;EACD;;EAEDU,cAAYjC,IAAZ,EAAkBD,GAAlB,EAAuB;EACrBA,UAAMA,OAAO,KAAKd,KAAL,CAAWmC,KAAxB;EACA,SAAK,IAAIjB,IAAI,CAAb,EAAgBJ,OAAOI,IAAIH,KAAKL,MAAhC,EAAwCQ,GAAxC,EAA6C;EAC3CJ,YAAMA,IAAIC,KAAKG,CAAL,CAAJ,KAAgBJ,IAAIa,CAA1B;EACD;EACD,WAAOb,GAAP;EACD;;EAEDmC,iBAAelC,IAAf,EAAqBe,KAArB,EAA4BoB,aAA5B,EAA2C;EACzC,QAAIA,kBAAkB,SAAlB,IAA+BA,kBAAkB,SAArD,EAAgE;EAC9D,YAAM,IAAI3B,KAAJ,CACH,kEAAiE2B,aAAc,IAD5E,CAAN;EAGD;EACD,UAAMC,YAAYD,kBAAkB,SAAlB,GAA8B,KAAKd,OAAL,CAAagB,IAAb,CAAkB,IAAlB,CAA9B,GAAwD,KAAKL,OAAL,CAAaK,IAAb,CAAkB,IAAlB,CAA1E;EACA,WAAO,KAAKC,aAAL,CAAmBvB,KAAnB,EAA0B,KAAKkB,WAAL,CAAiBjC,IAAjB,CAA1B,EAAkDoC,SAAlD,CAAP;EACD;;EAEDE,gBAAcvB,KAAd,EAAqBhB,GAArB,EAA0BqC,SAA1B,EAAqC;EACnC,QAAI,CAACrC,GAAL,EAAU,OAAOgB,KAAP;EACV,QAAIwB,OAAO,KAAKC,OAAL,CAAazB,KAAb,CAAX;EACA,QAAIZ,CAAJ;EACA,QAAI,4BAA4BM,IAA5B,CAAiC8B,IAAjC,CAAJ,EAA4C;EAC1C,UAAIxC,IAAI,UAAJ,KAAmBA,IAAI,UAAJ,EAAgBgB,KAAvC,EAA8C;EAC5CA,gBAAQqB,UAAUrB,KAAV,EAAiBwB,IAAjB,EAAuBxC,IAAI,UAAJ,EAAgBgB,KAAvC,CAAR;EACD;EACF,KAJD,MAIO,IAAIwB,SAAS,QAAT,IAAqBxB,UAAU,IAAnC,EAAyC;EAC9C,UAAI0B,mBAAmB,EAAvB;EACA,WAAK,IAAIrC,GAAT,IAAgBW,KAAhB,EAAuB;EACrB,YAAI,CAACA,MAAM2B,cAAN,CAAqBtC,GAArB,CAAL,EAAgC;EAChC,YAAIuC,WAAW5B,MAAMX,GAAN,CAAf;EAAA,YAA2BwC,MAA3B;EACA,YAAIxC,IAAIyC,OAAJ,CAAY,GAAZ,KAAoB,CAAxB,EAA2B;EAAG;EAC5B,cAAIC,WAAW1C,IAAI2C,KAAJ,CAAU,GAAV,CAAf;EACAH,mBAAS7C,GAAT;EACA,eAAKI,IAAI,CAAT,EAAYA,IAAI2C,SAASnD,MAAzB,EAAiCQ,GAAjC,EAAsC;EACpC,gBAAIiC,cAAc,KAAKJ,OAAvB,EAAgC;EAC9Bc,uBAAS3C,CAAT,IAAc,KAAK6B,OAAL,CAAac,SAAS3C,CAAT,CAAb,CAAd;EACAyC,uBAASA,WAAWA,OAAOE,SAAS3C,CAAT,CAAP,KAAuByC,OAAOhC,CAAzC,CAAT;EACD,aAHD,MAGO;EACLgC,uBAASA,WAAWA,OAAOE,SAAS3C,CAAT,CAAP,KAAuByC,OAAOhC,CAAzC,CAAT;EACA,kBAAIgC,UAAUA,OAAO,UAAP,CAAV,IAAgCA,OAAO,UAAP,EAAmBxC,GAAvD,EAA4D;EAC1D0C,yBAAS3C,CAAT,IAAciC,UAAUU,SAAS3C,CAAT,CAAV,EAAuB,QAAvB,EAAiCyC,OAAO,UAAP,EAAmBxC,GAApD,CAAd;EACD;EACF;EACF;EACDA,gBAAM0C,SAASlB,IAAT,CAAc,GAAd,CAAN;EACD,SAfD,MAeO;EACL,cAAIQ,cAAc,KAAKJ,OAAvB,EAAgC;EAC9B5B,kBAAM,KAAK4B,OAAL,CAAa5B,GAAb,CAAN;EACAwC,qBAAS7C,IAAIK,GAAJ,KAAYL,IAAIa,CAAzB;EACD,WAHD,MAGO;EACLgC,qBAAS7C,IAAIK,GAAJ,KAAYL,IAAIa,CAAzB;EACA,gBAAIgC,UAAUA,OAAO,UAAP,CAAV,IAAgCA,OAAO,UAAP,EAAmBxC,GAAvD,EAA4D;EAC1DA,oBAAMgC,UAAUhC,GAAV,EAAe,QAAf,EAAyBwC,OAAO,UAAP,EAAmBxC,GAA5C,CAAN;EACD;EACF;EACF;EACDqC,yBAAiBrC,GAAjB,IAAwB,KAAKkC,aAAL,CAAmBK,QAAnB,EAA6BC,MAA7B,EAAqCR,SAArC,CAAxB;EACD;EACDrB,cAAQ0B,gBAAR;EACD,KAlCM,MAkCA,IAAIF,SAAS,OAAb,EAAsB;EAC3B,UAAI,CAACxC,IAAIa,CAAT,EAAY,OAAOG,KAAP;EACZ,WAAKZ,IAAI,CAAT,EAAYA,IAAIY,MAAMpB,MAAtB,EAA8BQ,GAA9B,EAAmCY,MAAMZ,CAAN,IAAW,KAAKmC,aAAL,CAAmBvB,MAAMZ,CAAN,CAAnB,EAA6BJ,IAAIa,CAAjC,EAAoCwB,SAApC,CAAX;EACpC;EACD,WAAOrB,KAAP;EACD;;EAEDU,YAAUF,GAAV,EAAeyB,SAAf,EAA0B;EACxB,QAAItB,OAAOH,IAAIG,IAAf;EACA,QAAIH,QAAQG,IAAZ,EAAkB,OAAO,EAAP;EAClB,QAAIuB,UAAUC,mBAAmB3B,IAAI4B,QAAJ,GAAezC,KAAf,CAAqBgB,KAAKyB,QAAL,GAAgBxD,MAArC,CAAnB,CAAd;EACA,QAAI,CAACqD,SAAD,IAAcC,OAAd,IAAyBA,QAAQtC,MAAR,CAAe,CAAf,MAAsB,GAA/C,IACA,kCAAkCF,IAAlC,CAAuCwC,OAAvC,CADJ,EACqD;EACnD,YAAM,IAAIzC,KAAJ,CAAU,uCAAuCyC,OAAjD,CAAN;EACD;EACD,WAAOA,QAAQF,KAAR,CAAc,GAAd,CAAP;EACD;;EAED1B,UAAQN,KAAR,EAAewB,IAAf,EAAqBa,OAArB,EAA8B;EAC5B,QAAIC,QAAJ;EACA,QAAI,KAAK7D,gBAAT,EAA2B;EACzB6D,iBAAWd,KAAK5B,MAAL,CAAY,CAAZ,IAAiByC,OAAjB,GAA2B,MAA3B,GAAoCrC,KAA/C;EACA,UAAI,KAAKvB,gBAAL,CAAsB8D,GAAtB,CAA0BD,QAA1B,CAAJ,EAAyC,OAAO,KAAK7D,gBAAL,CAAsB+D,GAAtB,CAA0BF,QAA1B,CAAP;EAC1C;EACD,QAAIG,MAAJ;EACA,QAAIJ,YAAY,GAAhB,EAAqB;EACnBI,eAAS,KAAKC,YAAL,CAAkB1C,KAAlB,EAAyBwB,IAAzB,CAAT;EACD,KAFD,MAEO;EACL,UAAIA,SAAS,QAAb,EAAuB;EACrB,cAAM,IAAI/B,KAAJ,CAAU,sBAAsB+B,IAAtB,GAA6B,kBAA7B,GAAkDa,OAAlD,GAA4D,GAAtE,CAAN;EACD;EACD,UAAIM,QAAQ3C,MAAM2C,KAAN,CAAY,KAAKC,cAAL,CAAoBP,OAApB,CAAZ,CAAZ;EACA,UAAI,CAACM,KAAL,EAAY;EACV,cAAM,IAAIlD,KAAJ,CACJ,qDAAqD4C,OAArD,GAA+D,KAA/D,GAAuErC,KADnE,CAAN;EAED;EACD,UAAIZ,IAAI,CAAR;EACAqD,eAASJ,QAAQQ,OAAR,CAAgB,QAAhB,EAA2BC,WAAD,IAAiB;EAClD,YAAIC,OAAOJ,MAAM,EAAEvD,CAAR,CAAX;EACA,YAAI0D,gBAAgB,GAApB,EAAyBC,OAAO,KAAKL,YAAL,CAAkBK,IAAlB,EAAwB,QAAxB,CAAP;EACzB,eAAOA,IAAP;EACD,OAJQ,CAAT;EAKD;EACD,QAAI,KAAKtE,gBAAT,EAA2B,KAAKA,gBAAL,CAAsBuE,GAAtB,CAA0BV,QAA1B,EAAoCG,MAApC;EAC3B,WAAOA,MAAP;EACD;;EAEDC,eAAa1C,KAAb,EAAoBwB,IAApB,EAA0B;EACxB,QAAI,CAAC,4BAA4B9B,IAA5B,CAAiC8B,IAAjC,CAAL,EAA6C,MAAM,IAAI/B,KAAJ,CAAU,sBAAsB+B,IAAhC,CAAN;EAC7C,YAAQA,IAAR;EACE,WAAK,QAAL;EAAexB,gBAAQ,KAAKA,KAAb,CAAoB;EACnC,WAAK,SAAL;EAAgBA,gBAAQA,QAAQ,GAAR,GAAc,GAAtB,CAA2B;EAF7C;EAIA,WAAO,SAASwB,KAAK5B,MAAL,CAAY,CAAZ,EAAeqD,WAAf,EAAT,GAAwC,KAAK7E,cAAL,CAAoB4B,KAApB,CAAxC,GAAqE,MAA5E;EACD;;EAEDiB,UAAQjB,KAAR,EAAe;EACb,QAAI,KAAKlB,gBAAL,IAAyB,KAAKA,gBAAL,CAAsByD,GAAtB,CAA0BvC,KAA1B,CAA7B,EAA+D,OAAO,KAAKlB,gBAAL,CAAsB0D,GAAtB,CAA0BxC,KAA1B,CAAP;EAC/D,QAAI,CAAC,OAAON,IAAP,CAAYM,KAAZ,CAAL,EAAyB,OAAOA,KAAP;EACzB,QAAIyC,MAAJ;EACA,QAAIE,QAAQ3C,MAAM2C,KAAN,CAAY,yBAAZ,CAAZ;EACA,QAAIA,KAAJ,EAAW;EACT,UAAIO,kBAAkB,KAAK5E,cAAL,CAAoBqE,MAAM,CAAN,CAApB,CAAtB;EACA,cAAQA,MAAM,CAAN,CAAR;EACE,aAAK,GAAL;EACEF,mBAASS,eAAT;EACA;EACF,aAAK,GAAL;EACET,mBAASU,OAAOD,eAAP,CAAT;EACA;EACA,cAAIT,WAAWA,MAAf,EAAuB,MAAM,IAAIhD,KAAJ,CAAU,+BAA+ByD,eAAzC,CAAN;EACvB;EACF,aAAK,GAAL;EACE,cAAIA,oBAAoB,GAAxB,EAA6BT,SAAS,IAAT,CAA7B,KACK,IAAIS,oBAAoB,GAAxB,EAA6BT,SAAS,KAAT,CAA7B,KACA,MAAM,IAAIhD,KAAJ,CAAU,gCAAgCyD,eAA1C,CAAN;EACL;EACF;EACE,gBAAM,IAAIzD,KAAJ,CAAU,wCAAwCkD,MAAM,CAAN,CAAlD,CAAN;EAfJ;EAiBD,KAnBD,MAmBO;EACLF,eAASzC,MAAM6C,OAAN,CAAc,wBAAd,EAAwC,CAACF,KAAD,EAAQS,QAAR,EAAkBC,eAAlB,KAAsC;EACrF,YAAID,aAAa,GAAjB,EAAsB,MAAM,IAAI3D,KAAJ,CAAU,4CAA4C2D,QAAtD,CAAN;EACtB,eAAO,KAAK9E,cAAL,CAAoB+E,eAApB,CAAP;EACD,OAHQ,CAAT;EAID;EACD,QAAI,KAAKvE,gBAAT,EAA2B,KAAKA,gBAAL,CAAsBkE,GAAtB,CAA0BhD,KAA1B,EAAiCyC,MAAjC;EAC3B,WAAOA,MAAP;EACD;;EAEDhB,UAAQzB,KAAR,EAAe;EACb,QAAIsD,MAAMC,OAAN,CAAcvD,KAAd,CAAJ,EAA0B,OAAO,OAAP;EAC1B,QAAIwB,OAAO,OAAOxB,KAAlB;EACA,QAAIwB,SAAS,QAAb,EAAuB;EACrB,UAAIxB,iBAAiBwD,MAArB,EAA6BhC,OAAO,QAAP,CAA7B,KACK,IAAIxB,iBAAiBmD,MAArB,EAA6B3B,OAAO,QAAP,CAA7B,KACA,IAAIxB,iBAAiByD,OAArB,EAA8BjC,OAAO,SAAP;EACpC;EACD,WAAOA,IAAP;EACD;;EAEDoB,iBAAeP,OAAf,EAAwB;EACtB,QAAIqB,QAAQ,KAAKnF,eAAL,CAAqB8D,OAArB,CAAZ;EACA,QAAI,CAACqB,KAAL,EAAY;EACVA,cAAQ,KAAKnF,eAAL,CAAqB8D,OAArB,IAAgC,IAAIsB,MAAJ,CAAW,MAAMtB,QACtDQ,OADsD,CAC9C,KAD8C,EACvC,GADuC,EAEtDA,OAFsD,CAE9C,qCAF8C,EAEP,MAFO;EAAA,OAGtDA,OAHsD,CAG9C,IAH8C,EAGxC,OAHwC,CAAN,GAGvB,GAHY,CAAxC;EAID;EACD,WAAOa,KAAP;EACD;EA7QyB;;ECEb,MAAME,iBAAN,CAAwB;EACrC7F,cAAY8F,IAAZ,EAAkBC,MAAlB,EAA0B;EACxB,SAAKC,IAAL,GAAYD,OAAOhD,UAAP,CAAkB+C,KAAKrD,GAAvB,CAAZ;EACA,SAAKwD,KAAL,GAAaF,OAAOpD,SAAP,CAAiB,KAAKqD,IAAtB,CAAb;EACA,SAAKE,KAAL,GAAaJ,IAAb;EACA,SAAKK,OAAL,GAAeJ,MAAf;EAED;;EAED,MAAIzE,GAAJ,GAAU;EACR,WAAO,KAAK0E,IAAL,CAAU1E,GAAjB;EACD;;EAED,MAAImB,GAAJ,GAAU;EACR,WAAO,IAAI2D,kBAAJ,CAAuB,KAAKJ,IAAL,CAAUvD,GAAjC,EAAsC,KAAK0D,OAA3C,CAAP;EACD;;EAEDE,QAAM;EACJ,WAAO,KAAKF,OAAL,CAAa/C,cAAb,CAA4B,KAAK6C,KAAjC,EAAwC,KAAKC,KAAL,CAAWG,GAAX,EAAxC,EAA0D,SAA1D,CAAP;EACD;;EAEDxD,QAAMyD,SAAN,EAAiB;EACf,WAAO,IAAIT,iBAAJ,CAAsB,KAAKK,KAAL,CAAWrD,KAAX,CAAiByD,SAAjB,CAAtB,EAAmD,KAAKH,OAAxD,CAAP;EACD;;EAEDI,UAAQC,MAAR,EAAgB;EACd,WAAO,KAAKN,KAAL,CAAWK,OAAX,CAAoBE,SAAD,IAAe;EACvC,aAAOD,OAAO,IAAIX,iBAAJ,CAAsBY,SAAtB,CAAP,EAAyC,KAAKN,OAA9C,CAAP;EACD,KAFM,CAAP;EAGD;;EAEDO,WAAS;EACP,WAAO,KAAKR,KAAL,CAAWQ,MAAX,CAAkBC,KAAlB,CAAwB,KAAKT,KAA7B,EAAoCU,SAApC,CAAP;EACD;;EAEDC,WAASP,SAAT,EAAoB;EAClBA,gBAAY,KAAKH,OAAL,CAAa9D,WAAb,CAAyBiE,UAAUrC,KAAV,CAAgB,GAAhB,CAAzB,EAA+C,KAAKkC,OAAL,CAAahD,WAAb,CAAyB,KAAK8C,KAA9B,CAA/C,EAAqFnD,IAArF,CAA0F,GAA1F,CAAZ;EACA,WAAO,KAAKoD,KAAL,CAAWW,QAAX,CAAoBP,SAApB,CAAP;EACD;;EAEDQ,gBAAc;EACZ,WAAO,KAAKZ,KAAL,CAAWY,WAAX,CAAuBH,KAAvB,CAA6B,KAAKT,KAAlC,EAAyCU,SAAzC,CAAP;EACD;;EAEDG,gBAAc;EACZ,WAAO,KAAKb,KAAL,CAAWa,WAAX,CAAuBJ,KAAvB,CAA6B,KAAKT,KAAlC,EAAyCU,SAAzC,CAAP;EACD;;EAEDI,WAAS;EACP,UAAMC,OAAO,KAAKf,KAAL,CAAWc,MAAX,CAAkBL,KAAlB,CAAwB,KAAKT,KAA7B,EAAoCU,SAApC,CAAb;EACA,WAAO,KAAKT,OAAL,CAAa/C,cAAb,CAA4B,KAAK6C,KAAjC,EAAwCgB,IAAxC,EAA8C,SAA9C,CAAP;EACD;EAnDoC;;ECCxB,MAAMC,cAAN,CAAqB;EAClClH,cAAYmH,KAAZ,EAAmBC,KAAnB,EAA0BC,WAA1B,EAAuCtB,MAAvC,EAA+C;EAC7C,SAAKuB,MAAL,GAAcH,KAAd;EACA,SAAKI,MAAL,GAAcH,SAAS,EAAvB;EACA,SAAKI,YAAL,GAAoBH,eAAeF,KAAnC;EACA,SAAKhB,OAAL,GAAeJ,MAAf;EACD;;EAED0B,qBAAmBC,QAAnB,EAA6B;EAC3B,QAAI,CAACA,QAAD,IAAaA,SAASC,iBAA1B,EAA6C;EAC7C,UAAMC,OAAO,IAAb;EACA,UAAMC,kBAAkB,UAAU/B,IAAV,EAAgBgC,gBAAhB,EAAkC;EACxD,aAAOJ,SAASK,IAAT,CAAc,IAAd,EAAoB,IAAIlC,iBAAJ,CAAsBC,IAAtB,EAA4B8B,KAAKzB,OAAjC,CAApB,EAA+D2B,gBAA/D,EAAiFF,KAAKzB,OAAtF,CAAP;EACD,KAFD;EAGA0B,oBAAgBF,iBAAhB,GAAoCE,eAApC;EACAH,aAASC,iBAAT,GAA6BE,eAA7B;EACD;;EAED,MAAIpF,GAAJ,GAAU;EACR,WAAO,IAAI2D,kBAAJ,CAAuB,KAAKD,OAAL,CAAapD,UAAb,CAAwB,KAAKuE,MAAL,CAAY7E,GAApC,CAAvB,EAAiE,KAAK0D,OAAtE,CAAP;EACD;;EAED6B,KAAGC,SAAH,EAAcP,QAAd,EAAwBQ,cAAxB,EAAwCC,OAAxC,EAAiD;EAC/C,SAAKV,kBAAL,CAAwBC,QAAxB;EACA,WAAO,KAAKF,YAAL,CAAkBQ,EAAlB,CAAqBD,IAArB,CACL,KAAKT,MADA,EACQW,SADR,EACmBP,SAASC,iBAD5B,EAC+CO,cAD/C,EAC+DC,OAD/D,CAAP;EAED;;EAEDC,MAAIH,SAAJ,EAAeP,QAAf,EAAyBS,OAAzB,EAAkC;EAChC,QAAIT,YAAYA,SAASC,iBAAzB,EAA4CD,WAAWA,SAASC,iBAApB;EAC5C,WAAO,KAAKH,YAAL,CAAkBY,GAAlB,CAAsBL,IAAtB,CAA2B,KAAKT,MAAhC,EAAwCW,SAAxC,EAAmDP,QAAnD,EAA6DS,OAA7D,CAAP;EACD;;EAEDE,OAAKJ,SAAL,EAAgBK,eAAhB,EAAiCC,eAAjC,EAAkDJ,OAAlD,EAA2D;EACzD,SAAKV,kBAAL,CAAwBa,eAAxB;EACA,WAAO,KAAKd,YAAL,CAAkBa,IAAlB,CAAuBN,IAAvB,CACL,KAAKT,MADA,EACQW,SADR,EACmBK,mBAAmBA,gBAAgBX,iBADtD,EACyEY,eADzE,EAELJ,OAFK,EAGLK,IAHK,CAGC1C,IAAD,IAAU;EACf,aAAO,IAAID,iBAAJ,CAAsBC,IAAtB,EAA4B,KAAKK,OAAjC,CAAP;EACD,KALM,CAAP;EAMD;;EAEDsC,eAAanH,GAAb,EAAkB;EAChB,WAAO,KAAKoH,QAAL,CAAc,cAAd,EAA8B,OAA9B,EAAuCpH,GAAvC,CAAP;EACD;;EAEDqH,eAAa;EACX,WAAO,KAAKD,QAAL,CAAc,YAAd,EAA4B,KAA5B,CAAP;EACD;;EAEDE,iBAAe;EACb,WAAO,KAAKF,QAAL,CAAc,cAAd,EAA8B,OAA9B,CAAP;EACD;;EAEDG,UAAQ5G,KAAR,EAAeX,GAAf,EAAoB;EAClB,SAAKwH,aAAL,CAAmBxH,QAAQyH,SAA3B;EACA,WAAO,KAAKC,SAAL,CAAe,SAAf,EAA0BpC,SAA1B,CAAP;EACD;;EAEDqC,QAAMhH,KAAN,EAAaX,GAAb,EAAkB;EAChB,SAAKwH,aAAL,CAAmBxH,QAAQyH,SAA3B;EACA,WAAO,KAAKC,SAAL,CAAe,OAAf,EAAwBpC,SAAxB,CAAP;EACD;;EAEDsC,UAAQjH,KAAR,EAAeX,GAAf,EAAoB;EAClB,QAAI,KAAKiG,MAAL,CAAY,KAAKA,MAAL,CAAY4B,EAAZ,GAAiB,WAA7B,CAAJ,EAA+C;EAC7ClH,cAAQ,KAAKkE,OAAL,CAAa5D,OAAb,CAAqBN,KAArB,EAA4B,KAAKkE,OAAL,CAAazC,OAAb,CAAqBzB,KAArB,CAA5B,EAAyD,KAAKsF,MAAL,CAAY,KAAKA,MAAL,CAAY4B,EAAZ,GAAiB,WAA7B,CAAzD,CAAR;EACD;EACD,QAAI7H,QAAQyH,SAAR,IAAqB,KAAKxB,MAAL,CAAY6B,YAArC,EAAmD;EACjD9H,YAAM,KAAK6E,OAAL,CAAa5D,OAAb,CAAqBjB,GAArB,EAA0B,QAA1B,EAAoC,KAAKiG,MAAL,CAAY6B,YAAhD,CAAN;EACD;EACD,WAAO,IAAIlC,cAAJ,CAAmB,KAAKM,YAAL,CAAkB0B,OAAlB,CAA0BnB,IAA1B,CAA+B,KAAKT,MAApC,EAA4CrF,KAA5C,EAAmDX,GAAnD,CAAnB,EAA4E,KAAKiG,MAAjF,EAAyF,KAAKC,YAA9F,EAA4G,KAAKrB,OAAjH,CAAP;EACD;;EAEDkD,iBAAe;EACb,WAAO,KAAKL,SAAL,CAAe,cAAf,EAA+BpC,SAA/B,CAAP;EACD;;EAED0C,gBAAc;EACZ,WAAO,KAAKN,SAAL,CAAe,aAAf,EAA8BpC,SAA9B,CAAP;EACD;;EAEDoC,YAAUO,UAAV,EAAsBC,IAAtB,EAA4B;EAC1B,WAAO,IAAItC,cAAJ,CAAmB,KAAKM,YAAL,CAAkB+B,UAAlB,EAA8B5C,KAA9B,CAAoC,KAAKW,MAAzC,EAAiDkC,IAAjD,CAAnB,EAA2E,KAAKjC,MAAhF,EAAwF,KAAKC,YAA7F,EAA2G,KAAKrB,OAAhH,CAAP;EACD;;EAED2C,gBAAcW,WAAd,EAA2B;EACzB,QAAI,KAAKlC,MAAL,CAAY4B,EAAZ,KAAmB,KAAnB,GACA,KAAK5B,MAAL,CAAY6B,YADZ,GAEA,KAAK7B,MAAL,CAAYmC,cAAZ,IAA8BD,eAAe,KAAKlC,MAAL,CAAY6B,YAF7D,EAE2E;EACzE,YAAM,IAAI1H,KAAJ,CAAU,mCAAV,CAAN;EACD;EACF;;EAEDgH,WAASa,UAAT,EAAqBJ,EAArB,EAAyBQ,QAAzB,EAAmC;EACjC,UAAM1I,MAAM,KAAKkF,OAAL,CAAahD,WAAb,CAAyB,KAAKgD,OAAL,CAAaxD,SAAb,CAAuB,KAAKF,GAA5B,CAAzB,CAAZ;EACA,UAAM2E,QAAQ,EAAC+B,IAAIA,EAAL,EAAd;;EAEA,QAAIS,iBAAJ;EACA,QAAI3I,GAAJ,EAAS;EACP,YAAMqF,YAAYqD,YAAYA,SAAS1F,KAAT,CAAe,GAAf,CAA9B;EACA,WAAK,MAAM4F,MAAX,IAAqB5I,GAArB,EAA0B;EACxB,YAAI,CAACA,IAAI2C,cAAJ,CAAmBiG,MAAnB,CAAL,EAAiC;EACjC,cAAM/F,SAAS7C,IAAI4I,MAAJ,CAAf;EACA,YAAI/F,OAAO,UAAP,CAAJ,EAAwB;EACtB,cAAIA,OAAO,UAAP,EAAmBxC,GAAvB,EAA4B8F,MAAMgC,YAAN,GAAqBtF,OAAO,UAAP,EAAmBxC,GAAxC;EAC5B,cAAIwC,OAAO,UAAP,EAAmB7B,KAAvB,EAA8BmF,MAAMsC,cAAN,GAAuB5F,OAAO,UAAP,EAAmB7B,KAA1C;EAC/B;EACD,YAAI0H,QAAJ,EAAc;EACZ,gBAAMG,WAAW,KAAK3D,OAAL,CAAahD,WAAb,CAAyBmD,SAAzB,EAAoCxC,MAApC,CAAjB;EACA,cAAIgG,YAAYA,SAAS,UAAT,CAAZ,IAAoCA,SAAS,UAAT,EAAqB7H,KAA7D,EAAoE;EAClEmF,kBAAM2C,cAAN,GAAuBD,SAAS,UAAT,EAAqB7H,KAA5C;EACD;EACD,gBAAM+H,6BAA6B,KAAK7D,OAAL,CAAa9D,WAAb,CAAyBiE,SAAzB,EAAoCxC,MAApC,EAA4ChB,IAA5C,CAAiD,GAAjD,CAAnC;EACA,cAAI8G,qBAAqBI,+BAA+BJ,iBAAxD,EAA2E;EACzE,kBAAM,IAAIlI,KAAJ,CACJ,8DAA8DiI,QAA9D,GAAyE,IADrE,CAAN;EAED;EACDC,8BAAoBI,0BAApB;EACD;EACF;EACF;EACD,QAAIL,QAAJ,EAAc;EACZ,aAAO,IAAIzC,cAAJ,CACL,KAAKM,YAAL,CAAkB+B,UAAlB,EAA8BxB,IAA9B,CAAmC,KAAKT,MAAxC,EAAgDsC,qBAAqBD,QAArE,CADK,EAC2EvC,KAD3E,EACkF,KAAKI,YADvF,EACqG,KAAKrB,OAD1G,CAAP;EAED,KAHD,MAGO;EACL,aAAO,IAAIe,cAAJ,CAAmB,KAAKM,YAAL,CAAkB+B,UAAlB,EAA8BxB,IAA9B,CAAmC,KAAKT,MAAxC,CAAnB,EAAoEF,KAApE,EAA2E,KAAKI,YAAhF,EAA8F,KAAKrB,OAAnG,CAAP;EACD;EACF;EAjIiC;;ECHrB,MAAM8D,qBAAN,CAA4B;EACzCjK,cAAYkB,IAAZ,EAAkBgJ,oBAAlB,EAAwCnE,MAAxC,EAAgD;EAC9C,SAAKE,KAAL,GAAa/E,IAAb;EACA,SAAKiF,OAAL,GAAeJ,MAAf;EACA,SAAKoE,qBAAL,GAA6BD,oBAA7B;EACD;;EAEDE,8BAA4Bb,UAA5B,EAAwCc,iBAAxC,EAA2DC,QAA3D,EAAqE;EACnE,UAAM1C,OAAO,IAAb;;EAEA,SAAK2B,UAAL,IAAmB,YAAW;EAC5B,YAAMC,OAAOjE,MAAMgF,SAAN,CAAgB3I,KAAhB,CAAsBmG,IAAtB,CAA2BsC,iBAA3B,CAAb;EACA,UAAIC,YAAY,CAAZ,IAAiBA,WAAWd,KAAK3I,MAArC,EAA6C;EAC3C2I,aAAKc,QAAL,IAAiB1C,KAAKzB,OAAL,CAAa/C,cAAb,CAA4BwE,KAAK3B,KAAjC,EAAwCuD,KAAKc,QAAL,CAAxC,EAAwD,SAAxD,CAAjB;EACD;;EAED,aAAO1C,KAAKuC,qBAAL,CAA2BZ,UAA3B,EAAuC5C,KAAvC,CAA6CiB,KAAKuC,qBAAlD,EAAyEX,IAAzE,CAAP;EACD,KAPD;EAQD;;EAEDvE,QAAM;EACJ,WAAO,KAAKmF,2BAAL,CAAiC,KAAjC,EAAwCxD,SAAxC,EAAmD,CAAnD,CAAP;EACD;;EAED4D,WAAS;EACP,WAAO,KAAKJ,2BAAL,CAAiC,QAAjC,EAA2CxD,SAA3C,EAAsD,CAAtD,CAAP;EACD;;EAED6D,WAAS;EACP,WAAO,KAAKL,2BAAL,CAAiC,QAAjC,EAA2CxD,SAA3C,CAAP;EACD;;EAED8D,WAAS;EACP,WAAO,KAAKN,2BAAL,CAAiC,QAAjC,EAA2CxD,SAA3C,CAAP;EACD;EAlCwC;;ECI3C,IAAI+D,mBAAJ;EACA,IAAI;EACFA,wBAAsBC,QAAQ,uBAAR,CAAtB;EACD,CAFD,CAEE,OAAO7I,CAAP,EAAU;EACV;EACD;;AAED,EAAe,MAAMqE,kBAAN,CAAyB;EACtCpG,cAAYyC,GAAZ,EAAiBsD,MAAjB,EAAyB;EACvB,SAAKC,IAAL,GAAYvD,GAAZ;EACA,SAAK0D,OAAL,GAAeJ,MAAf;EACD;;EAED8E,kBAAgBtB,UAAhB,EAA4Bc,iBAA5B,EAA+C;EAC7C,UAAMS,eAAe,KAAK3E,OAAL,CAAa3D,UAAb,CAAwB,KAAKwD,IAA7B,CAArB;EACA,UAAMmB,QAAQ,IAAID,cAAJ,CAAmB4D,YAAnB,EAAiC,EAAjC,EAAqC,KAAK9E,IAA1C,EAAgD,KAAKG,OAArD,CAAd;EACA,WAAOgB,MAAMoC,UAAN,EAAkB5C,KAAlB,CAAwBQ,KAAxB,EAA+BkD,iBAA/B,CAAP;EACD;;EAEDU,kBAAgBxB,UAAhB,EAA4Bc,iBAA5B,EAA+CC,QAA/C,EAAyD;EACvD,UAAMQ,eAAe,KAAK3E,OAAL,CAAa3D,UAAb,CAAwB,KAAKwD,IAA7B,CAArB;;EAEA,UAAMwD,OAAOjE,MAAMgF,SAAN,CAAgB3I,KAAhB,CAAsBmG,IAAtB,CAA2BsC,iBAA3B,CAAb;EACA,QAAIC,YAAY,CAAZ,IAAiBA,WAAWd,KAAK3I,MAArC,EAA6C;EAC3C,YAAMK,OAAO,KAAKiF,OAAL,CAAaxD,SAAb,CAAuB,KAAKqD,IAA5B,CAAb;EACAwD,WAAKc,QAAL,IAAiB,KAAKnE,OAAL,CAAa/C,cAAb,CAA4BlC,IAA5B,EAAkCsI,KAAKc,QAAL,CAAlC,EAAkD,SAAlD,CAAjB;EACD;;EAED,WAAO,KAAKtE,IAAL,CAAUuD,UAAV,EAAsB5C,KAAtB,CAA4BmE,YAA5B,EAA0CtB,IAA1C,CAAP;EACD;;EAED;;;;;EAKA,aAAWwB,gBAAX,GAA8B;EAC5B,WAAO;EACL,aAAO;EADF,KAAP;EAGD;;EAED;;;;EAIA,MAAI1J,GAAJ,GAAU;EACR,WAAO,KAAK0E,IAAL,CAAU1E,GAAjB;EACD;;EAED;;;;EAIA,MAAIJ,IAAJ,GAAW;EACT,WAAOkD,mBAAmB,KAAK4B,IAAL,CAAU3B,QAAV,EAAnB,EAAyCzC,KAAzC,CAA+C,KAAKoE,IAAL,CAAUpD,IAAV,CAAeyB,QAAf,GAA0BxD,MAA1B,GAAmC,CAAlF,CAAP;EACD;;EAED;;;;;EAKA,MAAI4B,GAAJ,GAAU;EACR,QAAI,KAAKuD,IAAL,CAAUiF,OAAV,CAAkB,KAAKjF,IAAL,CAAUvD,GAA5B,CAAJ,EAAsC;EACpC,aAAO,IAAP;EACD,KAFD,MAEO;EACL,aAAO,IAAI2D,kBAAJ,CAAuB,KAAKJ,IAAL,CAAUvD,GAAjC,EAAsC,KAAK0D,OAA3C,CAAP;EACD;EACF;;EAED;;;;EAIA,MAAIvD,IAAJ,GAAW;EACT,QAAI,KAAKoD,IAAL,CAAUiF,OAAV,CAAkB,KAAKjF,IAAL,CAAUpD,IAA5B,CAAJ,EAAuC;EACrC,aAAO,IAAP;EACD,KAFD,MAEO;EACL,aAAO,IAAIwD,kBAAJ,CAAuB,KAAKJ,IAAL,CAAUpD,IAAjC,EAAuC,KAAKuD,OAA5C,CAAP;EACD;EACF;;EAED;;;;;EAKA,MAAI+E,MAAJ,GAAa;EACX,QAAI,KAAKlF,IAAL,CAAUkF,MAAV,KAAqB,IAAzB,EAA+B;EAC7B,aAAO,IAAP;EACD,KAFD,MAEO;EACL,aAAO,IAAI9E,kBAAJ,CAAuB,KAAKJ,IAAL,CAAUkF,MAAjC,EAAyC,KAAK/E,OAA9C,CAAP;EACD;EACF;;EAED;;;;EAIA,MAAIgF,QAAJ,GAAe;EACb,WAAO,KAAKnF,IAAL,CAAUvD,GAAV,CAAc0I,QAAd,CAAuBnJ,SAA9B;EACD;;EAED;;;;;EAKAa,QAAM3B,IAAN,EAAY;EACV,WAAO,IAAIkF,kBAAJ,CAAuB,KAAKJ,IAAL,CAAUnD,KAAV,CAAgB3B,IAAhB,CAAvB,EAA8C,KAAKiF,OAAnD,CAAP;EACD;;EAED;;;;EAIAa,WAAS;EACP,WAAO,KAAKhB,IAAL,CAAUgB,MAAV,EAAP;EACD;;EAED;;;;EAIAiE,UAAQG,QAAR,EAAkB;EAChB,WAAO,KAAKpF,IAAL,CAAUiF,OAAV,CAAkBG,SAASpF,IAA3B,CAAP;EACD;;EAED;;;;EAIA3B,aAAW;EACT,WAAOD,mBAAmB,KAAK4B,IAAL,CAAU3B,QAAV,EAAnB,CAAP;EACD;;EAEDgH,SAAO;EACL,UAAMC,YAAY,KAAKzI,KAAL,CAAW,KAAKmD,IAAL,CAAUqF,IAAV,GAAiB/J,GAA5B,CAAlB;;EAEA,QAAIiK,OAAJ;EACA,QAAI,OAAO3E,UAAU,CAAV,CAAP,KAAwB,WAA5B,EAAyC;EACvC;EACA2E,gBAAUC,QAAQC,OAAR,EAAV;EACD,KAHD,MAGO;EACLF,gBAAUD,UAAUrG,GAAV,CAAc0B,KAAd,CAAoB2E,SAApB,EAA+B1E,SAA/B,CAAV;EACD;;EAED0E,cAAU9C,IAAV,GAAiB+C,QAAQ/C,IAAR,CAAajF,IAAb,CAAkBgI,OAAlB,CAAjB;EACAD,cAAUI,KAAV,GAAkBH,QAAQG,KAAR,CAAcnI,IAAd,CAAmBgI,OAAnB,CAAlB;EACA,QAAIA,QAAQI,OAAZ,EAAqBL,UAAUK,OAAV,GAAoBJ,QAAQI,OAAR,CAAgBpI,IAAhB,CAAqBgI,OAArB,CAApB;;EAErB,WAAOD,SAAP;EACD;;EAEDrG,QAAM;EACJ,WAAO,KAAK8F,eAAL,CAAqB,KAArB,EAA4BnE,SAA5B,EAAuC,CAAvC,CAAP;EACD;;EAED6D,WAAS;EACP,WAAO,KAAKM,eAAL,CAAqB,QAArB,EAA+BnE,SAA/B,CAAP;EACD;;EAED4D,WAAS;EACP,WAAO,KAAKO,eAAL,CAAqB,QAArB,EAA+BnE,SAA/B,EAA0C,CAA1C,CAAP;EACD;;EAEDgF,iBAAe;EACb,UAAMC,iBAAiB,KAAK7F,IAAL,CAAU4F,YAAV,IAA0BjB,mBAAjD;;EAEA,QAAI,OAAOkB,cAAP,KAA0B,UAA9B,EAA0C;EACxC,YAAM,IAAInK,KAAJ,CACH;0FADG,CAAN;EAID;;EAED,UAAMoJ,eAAe,KAAK3E,OAAL,CAAa3D,UAAb,CAAwB,KAAKwD,IAA7B,CAArB;EACA,WAAO6F,eAAelF,KAAf,CAAqBmE,YAArB,EAAmC,CAACA,YAAD,EAAe,GAAGlE,SAAlB,CAAnC,EAAiE4B,IAAjE,CAAuErH,IAAD,IAAU;EACrF,UAAI,CAACA,KAAK2K,IAAL,CAAWxK,GAAD,IAAS,OAAOK,IAAP,CAAYL,GAAZ,CAAnB,CAAL,EAA2C;EACzC,eAAOH,IAAP;EACD;EACD,aAAOA,KAAK4K,GAAL,CAAS,KAAK5F,OAAL,CAAajD,OAAb,CAAqBK,IAArB,CAA0B,KAAK4C,OAA/B,CAAT,CAAP;EACD,KALM,CAAP;EAMD;;EAED6F,iBAAe;EACb,UAAMlB,eAAe,KAAK3E,OAAL,CAAa3D,UAAb,CAAwB,KAAKwD,IAA7B,CAArB;EACA,WAAO,IAAIiE,qBAAJ,CAA0Ba,YAA1B,EAAwC,KAAK9E,IAAL,CAAUgG,YAAV,CAAuBjE,IAAvB,CAA4B+C,YAA5B,CAAxC,EAAmF,KAAK3E,OAAxF,CAAP;EACD;;EAED6B,OAAK;EACH,WAAO,KAAK6C,eAAL,CAAqB,IAArB,EAA2BjE,SAA3B,CAAP;EACD;;EAEDwB,QAAM;EACJ,WAAO,KAAKyC,eAAL,CAAqB,KAArB,EAA4BjE,SAA5B,CAAP;EACD;;EAEDyB,SAAO;EACL,WAAO,KAAKwC,eAAL,CAAqB,MAArB,EAA6BjE,SAA7B,CAAP;EACD;;EAED6B,iBAAe;EACb,WAAO,KAAKoC,eAAL,CAAqB,cAArB,EAAqCjE,SAArC,CAAP;EACD;;EAED+B,eAAa;EACX,WAAO,KAAKkC,eAAL,CAAqB,YAArB,EAAmCjE,SAAnC,CAAP;EACD;;EAEDgC,iBAAe;EACb,WAAO,KAAKiC,eAAL,CAAqB,cAArB,EAAqCjE,SAArC,CAAP;EACD;;EAEDiC,YAAU;EACR,WAAO,KAAKgC,eAAL,CAAqB,SAArB,EAAgCjE,SAAhC,CAAP;EACD;;EAEDqC,UAAQ;EACN,WAAO,KAAK4B,eAAL,CAAqB,OAArB,EAA8BjE,SAA9B,CAAP;EACD;;EAEDsC,YAAU;EACR,WAAO,KAAK2B,eAAL,CAAqB,SAArB,EAAgCjE,SAAhC,CAAP;EACD;;EAEDyC,iBAAe;EACb,WAAO,KAAKwB,eAAL,CAAqB,cAArB,EAAqCjE,SAArC,CAAP;EACD;;EAED0C,gBAAc;EACZ,WAAO,KAAKuB,eAAL,CAAqB,aAArB,EAAoCjE,SAApC,CAAP;EACD;;EAEDqF,gBAAc;EACZ,UAAMnB,eAAe,KAAK3E,OAAL,CAAa3D,UAAb,CAAwB,KAAKwD,IAA7B,CAArB;EACA,UAAM9E,OAAO,KAAKiF,OAAL,CAAaxD,SAAb,CAAuB,KAAKqD,IAA5B,CAAb;;EAEA,UAAMwD,OAAOjE,MAAMgF,SAAN,CAAgB3I,KAAhB,CAAsBmG,IAAtB,CAA2BnB,SAA3B,CAAb;EACA,UAAMsF,kBAAkB1C,KAAK,CAAL,CAAxB;EACAA,SAAK,CAAL,IAAU0C,oBAAqBjK,KAAD,IAAW;EACvCA,cAAQ,KAAKkE,OAAL,CAAa/C,cAAb,CAA4BlC,IAA5B,EAAkCe,KAAlC,EAAyC,SAAzC,CAAR;EACAA,cAAQiK,gBAAgBjK,KAAhB,CAAR;EACAA,cAAQ,KAAKkE,OAAL,CAAa/C,cAAb,CAA4BlC,IAA5B,EAAkCe,KAAlC,EAAyC,SAAzC,CAAR;EACA,aAAOA,KAAP;EACD,KALS,CAAV;EAMA,QAAIuH,KAAK3I,MAAL,GAAc,CAAlB,EAAqB;EACnB,YAAMsL,qBAAqB3C,KAAK,CAAL,CAA3B;EACAA,WAAK,CAAL,IAAU2C,uBAAuB,CAACC,KAAD,EAAQC,SAAR,EAAmBC,QAAnB,KAAgC;EAC/D,eAAOH,mBAAmBC,KAAnB,EAA0BC,SAA1B,EAAqCC,YAAY,IAAIzG,iBAAJ,CAAsByG,QAAtB,EAAgC,KAAKnG,OAArC,CAAjD,CAAP;EACD,OAFS,CAAV;EAGD;EACD,WAAO,KAAKH,IAAL,CAAUiG,WAAV,CAAsBtF,KAAtB,CAA4BmE,YAA5B,EAA0CtB,IAA1C,EAAgDhB,IAAhD,CAAsD9D,MAAD,IAAY;EACtEA,aAAO4H,QAAP,GAAkB5H,OAAO4H,QAAP,IAAmB,IAAIzG,iBAAJ,CAAsBnB,OAAO4H,QAA7B,EAAuC,KAAKnG,OAA5C,CAArC;EACA,aAAOzB,MAAP;EACD,KAHM,CAAP;EAID;EA1PqC;;ECXxC,MAAM6H,2BAA4BC,EAAD,IAAQ;EACvC;EACA;EACA;EACA;EACA;EACA,QAAMC,wBAAwBD,GAAGE,aAAjC;EACAtL,SAAOuL,cAAP,CAAsBH,EAAtB,EAA0B,eAA1B,EAA2C,EAACvK,OAAO,YAAW;EAC5D,YAAM2K,MAAMH,sBAAsB9F,KAAtB,CAA4B,IAA5B,EAAkCC,SAAlC,CAAZ;EACA,YAAMiG,mBAAmBD,IAAI5M,WAAJ,CAAgBuK,SAAhB,CAA0BY,QAAnD;EACA/J,aAAOuL,cAAP,CAAsBC,IAAI5M,WAAJ,CAAgBuK,SAAtC,EAAiD,UAAjD,EAA6D,EAACtI,OAAO,YAAW;EAC9E;EACA;EACA;EACA,gBAAM6K,KAAKD,iBAAiBlG,KAAjB,CAAuB,IAAvB,EAA6BC,SAA7B,CAAX;EACA,cAAI,CAACkG,GAAG9K,SAAR,EAAmB;EACjBZ,mBAAOuL,cAAP,CAAsBG,EAAtB,EAA0B,WAA1B,EAAuC,EAAC7K,OAAO,IAAI8K,SAAJ,CAAcD,EAAd,CAAR,EAAvC;EACD;EACD,iBAAOA,GAAG9K,SAAV;EACD,SAT4D,EAA7D;EAUAZ,aAAOuL,cAAP,CAAsBH,EAAtB,EAA0B,eAA1B,EAA2C,EAACvK,OAAOwK,qBAAR,EAA3C;EACA,aAAOG,GAAP;EACD,KAf0C,EAexCI,cAAc,IAf0B,EAA3C;EAgBD,CAvBD;;EAyBA,IAAI,OAAOpC,OAAP,KAAmB,WAAvB,EAAoC;EAClC,MAAI,OAAOnK,QAAP,KAAoB,WAAxB,EAAqCwM,OAAOxM,QAAP,GAAkBmK,QAAQ,WAAR,CAAlB;EACrC,MAAI,OAAOsC,QAAP,KAAoB,WAAxB,EAAqCD,OAAOC,QAAP,GAAkBtC,QAAQ,gBAAR,CAAlB;EACrCA,UAAQ,sBAAR;EACAA,UAAQ,mCAAR;EACA,QAAMuC,QAAQvC,QAAQ,gBAAR,CAAd;EACA2B,2BAAyBY,KAAzB;EACD,CAPD,MAOO,IAAI,OAAOC,QAAP,KAAoB,WAAxB,EAAqC;EAC1Cb,2BAAyBa,QAAzB;EACD,CAFM,MAEA;EACL,QAAM,IAAI1L,KAAJ,CAAU,8DAAV,CAAN;EACD;;EAEDwL,SAASG,GAAT,CAAaC,aAAb,GAA6B;EAC3BC,aAAWL,SAASG,GAAT,CAAaG,MAAb,CAAoBD,SADJ;EAE3BE,SAAOP,SAASG,GAAT,CAAaG,MAAb,CAAoBC,KAFA;EAG3BC,QAAM;EAHqB,CAA7B;;EASA,MAAMX,SAAN,CAAgB;EACd/M,cAAY8M,EAAZ,EAAgB;EACd,UAAMa,oBAAoB,OAAOb,EAAP,KAAc,QAAd,IAA0BA,OAAO,IAA3D;EACA,QAAI,CAACa,iBAAD,IAAsB,OAAOb,GAAGF,GAAV,KAAkB,QAAxC,IAAoD,OAAOE,GAAGrK,GAAV,KAAkB,UAA1E,EAAsF;EACpF,YAAM,IAAIf,KAAJ,CACH;mBACUoL,EAAG,IAFV,CAAN;EAID;;EAED,SAAKc,GAAL,GAAWd,EAAX;EACA,SAAK3G,OAAL,GAAe4C,SAAf;EACD;;EAED8E,gCAA8B;EAC5B,QAAI,OAAO,KAAK1H,OAAZ,KAAwB,WAA5B,EAAyC;EACvC,YAAM,IAAIzE,KAAJ,CAAU,sEAAV,CAAN;EACD;EACF;;EAEDoM,eAAaxM,GAAb,EAAkByM,UAAlB,EAA8B;EAC5B,UAAMC,MAAMd,SAASe,GAAT,CAAaC,MAAb,CAAoBhB,SAASG,GAAT,CAAaG,MAAb,CAAoBC,KAApB,CAA0BnM,GAA1B,CAApB,CAAZ;EACA,UAAMa,gBAAiBgM,GAAD,IAAS;EAC7B,aAAOjB,SAASG,GAAT,CAAaC,aAAb,CAA2BC,SAA3B,CAAqCS,IAAIzL,OAAJ,CAAY4L,GAAZ,CAArC,CAAP;EACD,KAFD;EAGA,UAAM/L,gBAAiB+L,GAAD,IAAS;EAC7B,YAAMzJ,SAASsJ,IAAI9K,OAAJ,CAAYgK,SAASG,GAAT,CAAaC,aAAb,CAA2BG,KAA3B,CAAiCU,GAAjC,CAAZ,CAAf;EACA,UAAIzJ,WAAW,KAAf,EAAsB;EACpB,cAAM3C,IAAI,IAAIL,KAAJ,CAAU,sBAAV,CAAV;EACAK,UAAEC,SAAF,GAAc,WAAd;EACA,cAAMD,CAAN;EACD;EACD,aAAOmL,SAASG,GAAT,CAAae,IAAb,CAAkBb,SAAlB,CAA4B7I,MAA5B,CAAP;EACD,KARD;;EAUA,SAAKyB,OAAL,CAAajE,4BAAb,CAA0CC,aAA1C,EAAyDC,aAAzD;;EAEA,QAAI2L,UAAJ,EAAgB3L,cAAc2L,UAAd;EAChB,WAAO5L,cAAc+K,SAASG,GAAT,CAAaC,aAAb,CAA2BC,SAA3B,CAAqCL,SAASmB,GAAT,CAAaC,SAAb,CAAuBC,MAAvB,CAA8B,EAA9B,CAArC,CAAd,CAAP;EACD;;EAED,MAAI3B,GAAJ,GAAU;EACR,WAAO,KAAKgB,GAAL,CAAShB,GAAhB;EACD;;EAED4B,sBAAoBvO,UAAU,EAA9B,EAAkCwO,gBAAgB,EAAlD,EAAsD;EACpD,QAAI,OAAOxO,OAAP,KAAmB,QAAnB,IAA+BA,YAAY,IAA/C,EAAqD;EACnD,YAAM,IAAIyB,KAAJ,CACH,sFAAqFzB,OAAQ,IAD1F,CAAN;EAGD,KAJD,MAIO,IAAI,OAAOwO,aAAP,KAAyB,QAAzB,IAAqCA,kBAAkB,IAA3D,EAAiE;EACtE,YAAM,IAAI/M,KAAJ,CACH,qFAAoF+M,aAAc,IAD/F,CAAN;EAGD;;EAEDxO,YAAQyO,SAAR,GAAoBzO,QAAQyO,SAAR,IAAqB,IAAI,IAAJ,GAAW,IAApD;EACAzO,YAAQW,mBAAR,GAA8BX,QAAQW,mBAAR,IAA+BX,QAAQyO,SAArE;EACAzO,YAAQe,mBAAR,GAA8Bf,QAAQe,mBAAR,IAA+Bf,QAAQyO,SAArE;;EAEA,SAAKvI,OAAL,GAAe,IAAIpG,MAAJ,CAAWE,OAAX,EAAoBwO,aAApB,CAAf;;EAEA,QAAI/J,MAAJ;;EAEA,YAAQzE,QAAQ0O,SAAhB;EACE,WAAK,SAAL;EACE,YAAI,CAAC1O,QAAQqB,GAAb,EAAkB,MAAM,IAAII,KAAJ,CAAU,+CAAV,CAAN;EAClBgD,iBAAS,KAAKoJ,YAAL,CAAkB7N,QAAQqB,GAA1B,EAA+BrB,QAAQ2O,aAAvC,CAAT;EACA;EACF,WAAK,aAAL;EACE,aAAKzI,OAAL,CAAajE,4BAAb,CAA2CiM,GAAD,IAASA,GAAnD,EAAyDA,GAAD,IAASA,GAAjE;EACA;EACF,WAAK,MAAL;EACE;EACF;EACE,cAAM,IAAIzM,KAAJ,CAAU,mCAAmCzB,QAAQ0O,SAA3C,GAAuD,IAAjE,CAAN;EAXJ;;EAcA;EACA;EACA,SAAKE,uBAAL,GAA+BnK,MAA/B;;EAEA,WAAOA,MAAP;EACD;;EAEDoK,aAAW;EACT,SAAKjB,2BAAL;EACA,WAAO,KAAKD,GAAL,CAASkB,QAAT,EAAP;EACD;;EAEDC,cAAY;EACV,SAAKlB,2BAAL;EACA,WAAO,KAAKD,GAAL,CAASmB,SAAT,EAAP;EACD;;EAEDtM,MAAIvB,IAAJ,EAAU;EACR,SAAK2M,2BAAL;;EAEA,QAAI,OAAO3M,IAAP,KAAgB,WAAhB,IAA+B,OAAOA,IAAP,KAAgB,QAAnD,EAA6D;EAC3D,YAAM,IAAIQ,KAAJ,CACH,iFAAgFR,IAAK,IADlF,CAAN;EAGD;;EAED,WAAO,IAAIkF,kBAAJ,CAAuB,KAAKwH,GAAL,CAASnL,GAAT,CAAavB,IAAb,CAAvB,EAA2C,KAAKiF,OAAhD,CAAP;EACD;;EAED6I,aAAWC,GAAX,EAAgB;EACd,SAAKpB,2BAAL;;EAEA,QAAI,OAAOoB,GAAP,KAAe,QAAf,IAA2BA,IAAIrK,KAAJ,CAAU,gBAAV,MAAgC,IAA/D,EAAqE;EACnE,YAAM,IAAIlD,KAAJ,CACH,+EAA8EuN,GAAI,IAD/E,CAAN;EAGD;;EAED,WAAO,IAAI7I,kBAAJ,CAAuB,KAAKwH,GAAL,CAASoB,UAAT,CAAoB9N,IAApB,CAAvB,EAAkD,KAAKiF,OAAvD,CAAP;EACD;EArHa;;;;"}