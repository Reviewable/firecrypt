!function(){"use strict";let r,t,e;function n(t){r=function r(t,e){var n=Object.keys(t);for(var i=0;i<n.length;i++){var o=n[i];if(".encrypt"===o)for(var a=Object.keys(t[o]),c=0;c<a.length;c++){var s=a[c];if("key"!==s&&"value"!==s&&"few"!==s)throw new Error("Illegal .encrypt subkey: "+a[c])}else{if(/[\x00-\x1f\x7f\x91\x92\.#\[\]/]/.test(o)||/[$]/.test(o.slice(1)))throw new Error("Illegal character in specification key: "+o);r(t[o],(e||"")+"/"+o)}switch(o.charAt(0)){case"$":if("$"===o)break;if(t.$)throw new Error("Multiple wildcard keys in specification at "+e);t.$=t[o],delete t[o];break;case".":if(".encrypt"!==o)throw new Error("Unknown directive at "+e+": "+o)}}return t}(t)}function i(){var r=new Error("Encryption not set up");throw r.firecrypt="NO_KEY",r}function o(r,t){return t.length+("string"==typeof r?r.length:4)}function a(t,e){e=e||r.rules,t=t.slice();for(var n=0;n<t.length&&(e=e[t[n]]||e.$);n++)e[".encrypt"]&&e[".encrypt"].key&&(t[n]=l(t[n],"string",e[".encrypt"].key));return t}function c(r,t){var e=a(t||y(r));return e.length?r.root().child(e.join("/")):r.root()}function s(r){for(var t=y(r,!0),e=!1,n=0;n<t.length;n++){var i=h(t[n]);i!==t[n]&&(t[n]=i,e=!0)}return e?r.root().child(t.join("/")):r}function u(t,e){e=e||r.rules;for(var n=0;e&&n<t.length;n++)e=e[t[n]]||e.$;return e}function p(r,t,e){return function r(t,e,n){if(!e)return t;var i=d(t);var o;if(/^(string|number|boolean)$/.test(i))e[".encrypt"]&&e[".encrypt"].value&&(t=n(t,i,e[".encrypt"].value));else if("object"===i&&null!==t){var a={};for(var c in t)if(t.hasOwnProperty(c)){var s,u=t[c];if(c.indexOf("/")>=0){var p=c.split("/");for(s=e,o=0;o<p.length;o++)n===h?(p[o]=h(p[o]),s=s&&(s[p[o]]||s.$)):(s=s&&(s[p[o]]||s.$))&&s[".encrypt"]&&s[".encrypt"].key&&(p[o]=n(p[o],"string",s[".encrypt"].key));c=p.join("/")}else n===h?(c=h(c),s=e[c]||e.$):(s=e[c]||e.$)&&s[".encrypt"]&&s[".encrypt"].key&&(c=n(c,"string",s[".encrypt"].key));a[c]=r(u,s,n)}t=a}else if("array"===i){if(!e.$)return t;for(o=0;o<t.length;o++)t[o]=r(t[o],e.$,n)}return t}(t,u(r),e)}function y(r,t){var e=r.root();if(r===e)return[];var n=decodeURIComponent(r.toString().slice(e.toString().length));if(!t&&n&&"."!==n.charAt(0)&&/[\x00-\x1f\x7f\x91\x92\.#$\[\]]/.test(n))throw new Error("Path contains invalid characters: "+n);return n.split("/")}function l(r,e,n){var i,o;if(t&&(i=e.charAt(0)+n+""+r,t.has(i)))return t.get(i);if("#"===n)o=f(r,e);else{if("string"!==e)throw new Error("Can't encrypt a "+e+" using pattern ["+n+"]");var a=r.match(function(r){var t=v[r];t||(t=v[r]=new RegExp("^"+r.replace(/\./g,"#").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&").replace(/#/g,"(.*?)")+"$"));return t}(n));if(!a)throw new Error("Can't encrypt as value doesn't match pattern ["+n+"]: "+r);var c=0;o=n.replace(/[#\.]/g,function(r){var t=a[++c];return"#"===r&&(t=f(t,"string")),t})}return t&&t.set(i,o),o}function f(r,t){if(!/^(string|number|boolean)$/.test(t))throw new Error("Can't encrypt a "+t);switch(t){case"number":r=""+r;break;case"boolean":r=r?"t":"f"}return""+t.charAt(0).toUpperCase()+encryptString(r)+""}function h(r){if(e&&e.has(r))return e.get(r);if(!/\x91/.test(r))return r;var t,n=r.match(/^\x91(.)([^\x92]*)\x92$/);if(n){var i=decryptString(n[2]);switch(n[1]){case"S":t=i;break;case"N":if((t=Number(i))!=t)throw new Error("Invalid encrypted number: "+i);break;case"B":if("t"===i)t=!0;else{if("f"!==i)throw new Error("Invalid encrypted boolean: "+i);t=!1}break;default:throw new Error("Invalid encrypted value type code: "+n[1])}}else t=r.replace(/\x91(.)([^\x92]*)\x92/g,function(r,t,e){if("S"!==t)throw new Error("Invalid multi-segment encrypted value: "+t);return decryptString(e)});return e&&e.set(r,t),t}function d(r){if(Array.isArray(r))return"array";var t=typeof r;return"object"===t&&(r instanceof String?t="string":r instanceof Number?t="number":r instanceof Boolean&&(t="boolean")),t}var v={};if("undefined"!=typeof require){if(void 0===g)var g=require("firebase");if(void 0===_)var _=require("lru-cache");if(void 0===w)var w=require("crypto-js/core");require("crypto-js/enc-base64"),require("cryptojs-extension/build_node/siv");try{require("firebase-childrenkeys")}catch(r){}}w.enc.Base64UrlSafe={stringify:w.enc.Base64.stringify,parse:w.enc.Base64.parse,_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"};var k,b,m=g.prototype,E={},C=!1;function S(r,t,e){this._query=r,this._order=t||{},this._original=e||r}function B(r){this._ref=s(r.ref()),this._path=y(this._ref),this._snap=r}function x(r,t){this._path=r,this._originalOnDisconnect=t}function q(r,t){var e=m[r];m[r]=function(){var r=y(this),n=c(this,r),i=Array.prototype.slice.call(arguments);return t>=0&&t<i.length&&(i[t]=p(r,i[t],l)),e.apply(n,i)}}function $(r,t){x.prototype[r]=function(){var e=Array.prototype.slice.call(arguments);return t>=0&&t<e.length&&(e[t]=p(this._path,e[t],l)),console.log("ARGS:",e),this._originalOnDisconnect[r].apply(this._originalOnDisconnect,e)}}function A(r){if(r&&!r.firecryptCallback){var t=function(t,e){return r.call(this,new B(t),e)};t.firecryptCallback=t,r.firecryptCallback=t}}function j(r){B.prototype[r]=function(){return this._snap[r].apply(this._snap,arguments)}}g.initializeEncryption=function(r,a){var u,f;switch(r.cacheSize=r.cacheSize||5e6,r.encryptionCacheSize=r.encryptionCacheSize||r.cacheSize,r.decryptionCacheSize=r.decryptionCacheSize||r.cacheSize,k=b=i,"function"==typeof _&&(f=new _({max:r.encryptionCacheSize,length:o}),t=f,function(r){e=r}(new _({max:r.decryptionCacheSize,length:o}))),r.algorithm){case"aes-siv":if(!r.key)throw new Error("You must specify a key to use AES encryption.");u=function(r,t){var e=w.SIV.create(w.enc.Base64.parse(r));k=function(r){return w.enc.Base64UrlSafe.stringify(e.encrypt(r))},b=function(r){var t=e.decrypt(w.enc.Base64UrlSafe.parse(r));if(!1===t){var n=new Error("Wrong decryption key");throw n.firecrypt="WRONG_KEY",n}return w.enc.Utf8.stringify(t)},t&&b(t);return k(w.enc.Base64UrlSafe.stringify(w.lib.WordArray.random(10)))}(r.key,r.keyCheckValue);break;case"passthrough":k=b=function(r){return r};break;case"none":break;default:throw new Error('Unknown encryption algorithm "'+r.algorithm+'".')}return n(a),function(){if(C)return;q("set",0),q("update",0),r=m.push,m.push=function(){var t=r.apply(this,arguments),e=s(t);return e.then=t.then,e.catch=t.catch,t.finally&&(e.finally=t.finally),e},q("setWithPriority",0),q("setPriority"),m.childrenKeys&&function(){var r=m.childrenKeys;m.childrenKeys=function(){return r.apply(c(this),arguments).then(function(r){return r.some(function(r){return/\x91/.test(r)})?r.map(h):r})}}();var r;(function(){var r=m.transaction;m.transaction=function(){var t=y(this),e=c(this,t),n=Array.prototype.slice.call(arguments),i=n[0];if(n[0]=i&&function(r){return r=p(t,r,h),r=i(r),r=p(t,r,l)},n.length>1){var o=n[1];n[1]=o&&function(r,t,e){return o(r,t,e&&new B(e))}}return r.apply(e,n).then(function(r){return r.snapshot=r.snapshot&&new B(r.snapshot),r})}})(),function(){var r=m.onDisconnect;m.onDisconnect=function(){var t=y(this);return new x(t,r.call(c(this,t)))}}(),["on","off","once","orderByChild","orderByKey","orderByValue","orderByPriority","startAt","endAt","equalTo","limitToFirst","limitToLast","limit","ref"].forEach(function(r){!function(r){E[r]=m[r],m[r]=function(){var t=new S(c(this),{},E);return t[r].apply(t,arguments)}}(r)}),C=!0}(),u},S.prototype.on=function(r,t,e,n){return A(t),this._original.on.call(this._query,r,t.firecryptCallback,e,n)},S.prototype.off=function(r,t,e){return t&&t.firecryptCallback&&(t=t.firecryptCallback),this._original.off.call(this._query,r,t,e)},S.prototype.once=function(r,t,e,n){return A(t),this._original.once.call(this._query,r,t&&t.firecryptCallback,e,n).then(function(r){return new B(r)})},S.prototype.orderByChild=function(r){return this._orderBy("orderByChild","child",r)},S.prototype.orderByKey=function(){return this._orderBy("orderByKey","key")},S.prototype.orderByValue=function(){return this._orderBy("orderByValue","value")},S.prototype.orderByPriority=function(){return this._orderBy("orderByPriority","priority")},S.prototype.startAt=function(r,t){return this._checkCanSort(void 0!==t),this._delegate("startAt",arguments)},S.prototype.endAt=function(r,t){return this._checkCanSort(void 0!==t),this._delegate("endAt",arguments)},S.prototype.equalTo=function(r,t){return this._order[this._order.by+"Encrypted"]&&(r=l(r,d(r),this._order[this._order.by+"Encrypted"])),void 0!==t&&this._order.keyEncrypted&&(t=l(t,"string",this._order.keyEncrypted)),new S(this._original.equalTo.call(this._query,r,t),this._order)},S.prototype.limitToFirst=function(){return this._delegate("limitToFirst",arguments)},S.prototype.limitToLast=function(){return this._delegate("limitToLast",arguments)},S.prototype.limit=function(){return this._delegate("limit",arguments)},S.prototype.ref=function(){return s(this._original.ref.call(this._query))},S.prototype._delegate=function(r,t){return new S(this._original[r].apply(this._query,t),this._order)},S.prototype._checkCanSort=function(r){if("key"===this._order.by?this._order.keyEncrypted:this._order.valueEncrypted||r&&this._order.keyEncrypted)throw new Error("Encrypted items cannot be ordered")},S.prototype._orderBy=function(r,t,e){var n,i=u(y(this.ref())),o={by:t};if(i){var c=e&&e.split("/");for(var s in i)if(i.hasOwnProperty(s)){var p=i[s];if(p[".encrypt"]&&(p[".encrypt"].key&&(o.keyEncrypted=p[".encrypt"].key),p[".encrypt"].value&&(o.valueEncrypted=p[".encrypt"].value)),e){var l=u(c,p);l&&l[".encrypt"]&&l[".encrypt"].value&&(o.childEncrypted=l[".encrypt"].value);var f=a(c,p).join("/");if(n&&f!==n)throw new Error('Incompatible encryption specifications for orderByChild("'+e+'")');n=f}}}return new S(e?this._original[r].call(this._query,n||e):this._original[r].call(this._query),o)},j("exists"),j("hasChildren"),j("numChildren"),j("getPriority"),B.prototype.val=function(){return p(this._path,this._snap.val(),h)},B.prototype.child=function(r){return new B(this._snap.child(r))},B.prototype.forEach=function(r){return this._snap.forEach(function(t){return r(new B(t))})},B.prototype.hasChild=function(r){return r=a(r.split("/"),u(this._path)).join("/"),this._snap.hasChild(r)},B.prototype.key=function(){return this._ref.key()},B.prototype.name=function(){return this._ref.name()},B.prototype.ref=function(){return this._ref},B.prototype.exportVal=function(){return p(this._path,this._snap.exportVal(),h)},$("set",0),$("update",0),$("remove"),$("setWithPriority",0),$("cancel")}();
